<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Volvo Parts">
<meta name="theme-color" content="0d0d0d">
<title>Volvo C3 Parts</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=IBM+Plex+Mono:wght@400;500;600&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0d0d0d;
  --surface: #161616;
  --surface2: #1e1e1e;
  --surface3: #252525;
  --border: #2a2a2a;
  --border2: #333;
  --accent: #e8b84b;
  --accent2: #c97b2e;
  --text: #ebebeb;
  --text2: #aaa;
  --muted: #666;
  --red: #e05252;
  --green: #52c77a;
  --blue: #5299e0;
  --orange: #e87b3a;
  --radius: 8px;
  --header-h: 56px;
  --nav-h: 60px;
}
* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
html, body { height: 100%; overflow: hidden; }
body {
  font-family: 'IBM Plex Sans', sans-serif;
  background: var(--bg);
  color: var(--text);
  font-size: 14px;
  overscroll-behavior: none;
}

/* â”€â”€ HEADER â”€â”€ */
.app-header {
  position: fixed; top: 0; left: 0; right: 0;
  height: var(--header-h);
  background: var(--surface);
  border-bottom: 2px solid var(--accent);
  display: flex; align-items: center;
  padding: 0 16px; gap: 12px;
  z-index: 200;
}
.logo { font-family: 'Bebas Neue', sans-serif; font-size: 24px; color: var(--accent); letter-spacing: 3px; }
.logo span { font-size: 13px; color: var(--muted); font-family: 'IBM Plex Mono', monospace; letter-spacing: 1px; display: block; margin-top: -4px; }
.header-stats { margin-left: auto; text-align: right; font-family: 'IBM Plex Mono', monospace; font-size: 10px; color: var(--muted); line-height: 1.6; }
.header-stats b { color: var(--accent); }

/* â”€â”€ BOTTOM NAV â”€â”€ */
.bottom-nav {
  position: fixed; bottom: 0; left: 0; right: 0;
  height: var(--nav-h);
  background: var(--surface);
  border-top: 1px solid var(--border);
  display: flex;
  z-index: 200;
  padding-bottom: env(safe-area-inset-bottom);
}
.nav-btn {
  flex: 1; display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  gap: 4px; cursor: pointer;
  font-family: 'IBM Plex Mono', monospace;
  font-size: 9px; color: var(--muted);
  letter-spacing: 0.5px; text-transform: uppercase;
  transition: color 0.2s; border: none; background: none;
  padding: 8px 4px;
}
.nav-btn .nav-icon { font-size: 20px; transition: transform 0.2s; }
.nav-btn.active { color: var(--accent); }
.nav-btn.active .nav-icon { transform: translateY(-2px); }
.nav-btn:hover { color: var(--text2); }

/* â”€â”€ MAIN SCROLL AREA â”€â”€ */
.main {
  position: fixed;
  top: var(--header-h);
  bottom: var(--nav-h);
  left: 0; right: 0;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}
.screen { display: none; min-height: 100%; padding: 14px 14px 20px; max-width: 680px; margin: 0 auto; }
.screen.active { display: block; }

/* â”€â”€ CARDS â”€â”€ */
.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 14px;
  margin-bottom: 12px;
}
.card-title {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 15px; color: var(--accent);
  letter-spacing: 1.5px; margin-bottom: 12px;
  display: flex; align-items: center; gap: 8px;
}
.card-title .ct-icon { font-size: 16px; }

/* â”€â”€ FORMS â”€â”€ */
.fg { margin-bottom: 11px; }
.fg label {
  display: block;
  font-family: 'IBM Plex Mono', monospace;
  font-size: 10px; color: var(--muted);
  margin-bottom: 4px; letter-spacing: 0.5px;
  text-transform: uppercase;
}
.fg label .req { color: var(--accent); }
input, select, textarea {
  width: 100%;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text);
  padding: 10px 12px;
  font-family: 'IBM Plex Sans', sans-serif;
  font-size: 14px;
  transition: border-color 0.2s;
  outline: none;
  -webkit-appearance: none;
}
input:focus, select:focus, textarea:focus { border-color: var(--accent); }
select option { background: var(--surface2); }
textarea { resize: vertical; min-height: 70px; }
.row2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.row3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }

/* â”€â”€ BUTTONS â”€â”€ */
.btn {
  display: inline-flex; align-items: center; justify-content: center; gap: 6px;
  padding: 10px 18px; border-radius: var(--radius);
  font-family: 'IBM Plex Mono', monospace;
  font-size: 12px; font-weight: 600;
  cursor: pointer; border: none;
  transition: all 0.2s; letter-spacing: 0.5px;
  white-space: nowrap;
}
.btn-primary { background: var(--accent); color: #000; }
.btn-primary:hover { background: var(--accent2); }
.btn-primary:disabled { background: var(--border2); color: var(--muted); cursor: not-allowed; }
.btn-secondary { background: var(--surface2); color: var(--text); border: 1px solid var(--border2); }
.btn-secondary:hover { border-color: var(--accent); color: var(--accent); }
.btn-danger { background: transparent; color: var(--red); border: 1px solid var(--red); }
.btn-danger:hover { background: var(--red); color: #fff; }
.btn-success { background: var(--green); color: #000; }
.btn-full { width: 100%; }
.btn-sm { padding: 6px 12px; font-size: 11px; }
.btn-xs { padding: 4px 8px; font-size: 10px; }
.btn-group { display: flex; gap: 8px; flex-wrap: wrap; }

/* â”€â”€ BADGES â”€â”€ */
.badge {
  display: inline-flex; align-items: center; gap: 3px;
  padding: 2px 7px; border-radius: 20px;
  font-family: 'IBM Plex Mono', monospace;
  font-size: 10px; font-weight: 600; letter-spacing: 0.3px;
}
.badge-green { background: rgba(82,199,122,0.15); color: var(--green); border: 1px solid rgba(82,199,122,0.3); }
.badge-yellow { background: rgba(232,184,75,0.15); color: var(--accent); border: 1px solid rgba(232,184,75,0.3); }
.badge-red { background: rgba(224,82,82,0.15); color: var(--red); border: 1px solid rgba(224,82,82,0.3); }
.badge-blue { background: rgba(82,153,224,0.15); color: var(--blue); border: 1px solid rgba(82,153,224,0.3); }
.badge-orange { background: rgba(232,123,58,0.15); color: var(--orange); border: 1px solid rgba(232,123,58,0.3); }
.badge-muted { background: var(--surface2); color: var(--muted); border: 1px solid var(--border); }

/* â”€â”€ PHOTO AREA â”€â”€ */
.photo-area {
  border: 2px dashed var(--border2);
  border-radius: var(--radius);
  padding: 32px 16px;
  text-align: center; cursor: pointer;
  transition: all 0.2s; background: var(--surface2);
  position: relative; overflow: hidden;
}
.photo-area:hover { border-color: var(--accent); }
.photo-area.has-photo { padding: 0; border-style: solid; border-color: var(--accent); }
.photo-area img { width: 100%; max-height: 280px; object-fit: cover; border-radius: 6px; display: block; }
.photo-placeholder { display: flex; flex-direction: column; align-items: center; gap: 8px; color: var(--muted); }
.photo-icon { font-size: 48px; }
.photo-label { font-family: 'IBM Plex Mono', monospace; font-size: 11px; letter-spacing: 0.5px; }
.photo-sublabel { font-size: 11px; color: var(--muted); opacity: 0.7; }
#cameraInput, #galleryInput, #customPhotoInput { display: none; }

/* â”€â”€ STEP INDICATOR â”€â”€ */
.steps { display: flex; align-items: center; gap: 0; margin-bottom: 16px; }
.step {
  flex: 1; text-align: center;
  font-family: 'IBM Plex Mono', monospace;
  font-size: 10px; color: var(--muted);
  letter-spacing: 0.5px;
  padding: 8px 4px;
  border-bottom: 2px solid var(--border);
  transition: all 0.2s;
}
.step.active { color: var(--accent); border-bottom-color: var(--accent); }
.step.done { color: var(--green); border-bottom-color: var(--green); }
.step-num {
  display: block;
  font-size: 16px; font-weight: 600;
  margin-bottom: 2px;
}

/* â”€â”€ GUESS CARDS â”€â”€ */
.guess-card {
  background: var(--surface2);
  border: 1px solid var(--border2);
  border-radius: var(--radius);
  padding: 12px; margin-bottom: 8px;
  cursor: pointer; transition: all 0.2s;
  display: flex; gap: 12px; align-items: flex-start;
}
.guess-card:hover { border-color: var(--accent); background: var(--surface3); }
.guess-card.selected { border-color: var(--accent); background: rgba(232,184,75,0.08); }
.guess-thumb { width: 64px; height: 64px; border-radius: 6px; object-fit: cover; background: var(--surface3); flex-shrink: 0; border: 1px solid var(--border); }
.guess-thumb-placeholder { width: 64px; height: 64px; border-radius: 6px; background: var(--surface3); flex-shrink: 0; border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 24px; color: var(--muted); }
.guess-info { flex: 1; min-width: 0; }
.guess-rank { font-family: 'IBM Plex Mono', monospace; font-size: 9px; color: var(--accent); letter-spacing: 1px; margin-bottom: 3px; }
.guess-name { font-size: 14px; font-weight: 600; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.guess-no { font-family: 'IBM Plex Mono', monospace; font-size: 11px; color: var(--accent); margin-bottom: 4px; }
.guess-desc { font-size: 12px; color: var(--text2); line-height: 1.4; }
.guess-price { font-family: 'IBM Plex Mono', monospace; font-size: 11px; color: var(--green); margin-top: 4px; }
.guess-meta { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 5px; }
.conf-bar-wrap { display: flex; align-items: center; gap: 8px; margin-top: 5px; }
.conf-bar { flex: 1; height: 3px; background: var(--border); border-radius: 2px; overflow: hidden; }
.conf-fill { height: 100%; border-radius: 2px; transition: width 0.6s ease; }

/* â”€â”€ INVENTORY LIST â”€â”€ */
.inv-item {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 12px; margin-bottom: 8px;
  transition: border-color 0.2s;
}
.inv-item:hover { border-color: var(--border2); }
.inv-item-header { display: flex; align-items: flex-start; gap: 10px; }
.inv-thumb { width: 52px; height: 52px; border-radius: 6px; object-fit: cover; background: var(--surface2); flex-shrink: 0; border: 1px solid var(--border); }
.inv-thumb-ph { width: 52px; height: 52px; border-radius: 6px; background: var(--surface2); flex-shrink: 0; border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 20px; color: var(--muted); }
.inv-info { flex: 1; min-width: 0; }
.inv-name { font-size: 14px; font-weight: 600; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.inv-no { font-family: 'IBM Plex Mono', monospace; font-size: 11px; color: var(--accent); }
.inv-meta { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 5px; }
.inv-actions { display: flex; gap: 6px; margin-top: 10px; flex-wrap: wrap; }
.inv-price-row { display: flex; align-items: center; gap: 8px; margin-top: 6px; font-family: 'IBM Plex Mono', monospace; font-size: 11px; }
.inv-asking { color: var(--green); font-weight: 600; }
.inv-ref { color: var(--muted); }

/* â”€â”€ SEARCH BAR â”€â”€ */
.search-wrap { position: relative; margin-bottom: 12px; }
.search-wrap input { padding-left: 36px; }
.search-icon { position: absolute; left: 11px; top: 50%; transform: translateY(-50%); color: var(--muted); font-size: 16px; pointer-events: none; }

/* â”€â”€ FILTER CHIPS â”€â”€ */
.filter-chips { display: flex; gap: 6px; overflow-x: auto; padding-bottom: 4px; margin-bottom: 12px; scrollbar-width: none; }
.filter-chips::-webkit-scrollbar { display: none; }
.chip {
  flex-shrink: 0; padding: 5px 12px;
  border-radius: 20px; cursor: pointer;
  font-family: 'IBM Plex Mono', monospace;
  font-size: 10px; letter-spacing: 0.3px;
  border: 1px solid var(--border2);
  background: var(--surface2); color: var(--muted);
  transition: all 0.2s; white-space: nowrap;
}
.chip.active { background: rgba(232,184,75,0.15); color: var(--accent); border-color: rgba(232,184,75,0.4); }
.chip:hover { border-color: var(--accent); color: var(--text2); }

/* â”€â”€ TATANKA PANEL â”€â”€ */
.tatanka-panel {
  background: var(--surface2);
  border: 1px solid var(--border2);
  border-radius: var(--radius);
  padding: 12px; margin-top: 10px;
}
.tatanka-header { font-family: 'IBM Plex Mono', monospace; font-size: 10px; color: var(--muted); letter-spacing: 1px; margin-bottom: 8px; display: flex; align-items: center; gap: 6px; }
.tatanka-row {
  display: flex; align-items: center; gap: 10px;
  padding: 8px 0; border-bottom: 1px solid var(--border);
}
.tatanka-row:last-child { border-bottom: none; }
.tatanka-img { width: 48px; height: 48px; border-radius: 5px; object-fit: cover; background: var(--surface3); border: 1px solid var(--border); flex-shrink: 0; }
.tatanka-img-ph { width: 48px; height: 48px; border-radius: 5px; background: var(--surface3); border: 1px solid var(--border); flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 18px; color: var(--muted); }
.tatanka-info { flex: 1; min-width: 0; }
.tatanka-name { font-size: 12px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.tatanka-price { font-family: 'IBM Plex Mono', monospace; font-size: 12px; color: var(--green); }
.tatanka-sek { font-size: 10px; color: var(--muted); }
.tatanka-link { font-family: 'IBM Plex Mono', monospace; font-size: 10px; color: var(--blue); text-decoration: none; flex-shrink: 0; }
.tatanka-link:hover { text-decoration: underline; }

/* â”€â”€ MODAL â”€â”€ */
.modal-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.85);
  z-index: 500; display: none;
  align-items: flex-end; justify-content: center;
  padding: 0;
}
.modal-overlay.open { display: flex; }
.modal {
  background: var(--surface);
  border: 1px solid var(--border2);
  border-radius: 16px 16px 0 0;
  width: 100%; max-width: 680px;
  max-height: 92vh;
  overflow-y: auto;
  padding: 20px 16px;
  padding-bottom: calc(20px + env(safe-area-inset-bottom));
  animation: slideUp 0.3s ease;
}
@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
.modal-handle { width: 36px; height: 4px; background: var(--border2); border-radius: 2px; margin: 0 auto 16px; }
.modal-title { font-family: 'Bebas Neue', sans-serif; font-size: 20px; color: var(--accent); letter-spacing: 2px; margin-bottom: 16px; }
.modal-close { float: right; background: none; border: none; color: var(--muted); font-size: 20px; cursor: pointer; padding: 0 4px; }
.modal-close:hover { color: var(--text); }

/* â”€â”€ TOAST â”€â”€ */
.toast {
  position: fixed; bottom: calc(var(--nav-h) + 12px); left: 50%;
  transform: translateX(-50%) translateY(20px);
  background: var(--surface3); color: var(--text);
  border: 1px solid var(--border2);
  padding: 10px 20px; border-radius: 24px;
  font-family: 'IBM Plex Mono', monospace;
  font-size: 12px; z-index: 999;
  opacity: 0; transition: all 0.3s;
  white-space: nowrap; pointer-events: none;
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
.toast.success { border-color: var(--green); color: var(--green); }
.toast.error { border-color: var(--red); color: var(--red); }

/* â”€â”€ DIVIDER â”€â”€ */
.divider { height: 1px; background: var(--border); margin: 14px 0; }

/* â”€â”€ STATS GRID â”€â”€ */
.stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 12px; }
.stat-box { background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius); padding: 12px; text-align: center; }
.stat-val { font-family: 'Bebas Neue', sans-serif; font-size: 28px; color: var(--accent); letter-spacing: 1px; line-height: 1; }
.stat-label { font-family: 'IBM Plex Mono', monospace; font-size: 9px; color: var(--muted); letter-spacing: 0.5px; margin-top: 3px; }

/* â”€â”€ EMPTY STATE â”€â”€ */
.empty { text-align: center; padding: 48px 20px; color: var(--muted); }
.empty-icon { font-size: 52px; margin-bottom: 12px; }
.empty-title { font-family: 'Bebas Neue', sans-serif; font-size: 22px; color: var(--text2); letter-spacing: 2px; margin-bottom: 6px; }
.empty-text { font-size: 13px; line-height: 1.6; }

/* â”€â”€ LOADING â”€â”€ */
.spinner { display: inline-block; width: 20px; height: 20px; border: 2px solid var(--border2); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.7s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
.loading-state { display: flex; flex-direction: column; align-items: center; gap: 12px; padding: 32px; color: var(--muted); font-family: 'IBM Plex Mono', monospace; font-size: 12px; }

/* â”€â”€ UNKNOWN PILE â”€â”€ */
.unknown-item { background: var(--surface); border: 1px solid var(--orange); border-radius: var(--radius); padding: 12px; margin-bottom: 8px; }
.unknown-header { display: flex; align-items: center; gap: 10px; }
.unknown-thumb { width: 52px; height: 52px; border-radius: 6px; object-fit: cover; background: var(--surface2); flex-shrink: 0; border: 1px solid var(--orange); }

/* â”€â”€ BOX SUMMARY â”€â”€ */
.box-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 12px; margin-bottom: 8px; cursor: pointer; transition: border-color 0.2s; }
.box-card:hover { border-color: var(--accent); }
.box-title { font-family: 'Bebas Neue', sans-serif; font-size: 18px; color: var(--accent); letter-spacing: 2px; margin-bottom: 6px; }
.box-parts { font-size: 12px; color: var(--text2); line-height: 1.7; }

/* â”€â”€ QR LABEL PREVIEW â”€â”€ */
.label-preview {
  background: #fff; color: #000;
  border-radius: 6px; padding: 10px;
  font-family: monospace; font-size: 11px;
  max-width: 240px; margin: 0 auto;
  border: 2px solid var(--border2);
}
.label-preview .lp-name { font-size: 13px; font-weight: bold; margin-bottom: 3px; }
.label-preview .lp-no { font-size: 12px; color: #333; margin-bottom: 3px; }
.label-preview .lp-detail { font-size: 10px; color: #555; margin-bottom: 6px; }
.label-preview .lp-qr { text-align: center; margin-top: 6px; }

/* â”€â”€ CONDITION SELECTOR â”€â”€ */
.condition-btns { display: flex; gap: 6px; }
.cond-btn {
  flex: 1; padding: 8px 4px; border-radius: var(--radius);
  border: 1px solid var(--border2); background: var(--surface2);
  color: var(--muted); cursor: pointer;
  font-family: 'IBM Plex Mono', monospace; font-size: 10px;
  text-align: center; transition: all 0.2s;
}
.cond-btn:hover { border-color: var(--text2); color: var(--text2); }
.cond-btn.active-good { border-color: var(--green); background: rgba(82,199,122,0.1); color: var(--green); }
.cond-btn.active-fair { border-color: var(--accent); background: rgba(232,184,75,0.1); color: var(--accent); }
.cond-btn.active-poor { border-color: var(--red); background: rgba(224,82,82,0.1); color: var(--red); }

/* â”€â”€ STATUS SELECTOR â”€â”€ */
.status-row { display: flex; gap: 6px; }
.status-btn {
  flex: 1; padding: 8px 4px; border-radius: var(--radius);
  border: 1px solid var(--border2); background: var(--surface2);
  color: var(--muted); cursor: pointer;
  font-family: 'IBM Plex Mono', monospace; font-size: 10px;
  text-align: center; transition: all 0.2s;
}
.status-btn.active { border-color: var(--accent); background: rgba(232,184,75,0.1); color: var(--accent); }

/* â”€â”€ SCROLLBAR â”€â”€ */
::-webkit-scrollbar { width: 4px; height: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 2px; }

/* â”€â”€ PRICE DISPLAY â”€â”€ */
.price-main { font-family: 'IBM Plex Mono', monospace; font-size: 16px; color: var(--green); font-weight: 600; }
.price-ref { font-family: 'IBM Plex Mono', monospace; font-size: 11px; color: var(--muted); }

/* â”€â”€ SECTION HEADER â”€â”€ */
.section-header { font-family: 'IBM Plex Mono', monospace; font-size: 10px; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 8px; margin-top: 4px; padding-bottom: 6px; border-bottom: 1px solid var(--border); }

/* â”€â”€ CATALOGUE ITEM â”€â”€ */
.cat-item { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 10px 12px; margin-bottom: 6px; display: flex; align-items: center; gap: 10px; cursor: pointer; transition: border-color 0.2s; }
.cat-item:hover { border-color: var(--accent); }
.cat-item-info { flex: 1; min-width: 0; }
.cat-item-name { font-size: 13px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.cat-item-no { font-family: 'IBM Plex Mono', monospace; font-size: 10px; color: var(--accent); }
.cat-item-price { font-family: 'IBM Plex Mono', monospace; font-size: 11px; color: var(--green); white-space: nowrap; }

/* â”€â”€ SETTINGS â”€â”€ */
.settings-row { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border); }
.settings-row:last-child { border-bottom: none; }
.settings-label { font-size: 13px; font-weight: 600; }
.settings-sublabel { font-size: 11px; color: var(--muted); margin-top: 2px; }
.settings-control { flex-shrink: 0; margin-left: 12px; }
.settings-control input { width: 100px; }

/* â”€â”€ GROUP FILTER â”€â”€ */
.group-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; margin-bottom: 14px; }
.group-btn { padding: 10px 8px; border-radius: var(--radius); border: 1px solid var(--border2); background: var(--surface2); color: var(--muted); cursor: pointer; font-family: 'IBM Plex Mono', monospace; font-size: 10px; text-align: left; transition: all 0.2s; line-height: 1.4; }
.group-btn:hover { border-color: var(--accent); color: var(--text2); }
.group-btn.active { border-color: var(--accent); background: rgba(232,184,75,0.1); color: var(--accent); }
.group-btn .grp-num { font-size: 14px; font-weight: 600; display: block; color: var(--accent); }

/* â”€â”€ PHOTO COMPARE â”€â”€ */
.photo-compare { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
.photo-compare-item { text-align: center; }
.photo-compare-item img { width: 100%; height: 120px; object-fit: cover; border-radius: var(--radius); border: 1px solid var(--border); }
.photo-compare-label { font-family: 'IBM Plex Mono', monospace; font-size: 9px; color: var(--muted); margin-top: 4px; letter-spacing: 0.5px; }

/* â”€â”€ SOLD ARCHIVE â”€â”€ */
.sold-item { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 10px 12px; margin-bottom: 6px; opacity: 0.7; }
.sold-badge { text-decoration: line-through; }

/* â”€â”€ RESPONSIVE: SMALL PHONES (iPhone SE, mini â€” 375px and below) â”€â”€ */
@media (max-width: 375px) {
  :root {
    --header-h: 50px;
    --nav-h: 56px;
  }
  .logo { font-size: 20px; letter-spacing: 2px; }
  .logo span { font-size: 11px; }
  .header-stats { font-size: 9px; }
  .row2 { grid-template-columns: 1fr; }
  .row3 { grid-template-columns: 1fr 1fr; }
  .stats-grid { grid-template-columns: repeat(2, 1fr); }
  .nav-btn { font-size: 8px; }
  .nav-btn .nav-icon { font-size: 18px; }
  .screen { padding: 10px 10px 16px; }
  .card { padding: 12px; }
  .btn { padding: 9px 14px; font-size: 11px; }
  .guess-card { padding: 10px; }
  .guess-thumb, .guess-thumb-placeholder { width: 52px; height: 52px; }
  .modal { padding: 16px 12px; padding-bottom: calc(16px + env(safe-area-inset-bottom)); }
}

/* â”€â”€ RESPONSIVE: NORMAL PHONES (iPhone 12-16, 376-430px) â”€â”€ */
@media (min-width: 376px) and (max-width: 430px) {
  .row3 { grid-template-columns: 1fr 1fr; }
  .stats-grid { grid-template-columns: repeat(3, 1fr); }
}

/* â”€â”€ RESPONSIVE: LARGE PHONES / iPads (431px+) â”€â”€ */
@media (min-width: 431px) {
  .screen { padding: 16px 16px 24px; }
  .card { padding: 16px; }
  .photo-area { padding: 40px 20px; }
  .guess-thumb, .guess-thumb-placeholder { width: 72px; height: 72px; }
  .inv-thumb, .inv-thumb-ph { width: 60px; height: 60px; }
}

/* â”€â”€ IPHONE SAFE AREAS (notch + home bar) â”€â”€ */
@supports (padding-top: env(safe-area-inset-top)) {
  .app-header {
    padding-top: max(10px, env(safe-area-inset-top));
    height: calc(var(--header-h) + env(safe-area-inset-top));
  }
  .main {
    top: calc(var(--header-h) + env(safe-area-inset-top));
  }
  .bottom-nav {
    height: calc(var(--nav-h) + env(safe-area-inset-bottom));
    padding-bottom: env(safe-area-inset-bottom);
  }
  .main {
    bottom: calc(var(--nav-h) + env(safe-area-inset-bottom));
  }
  .toast {
    bottom: calc(var(--nav-h) + env(safe-area-inset-bottom) + 12px);
  }
}

/* â”€â”€ PREVENT DOUBLE-TAP ZOOM ON BUTTONS â”€â”€ */
button, .btn, .chip, .cond-btn, .status-btn, .nav-btn, .guess-card, .cat-item, .inv-item {
  touch-action: manipulation;
}

/* â”€â”€ PREVENT TEXT SELECTION ON UI ELEMENTS â”€â”€ */
.nav-btn, .chip, .btn, .card-title, .badge, .logo {
  -webkit-user-select: none;
  user-select: none;
}

/* â”€â”€ SMOOTH SCROLLING INSIDE MODAL â”€â”€ */
.modal {
  -webkit-overflow-scrolling: touch;
  overscroll-behavior: contain;
}

/* â”€â”€ FIX INPUT ZOOM ON IOS (font-size must be >= 16px to prevent zoom) â”€â”€ */
@media (max-width: 768px) {
  input, select, textarea {
    font-size: 16px !important;
  }
}
</style>
</head>
<body>

<!-- HEADER -->
<header class="app-header">
  <div>
    <div class="logo">VOLVO C3 <span>PARTS INVENTORY</span></div>
  </div>
  <div class="header-stats" id="headerStats">
    <b id="hPartCount">0</b> PARTS<br>
    <b id="hBoxCount">0</b> BOXES
  </div>
</header>

<!-- MAIN CONTENT -->
<main class="main">

  <!-- â•â•â• SCREEN: IDENTIFY â•â•â• -->
  <div class="screen active" id="screen-identify">
    <div class="steps">
      <div class="step active" id="step1"><span class="step-num">1</span>PHOTO</div>
      <div class="step" id="step2"><span class="step-num">2</span>IDENTIFY</div>
      <div class="step" id="step3"><span class="step-num">3</span>CONFIRM</div>
      <div class="step" id="step4"><span class="step-num">4</span>SAVE</div>
    </div>

    <!-- Step 1: Photo -->
    <div id="identStep1">
      <div class="card">
        <div class="card-title"><span class="ct-icon">ğŸ“·</span> PHOTOGRAPH PART</div>
        <div class="photo-area" id="photoArea" onclick="document.getElementById('cameraInput').click()">
          <div class="photo-placeholder">
            <div class="photo-icon">ğŸ“·</div>
            <div class="photo-label">TAP TO TAKE PHOTO</div>
            <div class="photo-sublabel">or choose from gallery</div>
          </div>
        </div>
        <input type="file" id="cameraInput" accept="image/*" capture="environment">
        <div style="margin-top:8px; display:flex; gap:8px;">
          <button class="btn btn-secondary btn-sm" style="flex:1" onclick="document.getElementById('galleryInput').click()">ğŸ“ Gallery</button>
          <button class="btn btn-secondary btn-sm" id="addAngleBtn" style="display:none" onclick="document.getElementById('angleInput').click()">ğŸ“· +Angle</button>
        </div>
        <input type="file" id="galleryInput" accept="image/*" style="display:none">
        <input type="file" id="angleInput" accept="image/*" style="display:none">
        <div id="angleStrip" style="display:none; margin-top:8px; gap:6px; flex-wrap:wrap;"></div>
      </div>

      <div class="card">
        <div class="card-title"><span class="ct-icon">ğŸ”§</span> OPTIONAL: FILTER BY SYSTEM</div>
        <div class="fg">
          <label>System (narrows AI search)</label>
          <select id="groupFilter">
            <option value="">All systems â€” let AI decide</option>
            <option value="20,21,22,23,25,26,27">Engine & Fuel</option>
            <option value="31,32,33,34,35,36,37,38,39">Electrical</option>
            <option value="41,43,45">Clutch, Gearbox & Driveshaft</option>
            <option value="46,48">Axles & Power Takeoff</option>
            <option value="51,52,55,58">Brakes</option>
            <option value="61,64">Steering</option>
            <option value="71,72,73,77">Frame, Suspension & Wheels</option>
            <option value="81,83,84,85,86,87,88">Cab, Body & Interior</option>
          </select>
        </div>
        <div style="display:flex;gap:8px;">
          <button class="btn btn-primary" style="flex:2" id="analyzeBtn" disabled onclick="analyzePhoto()">
            <span class="spinner" style="display:none" id="analyzeSpinner"></span>
            <span id="analyzeBtnText">ğŸ” ANALYZE PHOTO</span>
          </button>
          <button class="btn btn-secondary" style="flex:1" onclick="showScreen('bulk')">âš¡ BULK</button>
        </div>
      </div>
    </div>

    <!-- Step 2: Results -->
    <div id="identStep2" style="display:none">
      <div class="card">
        <div class="card-title"><span class="ct-icon">ğŸ¤–</span> AI IDENTIFICATION</div>
        <div id="guessResults"></div>
        <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn btn-secondary btn-sm" onclick="retryAnalysis()">ğŸ”„ Try Again</button>
          <button class="btn btn-secondary btn-sm" onclick="addAsUnknown()">â“ Unknown</button>
          <button class="btn btn-danger btn-sm" onclick="resetIdentify()">âœ• New Photo</button>
        </div>
        <div id="sonnetBannerStep2" style="display:none;margin-top:8px"></div>
      </div>
    </div>

    <!-- Step 3: Confirm part details -->
    <div id="identStep3" style="display:none">
      <div class="card">
        <div class="card-title"><span class="ct-icon">âœ…</span> CONFIRM PART</div>
        <div id="confirmedPartSummary"></div>
        <div id="tatankaPanelConfirm"></div>
      </div>
      <div class="card">
        <div class="card-title"><span class="ct-icon">ğŸ“</span> PART DETAILS</div>
        <div class="row2">
          <div class="fg">
            <label>Box Number <span class="req">*</span></label>
            <input type="text" id="confirmBox" placeholder="e.g. 4">
          </div>
          <div class="fg">
            <label>Quantity <span class="req">*</span></label>
            <input type="number" id="confirmQty" value="1" min="1">
          </div>
        </div>
        <div class="fg">
          <label>Condition</label>
          <div class="condition-btns">
            <button class="cond-btn" onclick="setCondition('good',this)">âœ… Good</button>
            <button class="cond-btn" onclick="setCondition('fair',this)">âš ï¸ Fair</button>
            <button class="cond-btn" onclick="setCondition('poor',this)">âŒ Poor</button>
          </div>
        </div>
        <div class="fg">
          <label>Asking Price (EUR) <span class="req">*</span></label>
          <input type="number" id="confirmPrice" placeholder="0.00" step="0.01">
        </div>
        <div class="fg">
          <label>Notes</label>
          <textarea id="confirmNotes" placeholder="Optional notes..."></textarea>
        </div>
        <div style="display:flex; gap:8px; margin-top:4px;">
          <button class="btn btn-secondary" onclick="backToGuesses()">â† Back</button>
          <button class="btn btn-primary" style="flex:1" onclick="savePart()">ğŸ’¾ SAVE TO INVENTORY</button>
        </div>
      </div>
    </div>

    <!-- Step 4: Saved confirmation -->
    <div id="identStep4" style="display:none">
      <div class="card" style="text-align:center; padding:32px 16px;">
        <div style="font-size:56px; margin-bottom:12px;">âœ…</div>
        <div class="card-title" style="justify-content:center; font-size:22px;">PART SAVED!</div>
        <div id="savedPartSummary" style="color:var(--text2); font-size:13px; margin-bottom:20px;"></div>
        <div id="duplicateWarning" style="display:none; background:rgba(232,184,75,0.1); border:1px solid var(--accent); border-radius:var(--radius); padding:12px; margin-bottom:16px; font-size:13px;"></div>
        <div class="btn-group" style="justify-content:center;">
          <button class="btn btn-primary" onclick="resetIdentify()">ğŸ“· ADD ANOTHER</button>
          <button class="btn btn-secondary" onclick="showScreen('inventory')">ğŸ“¦ VIEW INVENTORY</button>
        </div>
      </div>
    </div>
  </div>


  <!-- â•â•â• SCREEN: BULK â•â•â• -->
  <div class="screen" id="screen-bulk">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;">
      <button class="btn btn-secondary btn-sm" onclick="showScreen('identify')">â† Back</button>
      <div style="font-family:'Bebas Neue',sans-serif;font-size:18px;color:var(--accent);letter-spacing:2px">BULK MODE</div>
      <div id="bulkCount" style="font-family:'IBM Plex Mono',monospace;font-size:11px;color:var(--muted);margin-left:auto">0 queued</div>
    </div>

    <!-- Capture area -->
    <div class="card" id="bulkCaptureCard">
      <div class="card-title"><span class="ct-icon">ğŸ“·</span> PHOTOGRAPH PARTS</div>
      <div class="photo-area" id="bulkPhotoArea" onclick="document.getElementById('bulkCameraInput').click()">
        <div class="photo-placeholder">
          <div class="photo-icon">ğŸ“·</div>
          <div class="photo-label">TAP TO PHOTOGRAPH PART</div>
          <div class="photo-sublabel">Each photo is queued for analysis</div>
        </div>
      </div>
      <input type="file" id="bulkCameraInput" accept="image/*" capture="environment">
      <div style="margin-top:8px;display:flex;gap:8px;">
        <button class="btn btn-secondary btn-sm" style="flex:1" onclick="document.getElementById('bulkGalleryInput').click()">ğŸ“ Gallery</button>
        <input type="file" id="bulkGalleryInput" accept="image/*" multiple>
        <button class="btn btn-primary btn-sm" style="flex:1" id="bulkAnalyzeBtn" disabled onclick="analyzeBulkQueue()">ğŸ” ANALYZE ALL</button>
      </div>
    </div>

    <!-- Queue -->
    <div id="bulkQueue"></div>

    <!-- Review panel (shown when results ready) -->
    <div id="bulkReview" style="display:none">
      <div class="card">
        <div class="card-title"><span class="ct-icon">âœ…</span> REVIEW & SAVE</div>
        <div id="bulkReviewList"></div>
        <button class="btn btn-primary btn-full" style="margin-top:10px" onclick="saveAllBulk()">ğŸ’¾ SAVE ALL TO INVENTORY</button>
      </div>
    </div>
  </div>

  <!-- â•â•â• SCREEN: INVENTORY â•â•â• -->
  <div class="screen" id="screen-inventory">
    <div class="search-wrap">
      <span class="search-icon">ğŸ”</span>
      <input type="text" placeholder="Search parts, numbers, boxes..." id="invSearch" oninput="filterInventory()">
    </div>
    <div class="filter-chips" id="invFilterChips">
      <div class="chip active" onclick="setInvFilter('all',this)">All</div>
      <div class="chip" onclick="setInvFilter('available',this)">Available</div>
      <div class="chip" onclick="setInvFilter('listed',this)">Listed</div>
      <div class="chip" onclick="setInvFilter('unknown',this)">â“ Unknown</div>
      <div class="chip" onclick="setInvFilter('sold',this)">Sold Archive</div>
    </div>
    <div id="invList"></div>
  </div>

  <!-- â•â•â• SCREEN: CATALOGUE â•â•â• -->
  <div class="screen" id="screen-catalogue">
    <div class="search-wrap">
      <span class="search-icon">ğŸ”</span>
      <input type="text" placeholder="Search C3 parts catalogue..." id="catSearch" oninput="filterCatalogue()">
    </div>
    <div class="filter-chips" id="catFilterChips">
      <div class="chip active" onclick="setCatFilter('',this)">All</div>
      <div class="chip" onclick="setCatFilter('21',this)">Engine</div>
      <div class="chip" onclick="setCatFilter('22',this)">Oil</div>
      <div class="chip" onclick="setCatFilter('23',this)">Fuel</div>
      <div class="chip" onclick="setCatFilter('34',this)">Ignition</div>
      <div class="chip" onclick="setCatFilter('41',this)">Clutch</div>
      <div class="chip" onclick="setCatFilter('43',this)">Gearbox</div>
      <div class="chip" onclick="setCatFilter('51',this)">Brakes</div>
      <div class="chip" onclick="setCatFilter('72',this)">Suspension</div>
      <div class="chip" onclick="setCatFilter('81',this)">Body</div>
      <div class="chip" onclick="setCatFilter('87',this)">Heating</div>
    </div>
    <div id="catList"></div>
  </div>

  <!-- â•â•â• SCREEN: SUMMARY â•â•â• -->
  <div class="screen" id="screen-summary">
    <div class="card">
      <div class="card-title"><span class="ct-icon">ğŸ“Š</span> INVENTORY SUMMARY</div>
      <div class="stats-grid" id="summaryStats"></div>
      <div id="summaryValues"></div>
    </div>
    <div class="card">
      <div class="card-title"><span class="ct-icon">ğŸ“¦</span> BOX SUMMARY</div>
      <div id="boxSummary"></div>
    </div>
    <div class="card">
      <div class="card-title"><span class="ct-icon">ğŸ“„</span> EXPORT SALES CATALOGUE</div>
      <div style="margin-bottom:10px; font-size:13px; color:var(--text2);">Generate a catalogue to share with buyers.</div>
      <div class="row2">
        <button class="btn btn-secondary" onclick="exportCatalogue('bulk')">ğŸ“‹ BULK MODE<br><span style="font-size:9px;font-weight:400">One buyer, all parts</span></button>
        <button class="btn btn-secondary" onclick="exportCatalogue('individual')">ğŸ“‘ INDIVIDUAL<br><span style="font-size:9px;font-weight:400">Part by part listing</span></button>
      </div>
    </div>
    <div class="card">
      <div class="card-title"><span class="ct-icon">ğŸ·ï¸</span> QR LABELS</div>
      <div style="margin-bottom:10px; font-size:13px; color:var(--text2);">Print labels for boxes or individual parts.</div>
      <div class="row2">
        <button class="btn btn-secondary" onclick="showQRModal('box')">ğŸ“¦ BY BOX</button>
        <button class="btn btn-secondary" onclick="showQRModal('part')">ğŸ”§ BY PART</button>
      </div>
    </div>
  </div>

  <!-- â•â•â• SCREEN: SETTINGS â•â•â• -->
  <div class="screen" id="screen-settings">
    <div class="card">
      <div class="card-title"><span class="ct-icon">ğŸ’¶</span> PRICING SETTINGS</div>
      <div class="settings-row">
        <div>
          <div class="settings-label">Exchange Rate</div>
          <div class="settings-sublabel">1 SEK = X EUR</div>
        </div>
        <div class="settings-control">
          <input type="number" id="settingRate" value="0.087" step="0.001" min="0.001" onchange="saveSetting('rate',this.value)">
        </div>
      </div>
      <div class="settings-row">
        <div>
          <div class="settings-label">Default Discount â€” In Stock</div>
          <div class="settings-sublabel">% of Tatanka price when in stock</div>
        </div>
        <div class="settings-control">
          <input type="number" id="settingDiscountIn" value="70" min="1" max="100" onchange="saveSetting('discountIn',this.value)">
        </div>
      </div>
      <div class="settings-row">
        <div>
          <div class="settings-label">Default Discount â€” Out of Stock</div>
          <div class="settings-sublabel">% of Tatanka price when out of stock</div>
        </div>
        <div class="settings-control">
          <input type="number" id="settingDiscountOut" value="80" min="1" max="100" onchange="saveSetting('discountOut',this.value)">
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-title"><span class="ct-icon">ğŸ—ƒï¸</span> DATA</div>
      <div class="settings-row">
        <div>
          <div class="settings-label">Catalogue Parts</div>
          <div class="settings-sublabel">Loaded from PARTS_DB.js</div>
        </div>
        <div class="settings-control">
          <span id="settingPartCount" style="font-family:'IBM Plex Mono',monospace;font-size:12px;color:var(--accent)">â€”</span>
        </div>
      </div>
      <div class="settings-row">
        <div>
          <div class="settings-label">Tatanka Products</div>
          <div class="settings-sublabel">Loaded from tatanka_db.json</div>
        </div>
        <div class="settings-control">
          <span id="settingTatankaCount" style="font-family:'IBM Plex Mono',monospace;font-size:12px;color:var(--accent)">â€”</span>
        </div>
      </div>
      <div class="settings-row">
        <div>
          <div class="settings-label">My Inventory</div>
          <div class="settings-sublabel">Saved locally</div>
        </div>
        <div class="settings-control">
          <span id="settingInvCount" style="font-family:'IBM Plex Mono',monospace;font-size:12px;color:var(--accent)">â€”</span>
        </div>
      </div>
      <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
        <button class="btn btn-secondary btn-sm" onclick="exportInventoryJSON()">ğŸ’¾ Backup Inventory</button>
        <button class="btn btn-secondary btn-sm" onclick="document.getElementById('importInput').click()">ğŸ“‚ Restore Backup</button>
        <input type="file" id="importInput" accept=".json" style="display:none" onchange="importInventoryJSON(this)">
      </div>
    </div>
    <div class="card">
      <div class="card-title"><span class="ct-icon">ğŸ”‘</span> API KEY</div>
      <div class="settings-row">
        <div>
          <div class="settings-label">Anthropic API Key</div>
          <div class="settings-sublabel" id="apiKeyStatus">Not set</div>
        </div>
        <div class="settings-control" style="display:flex;gap:6px">
          <button class="btn btn-secondary btn-sm" onclick="promptApiKey('none')">Change</button>
          <button class="btn btn-danger btn-sm" onclick="clearApiKey()">Clear</button>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-title"><span class="ct-icon">â„¹ï¸</span> ABOUT</div>
      <div style="font-size:12px; color:var(--text2); line-height:1.8;">
        Volvo C3 Parts Inventory v1.0<br>
        Built for C303 / C304 / C306<br>
        TGB 11 / TGB 13 / TGB 20<br>
        <br>
        <span style="color:var(--muted)">Tatanka data scraped: <span id="tatankaScrapeDate">â€”</span></span>
      </div>
    </div>
  </div>

</main>

<!-- BOTTOM NAV -->
<nav class="bottom-nav">
  <button class="nav-btn active" id="nav-identify" onclick="showScreen('identify')">
    <span class="nav-icon">ğŸ“·</span>IDENTIFY
  </button>
  <button class="nav-btn" id="nav-inventory" onclick="showScreen('inventory')">
    <span class="nav-icon">ğŸ“¦</span>INVENTORY
  </button>
  <button class="nav-btn" id="nav-catalogue" onclick="showScreen('catalogue')">
    <span class="nav-icon">ğŸ“‹</span>CATALOGUE
  </button>
  <button class="nav-btn" id="nav-summary" onclick="showScreen('summary')">
    <span class="nav-icon">ğŸ“Š</span>SUMMARY
  </button>
  <button class="nav-btn" id="nav-settings" onclick="showScreen('settings')">
    <span class="nav-icon">âš™ï¸</span>SETTINGS
  </button>
</nav>

<!-- MODALS -->
<div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
  <div class="modal" id="modalContent">
    <div class="modal-handle"></div>
    <div id="modalBody"></div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIGURATION & STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const ANTHROPIC_API = "https://api.anthropic.com/v1/messages";
const API_KEY_STORAGE = "volvo_api_key";

let PARTS_DB = [];       // loaded from PARTS_DB.js
let TATANKA_DB = {};     // loaded from tatanka_db.json, keyed by base_no
let INVENTORY = [];      // user's parts
let SETTINGS = {
  rate: 0.087,
  discountIn: 70,
  discountOut: 80
};

// Identify flow state
let currentPhoto = null;      // base64 image
let currentPhotoBlob = null;  // compressed blob for saving
let currentGuesses = [];
let selectedGuess = null;
let currentCondition = null;
let identifyAttempt = 0;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function init() {
  loadSettings();
  loadInventory();
  await loadTatankaDB();
  updateHeaderStats();
  renderInventory();
  renderCatalogue();
  renderSummary();
  updateSettingsUI();
  updateApiKeyStatus();
}

function updateApiKeyStatus() {
  const el = document.getElementById('apiKeyStatus');
  if (!el) return;
  const key = localStorage.getItem(API_KEY_STORAGE);
  if (key) {
    el.textContent = 'Set (' + key.substring(0,12) + '...)';
    el.style.color = 'var(--green)';
  } else {
    el.textContent = 'Not set â€” tap Change to add';
    el.style.color = 'var(--red)';
  }
}

async function loadTatankaDB() {
  try {
    const r = await fetch('tatanka_db.json');
    if (!r.ok) throw new Error('not found');
    const data = await r.json();
    TATANKA_DB = {};
    (data.products || []).forEach(p => {
      const key = p.base_no || p.sku;
      if (!TATANKA_DB[key]) TATANKA_DB[key] = [];
      TATANKA_DB[key].push(p);
    });
    document.getElementById('settingTatankaCount').textContent = (data.products||[]).length;
    document.getElementById('tatankaScrapeDate').textContent = data.scraped_date || 'â€”';
  } catch(e) {
    console.log('tatanka_db.json not loaded:', e.message);
  }
}

function loadSettings() {
  const s = localStorage.getItem('volvo_settings');
  if (s) {
    try { SETTINGS = {...SETTINGS, ...JSON.parse(s)}; } catch(e) {}
  }
}

function saveSetting(key, val) {
  SETTINGS[key] = parseFloat(val) || val;
  localStorage.setItem('volvo_settings', JSON.stringify(SETTINGS));
  updateSettingsUI();
  renderInventory();
  renderSummary();
}

function updateSettingsUI() {
  document.getElementById('settingRate').value = SETTINGS.rate;
  document.getElementById('settingDiscountIn').value = SETTINGS.discountIn;
  document.getElementById('settingDiscountOut').value = SETTINGS.discountOut;
}

function loadInventory() {
  const d = localStorage.getItem('volvo_inventory');
  if (d) { try { INVENTORY = JSON.parse(d); } catch(e) { INVENTORY = []; } }
}

function saveInventory() {
  localStorage.setItem('volvo_inventory', JSON.stringify(INVENTORY));
  updateHeaderStats();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function showScreen(name) {
  // Hide all screens
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));

  // Show target screen
  const screenEl = document.getElementById('screen-' + name);
  if (!screenEl) { console.error('No screen:', name); return; }
  screenEl.classList.add('active');

  // Update nav â€” bulk has no nav button, highlight identify instead
  const navMap = { bulk: 'identify' };
  const navName = navMap[name] || name;
  const navEl = document.getElementById('nav-' + navName);
  if (navEl) navEl.classList.add('active');

  document.querySelector('.main').scrollTop = 0;
  if (name === 'inventory') renderInventory();
  if (name === 'summary') renderSummary();
  if (name === 'catalogue') renderCatalogue();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS: PRICING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function sekToEur(sek) {
  if (!sek) return null;
  return Math.round(sek * SETTINGS.rate * 100) / 100;
}

function formatEur(eur) {
  if (eur === null || eur === undefined) return 'â€”';
  return eur.toFixed(2) + ' EUR';
}

function formatSek(sek) {
  if (!sek) return '';
  return '(' + sek.toLocaleString() + ' SEK)';
}

function formatPrice(eur, sek) {
  if (!eur) return '<span style="color:var(--muted)">Price on request</span>';
  return '<span class="price-main">' + formatEur(eur) + '</span> <span class="price-ref">' + formatSek(sek) + '</span>';
}

function getTatankaData(partNo) {
  if (!partNo) return [];
  const base = partNo.replace(/-\d$/, '').replace(/-/, '');
  const base2 = partNo.split('-')[0];
  return TATANKA_DB[base] || TATANKA_DB[base2] || TATANKA_DB[partNo] || [];
}

function getSuggestedPrice(tatankaItems) {
  if (!tatankaItems || tatankaItems.length === 0) return null;
  // Prefer in-stock items for price reference
  const inStock = tatankaItems.filter(t => t.stock === 'in_stock' || t.stock === 'few_left');
  const ref = inStock.length > 0 ? inStock[0] : tatankaItems[0];
  if (!ref.price_sek) return null;
  const isOutOfStock = ref.stock === 'temp_finished' || ref.stock === 'out_of_stock';
  const discount = isOutOfStock ? SETTINGS.discountOut : SETTINGS.discountIn;
  const eur = sekToEur(ref.price_sek);
  if (!eur) return null;
  return Math.round(eur * (discount / 100) * 100) / 100;
}

function getStockBadge(stock) {
  const map = {
    'in_stock': '<span class="badge badge-green">âœ… In Stock</span>',
    'few_left': '<span class="badge badge-yellow">âš ï¸ Few Left</span>',
    'temp_finished': '<span class="badge badge-orange">â³ Temp Out</span>',
    'out_of_stock': '<span class="badge badge-red">âŒ Out of Stock</span>',
  };
  return map[stock] || '<span class="badge badge-muted">? Unknown</span>';
}

function getConditionBadge(cond) {
  if (!cond) return '';
  const map = {
    good: '<span class="badge badge-green">âœ… Good</span>',
    fair: '<span class="badge badge-yellow">âš ï¸ Fair</span>',
    poor: '<span class="badge badge-red">âŒ Poor</span>',
  };
  return map[cond] || '';
}

function getStatusBadge(status) {
  const map = {
    available: '<span class="badge badge-green">â— Available</span>',
    listed: '<span class="badge badge-blue">â— Listed</span>',
    sold: '<span class="badge badge-muted">âœ“ Sold</span>',
  };
  return map[status] || '<span class="badge badge-green">â— Available</span>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HEADER STATS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function updateHeaderStats() {
  const active = INVENTORY.filter(i => i.status !== 'sold' && !i.isUnknown);
  const boxes = new Set(active.map(i => i.box)).size;
  document.getElementById('hPartCount').textContent = active.length;
  document.getElementById('hBoxCount').textContent = boxes;
  document.getElementById('settingInvCount').textContent = INVENTORY.length;
  if (typeof PARTS_DB !== 'undefined') {
    document.getElementById('settingPartCount').textContent = PARTS_DB.length;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PHOTO HANDLING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

document.getElementById('cameraInput').addEventListener('change', handlePhoto);
document.getElementById('galleryInput').addEventListener('change', handlePhoto);
document.getElementById('angleInput').addEventListener('change', handleAnglePhoto);

// Extra angles storage
let extraAngles = []; // array of base64 strings

async function handleAnglePhoto(e) {
  const file = e.target.files[0];
  if (!file) return;
  if (extraAngles.length >= 2) {
    showToast('Max 3 photos total', 'error');
    return;
  }
  const compressed = await compressImage(file, 1000, 0.8);
  extraAngles.push(compressed.b64);
  renderAngleStrip();
  e.target.value = '';
  showToast('Angle ' + (extraAngles.length + 1) + ' added âœ“', 'success');
}

function renderAngleStrip() {
  const strip = document.getElementById('angleStrip');
  if (extraAngles.length === 0) {
    strip.style.display = 'none';
    return;
  }
  strip.style.display = 'flex';
  strip.innerHTML = extraAngles.map((b64, i) =>
    `<div style="position:relative">
      <img src="data:image/jpeg;base64,${b64}" style="width:64px;height:64px;border-radius:6px;object-fit:cover;border:1px solid var(--accent)">
      <button onclick="removeAngle(${i})" style="position:absolute;top:-6px;right:-6px;background:var(--red);color:#fff;border:none;border-radius:50%;width:18px;height:18px;font-size:11px;cursor:pointer;padding:0;line-height:18px">âœ•</button>
    </div>`
  ).join('');
}

function removeAngle(i) {
  extraAngles.splice(i, 1);
  renderAngleStrip();
}

async function handlePhoto(e) {
  const file = e.target.files[0];
  if (!file) return;

  try {
    const compressed = await compressImage(file, 1200, 0.85);
    currentPhoto = compressed.b64;
    currentPhotoBlob = compressed.blob;

    const photoArea = document.getElementById('photoArea');
    // Remove onclick before setting innerHTML so we don't lose the handler
    photoArea.removeAttribute('onclick');
    photoArea.classList.add('has-photo');
    photoArea.innerHTML = '<img src="' + compressed.dataUrl + '" alt="Part photo" style="width:100%;height:100%;object-fit:cover;border-radius:inherit">';
    // Re-attach tap-to-retake
    photoArea.onclick = () => document.getElementById('cameraInput').click();

    document.getElementById('analyzeBtn').disabled = false;
    document.getElementById('addAngleBtn').style.display = 'inline-flex';
    showToast('Photo ready âœ“', 'success');
  } catch(err) {
    showToast('Photo load failed: ' + err.message, 'error');
  }

  // Reset input so same file can be selected again on iOS
  setTimeout(() => { e.target.value = ''; }, 100);
}

async function compressImage(file, maxWidth, quality) {
  return new Promise(resolve => {
    const img = new Image();
    const reader = new FileReader();
    reader.onload = e => {
      img.onload = () => {
        const canvas = document.createElement('canvas');
        let w = img.width, h = img.height;
        if (w > maxWidth) { h = h * maxWidth / w; w = maxWidth; }
        canvas.width = w; canvas.height = h;
        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
        canvas.toBlob(blob => {
          const reader2 = new FileReader();
          reader2.onload = e2 => {
            const dataUrl = e2.target.result;
            resolve({
              b64: dataUrl.split(',')[1],
              blob: blob,
              dataUrl: dataUrl
            });
          };
          reader2.readAsDataURL(blob);
        }, 'image/jpeg', quality);
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AI ANALYSIS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SMART PART NUMBER DETECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const GROUP_VOCABULARY = {
  '20,21,22,23,25,26,27': 'engine block, cylinder head, crankshaft, camshaft, piston, connecting rod, oil pan, oil pump, water pump, thermostat, radiator hose, air filter, carburettor, fuel pump, fuel tank, exhaust manifold, intake manifold, fan belt',
  '31,32,33,34,35,36,37,38,39': 'battery, alternator, starter motor, ignition coil, distributor, spark plug, fuse, relay, wiring harness, headlamp, tail lamp, switch, instrument panel, speedometer, temperature gauge',
  '41,43,45': 'clutch disc, pressure plate, release bearing, gearbox, gear lever, propeller shaft, universal joint, slip yoke, centre bearing, CV joint, driveshaft',
  '46,48': 'front axle, rear axle, hub, wheel bearing, stub axle, half shaft, power takeoff, PTO shaft',
  '51,52,55,58': 'brake drum, brake disc, brake pad, brake shoe, brake caliper, master cylinder, wheel cylinder, brake pipe, brake hose, handbrake cable, parking brake',
  '61,64': 'steering gear, steering rod, drag link, track rod, tie rod end, steering arm, pitman arm, steering column',
  '71,72,73,77': 'chassis frame, leaf spring, coil spring, shock absorber, spring shackle, radius arm, wheel rim, lug nut, tyre',
  '81,83,84,85,86,87,88': 'cab body, door, door lock, hinge, windscreen, side window, seat, seat belt, heating unit, heater hose, mudflap, spare wheel holder',
};

async function detectPartNumber(photoB64, groupFilter) {
  // Quick OCR prompt â€” much shorter/faster than full identification
  const apiKey = getApiKey();
  if (!apiKey) return null;
  if (typeof PARTS_DB === 'undefined' || PARTS_DB.length === 0) return null;

  try {
    const resp = await fetch(ANTHROPIC_API, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-haiku-4-5-20251001',
        max_tokens: 100,
        messages: [{
          role: 'user',
          content: [
            { type: 'image', source: { type: 'base64', media_type: 'image/jpeg', data: photoB64 } },
            { type: 'text', text: 'Look carefully at ALL text visible in this image â€” on labels, boxes, stamped metal, stickers, or written anywhere. Find any part number (Volvo part numbers: 4-7 digits, optionally followed by a letter like B or a dash+digit, e.g. 681609-4, 461537-3, 262257B). Return ONLY the part number if clearly visible, or NONE if not found. Do not guess â€” only report what you can actually read.' }
          ]
        }]
      })
    });
    const data = await resp.json();
    const raw = (data.content||[]).map(b=>b.text||'').join('').trim();

    if (!raw || raw === 'NONE' || raw.toLowerCase().includes('none')) return null;

    // Extract part number patterns â€” handles: 461537-3, 262257B, 681609-4, 461087
    // Volvo C3 patterns: digits with optional -digit suffix OR digits with B/A suffix
    const patterns = [
      /\d{5,7}-\d/g,      // 461537-3 style
      /\d{5,7}[A-Z]/g,    // 262257B style  
      /\d{5,7}/g,          // plain number
      /\d{4,6}-\d/g,      // shorter with suffix
    ];
    let detected = null;
    for (const pat of patterns) {
      const m = raw.match(pat);
      if (m) { detected = m[0]; break; }
    }
    if (!detected) return null;

    // Look up in PARTS_DB â€” try several matching strategies
    let filteredDB = PARTS_DB;
    if (groupFilter) {
      const groups = groupFilter.split(',');
      filteredDB = PARTS_DB.filter(p => groups.includes(p.g));
    }

    // Normalise: strip B/A suffix and dash-digit for base comparison
    const baseDetected = detected.replace(/[A-Z]$/, '').replace(/-\d$/, '');

    let dbMatch = filteredDB.find(p => p.no === detected) ||
                  filteredDB.find(p => p.no.replace(/[A-Z]$/, '').replace(/-\d$/, '') === baseDetected) ||
                  filteredDB.find(p => p.no.startsWith(baseDetected));

    if (!dbMatch) return null;

    const tatanka = getTatankaData(dbMatch.no);
    showToast('ğŸ“· Part number detected: ' + detected, 'success');
    return {
      name: dbMatch.name,
      sv: dbMatch.sv,
      no: dbMatch.no,
      group: dbMatch.g,
      confidence: 99,
      reason: 'Part number ' + detected + ' read directly from the part/packaging',
      detectedNo: detected,
      tatanka: tatanka,
      fromOCR: true
    };
  } catch(e) {
    console.log('OCR detection failed, falling back to full AI:', e.message);
    return null;
  }
}

async function analyzePhoto(useSonnet = false) {
  const apiKey = getApiKey();
  if (!apiKey) { promptApiKey('analyze'); return; }

  document.getElementById('analyzeBtn').disabled = true;
  document.getElementById('analyzeSpinner').style.display = 'inline-block';
  document.getElementById('analyzeBtnText').textContent = useSonnet ? 'ANALYZING WITH SONNET...' : 'ANALYZING...';

  const groupFilter = document.getElementById('groupFilter').value;
  const model = useSonnet ? 'claude-sonnet-4-6' : 'claude-haiku-4-5-20251001';

  // â”€â”€ SMART PART NUMBER DETECTION (skip AI if number readable) â”€â”€
  if (!useSonnet) {
    const quickMatch = await detectPartNumber(currentPhoto, groupFilter);
    if (quickMatch) {
      currentGuesses = [quickMatch];
      identifyAttempt = 0;
      showStep(2);
      renderGuesses([quickMatch]);
      document.getElementById('analyzeSpinner').style.display = 'none';
      document.getElementById('analyzeBtnText').textContent = 'ğŸ” ANALYZE PHOTO';
      document.getElementById('analyzeBtn').disabled = false;
      return;
    }
  }

  // â”€â”€ BUILD GROUP VOCABULARY CONTEXT (improvement 3) â”€â”€
  let vocabContext = '';
  if (groupFilter && GROUP_VOCABULARY[groupFilter]) {
    vocabContext = `Parts in this system include: ${GROUP_VOCABULARY[groupFilter]}.`;
  }

  const images = [
    { type: 'image', source: { type: 'base64', media_type: 'image/jpeg', data: currentPhoto } },
    ...extraAngles.map(b64 => ({ type: 'image', source: { type: 'base64', media_type: 'image/jpeg', data: b64 } }))
  ];
  const photoCount = images.length;

  try {
    // â”€â”€ STAGE 1: Visual description (improvement 1) â”€â”€
    document.getElementById('analyzeBtnText').textContent = useSonnet ? 'STAGE 1/2 SONNET...' : 'STAGE 1/2...';

    const descPrompt = `You are an expert mechanic specialising in Volvo C3 series military vehicles (C303, C304, C306, TGB 11/13/20).
Look at ${photoCount > 1 ? 'these ' + photoCount + ' photos of the same part from different angles' : 'this photo of a part'}.

FIRST: Read any text, numbers, markings, or part numbers visible anywhere in the image(s).
THEN: Describe what you see physically â€” shape, size, material, connections, notable features.

Return ONLY JSON:
{"visible_text":"any text/numbers you can read, or empty string","part_type":"e.g. propeller shaft, brake disc, fuel pump","material":"steel/rubber/aluminium/etc","connections":"e.g. universal joint at both ends","notable":"any distinctive features","system":"which vehicle system: engine/transmission/brakes/suspension/steering/electrical/body"}`;

    const descResp = await fetch(ANTHROPIC_API, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: model,
        max_tokens: 300,
        messages: [{ role: 'user', content: [...images, { type: 'text', text: descPrompt }] }]
      })
    });
    if (!descResp.ok) throw new Error('API error ' + descResp.status);
    const descData = await descResp.json();
    let descText = (descData.content||[]).map(b=>b.text||'').join('').replace(/```json|```/g,'').trim();
    const descMatch = descText.match(/\{[\s\S]*\}/);
    let description = {};
    if (descMatch) { try { description = JSON.parse(descMatch[0]); } catch(e) {} }

    // Store description for display
    window._lastDescription = description;

    // â”€â”€ STAGE 2: Part identification with description context â”€â”€
    document.getElementById('analyzeBtnText').textContent = useSonnet ? 'STAGE 2/2 SONNET...' : 'STAGE 2/2...';

    // Build candidate list from PARTS_DB filtered by detected system
    let candidates = '';
    if (typeof PARTS_DB !== 'undefined' && PARTS_DB.length > 0) {
      let pool = PARTS_DB;
      if (groupFilter) {
        const groups = groupFilter.split(',');
        pool = pool.filter(p => groups.includes(p.g));
      } else if (description.system) {
        // Auto-filter by detected system
        const sysMap = {
          'engine': ['20','21','22','23','25','26','27'],
          'transmission': ['41','43','45','46','48'],
          'brakes': ['51','52','55','58'],
          'suspension': ['71','72','73','77'],
          'steering': ['61','64'],
          'electrical': ['31','32','33','34','35','36','37','38','39'],
          'body': ['81','83','84','85','86','87','88'],
        };
        const sys = description.system.toLowerCase();
        for (const [key, groups] of Object.entries(sysMap)) {
          if (sys.includes(key)) { pool = pool.filter(p => groups.includes(p.g)); break; }
        }
      }
      // Keyword-rank candidates: parts matching the visual description float to top
      const descKeywords = [
        description.part_type, description.system, description.connections, description.notable
      ].filter(Boolean).join(' ').toLowerCase().split(/\s+/).filter(w => w.length > 3);

      const scoredPool = pool.map(p => {
        let score = 0;
        const haystack = (p.name + ' ' + p.sv).toLowerCase();
        for (const kw of descKeywords) {
          if (haystack.includes(kw)) score += 10;
          if (kw.length > 4 && haystack.includes(kw.slice(0, -1))) score += 5;
        }
        return { p, score };
      }).sort((a, b) => b.score - a.score);

      const topRelevant = scoredPool.filter(x => x.score > 0).slice(0, 30).map(x => x.p);
      const rest = scoredPool.filter(x => x.score === 0).slice(0, 30).map(x => x.p);
      const sample = [...topRelevant, ...rest];

      const relevantNote = topRelevant.length > 0 ? '\\n\\nMost relevant C3 parts (ranked by match):\\n' : '\\n\\nKnown C3 parts in this system:\\n';
      candidates = relevantNote + sample.map(p => p.no + ': ' + p.name + ' (' + p.sv + ')').join('\\n');
    }

    const idPrompt = `You are an expert mechanic and parts specialist for Volvo C3 series military vehicles (C303, C304, C306, TGB 11/13/20).

A part has been visually identified as:
- Type: ${description.part_type || 'unknown'}
- Material: ${description.material || 'unknown'}
- Connections/ends: ${description.connections || 'unknown'}
- Notable features: ${description.notable || 'none'}
- Visible text: ${description.visible_text || 'none'}
- Vehicle system: ${description.system || 'unknown'}
${vocabContext ? '- System vocabulary: ' + vocabContext : ''}
${candidates}

TASK: Give the 3 most likely part numbers from the Volvo C3 catalogue.

REASONING RULES:
1. If you recognise the part type clearly (e.g. clutch pedal, brake pedal, accelerator pedal), search for ALL variants of that part â€” different pedals share the same visual language.
2. A pedal = look for pedal, arm, lever in the list. A bracket = look for fÃ¤ste, konsol. A seal = look for tÃ¤tning, packning.
3. If the exact part is not in the candidate list, use your knowledge of Volvo C3 to suggest the most likely number anyway â€” do NOT return "unable to identify" or "not in database".
4. Always return 3 guesses. Lower confidence is fine â€” a 40% guess is more useful than giving up.
5. For parts with a clear function (pedal, pump, valve, filter), confidence should be at least 50% even without a part number visible.
${description.visible_text ? '6. PRIORITY: visible text "' + description.visible_text + '" â€” if this is a part number, use it with confidence 95+.' : ''}

Return ONLY a JSON array (best match first):
[{"name":"English name","sv":"Swedish name","no":"part number e.g. 644768","group":"group number e.g. 41","confidence":75,"reason":"one sentence â€” name the specific visual feature that led to this guess"}]
Confidence: 90-100=part number read, 70-89=certain type+strong catalogue match, 50-69=probable, 30-49=uncertain, below 30=weak guess.
Return ONLY the JSON array.`;

    const idResp = await fetch(ANTHROPIC_API, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: model,
        max_tokens: 600,
        messages: [{ role: 'user', content: [{ type: 'text', text: idPrompt }] }]
      })
    });
    if (!idResp.ok) throw new Error('API error ' + idResp.status);
    const idData = await idResp.json();
    let idText = (idData.content||[]).map(b=>b.text||'').join('').replace(/```json|```/g,'').trim();
    window._lastApiResponse = idText;

    const jsonMatch = idText.match(/\[\s*\{[\s\S]*\}\s*\]/);
    if (!jsonMatch) throw new Error('No JSON array found in response');
    let guesses = JSON.parse(jsonMatch[0]);
    if (!Array.isArray(guesses)) throw new Error('Not array');
    guesses = guesses.filter(g => g && (g.name || g.no));
    if (guesses.length === 0) throw new Error('No valid guesses in response');

    // Enrich with PARTS_DB + Tatanka
    guesses = guesses.map(g => {
      const dbMatch = typeof PARTS_DB !== 'undefined' ?
        PARTS_DB.find(p => p.no === g.no || p.no.split('-')[0] === g.no.split('-')[0]) : null;
      if (dbMatch) { g.name=g.name||dbMatch.name; g.sv=g.sv||dbMatch.sv; g.no=g.no||dbMatch.no; g.group=g.group||dbMatch.g; }
      g.tatanka = getTatankaData(g.no);
      return g;
    });

    // Attach description for display
    guesses._description = description;
    currentGuesses = guesses;
    identifyAttempt = 0;
    showStep(2);
    renderGuesses(guesses, description, useSonnet);

  } catch(err) {
    console.error('Analysis error:', err);
    let msg = err.message;
    if (window._lastApiResponse) msg += ' | ' + window._lastApiResponse.substring(0, 80);
    showToast('Analysis failed: ' + msg, 'error');
    document.getElementById('analyzeBtn').disabled = false;
  }

  document.getElementById('analyzeSpinner').style.display = 'none';
  document.getElementById('analyzeBtnText').textContent = 'ğŸ” ANALYZE PHOTO';
}


function renderGuesses(guesses, description, wasSonnet) {
  const container = document.getElementById('guessResults');
  if (!guesses || guesses.length === 0) {
    container.innerHTML = '<div class="empty"><div class="empty-icon">ğŸ¤·</div><div class="empty-title">NO MATCHES FOUND</div><div class="empty-text">Try a different angle or use the Unknown option.</div></div>';
    return;
  }

  const desc = description || window._lastDescription || {};
  const maxConf = Math.max(...guesses.map(g => g.confidence || 0));
  const allLowConf = maxConf < 50;

  // â”€â”€ AI SEES panel (improvement 1 output) â”€â”€
  let descPanel = '';
  if (desc.part_type || desc.visible_text) {
    const visText = desc.visible_text ? `<div style="margin-top:5px"><span style="color:var(--accent);font-family:'IBM Plex Mono',monospace;font-size:10px">TEXT READ:</span> <span style="font-size:12px;color:var(--green)">${desc.visible_text}</span></div>` : '';
    descPanel = `<div style="background:var(--surface2);border:1px solid var(--border2);border-left:3px solid var(--accent);border-radius:var(--radius);padding:10px 12px;margin-bottom:12px">
      <div style="font-family:'IBM Plex Mono',monospace;font-size:9px;color:var(--muted);margin-bottom:4px;letter-spacing:1px">ğŸ¤– AI SEES</div>
      <div style="font-size:13px;font-weight:500;color:var(--text)">${desc.part_type || ''}${desc.material ? ' Â· <span style="color:var(--text2)">' + desc.material + '</span>' : ''}</div>
      ${desc.connections ? `<div style="font-size:11px;color:var(--text2);margin-top:2px">${desc.connections}</div>` : ''}
      ${desc.notable ? `<div style="font-size:11px;color:var(--text2)">${desc.notable}</div>` : ''}
      ${visText}
    </div>`;
  }

  // â”€â”€ Sonnet fallback banner (improvement 4) â”€â”€
  let sonnetBanner = '';
  if (allLowConf && !wasSonnet) {
    sonnetBanner = `<div style="background:rgba(232,184,75,0.08);border:1px solid var(--accent);border-radius:var(--radius);padding:12px;margin-bottom:12px;display:flex;align-items:center;gap:10px">
      <div style="flex:1">
        <div style="font-family:'IBM Plex Mono',monospace;font-size:11px;color:var(--accent);font-weight:600">LOW CONFIDENCE â€” Best: ${maxConf}%</div>
        <div style="font-size:12px;color:var(--text2);margin-top:3px">Haiku is uncertain. Try Sonnet for deeper analysis (slower, ~10Ã— cost).</div>
      </div>
      <button onclick="analyzePhoto(true)" style="background:var(--accent);color:#000;border:none;border-radius:6px;padding:8px 12px;font-family:'IBM Plex Mono',monospace;font-size:11px;font-weight:700;cursor:pointer;white-space:nowrap;flex-shrink:0">TRY SONNET â†’</button>
    </div>`;
  } else if (wasSonnet) {
    sonnetBanner = `<div style="background:rgba(82,199,122,0.08);border:1px solid var(--green);border-radius:var(--radius);padding:8px 12px;margin-bottom:12px;font-family:'IBM Plex Mono',monospace;font-size:10px;color:var(--green)">âœ¦ SONNET ANALYSIS</div>`;
  }

  // â”€â”€ Tatanka visual candidates (improvement 2) â”€â”€
  // Find Tatanka products that visually match based on part type keywords
  let tatankaVisuals = '';
  if (desc.part_type && typeof TATANKA_DB !== 'undefined') {
    const keywords = desc.part_type.toLowerCase().split(/\s+/);
    const matches = Object.values(TATANKA_DB)
      .filter(t => t.image_local && keywords.some(k =>
        k.length > 3 && (t.name||'').toLowerCase().includes(k)))
      .slice(0, 4);
    if (matches.length > 0) {
      tatankaVisuals = `<div style="margin-bottom:12px">
        <div style="font-family:'IBM Plex Mono',monospace;font-size:9px;color:var(--muted);margin-bottom:6px;letter-spacing:1px">SIMILAR PARTS ON TATANKA</div>
        <div style="display:flex;gap:6px;overflow-x:auto;padding-bottom:4px">
          ${matches.map(t => `<div style="flex-shrink:0;text-align:center;cursor:pointer" onclick="selectTatankaCandidate('${t.base_no}')">
            <img src="${t.image_local}" style="width:56px;height:56px;border-radius:6px;object-fit:cover;border:1px solid var(--border)">
            <div style="font-family:'IBM Plex Mono',monospace;font-size:8px;color:var(--muted);margin-top:2px;width:56px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${t.name}</div>
          </div>`).join('')}
        </div>
      </div>`;
    }
  }

  // â”€â”€ Confidence label helper (improvement 5) â”€â”€
  function confLabel(c) {
    if (c >= 90) return { label: 'CERTAIN', color: 'var(--green)' };
    if (c >= 70) return { label: 'LIKELY',  color: 'var(--green)' };
    if (c >= 50) return { label: 'POSSIBLE', color: 'var(--accent)' };
    if (c >= 30) return { label: 'UNCERTAIN', color: '#ff8c42' };
    return          { label: 'GUESS',    color: 'var(--red)' };
  }

  const cards = guesses.map((g, i) => {
    const tatankaItems = g.tatanka || [];
    const bestTatanka = tatankaItems.find(t => !t.is_used) || tatankaItems[0];
    const priceEur = bestTatanka ? sekToEur(bestTatanka.price_sek) : null;

    // Show Tatanka image if available, else photo thumbnail, else icon
    const thumb = bestTatanka && bestTatanka.image_local
      ? `<img class="guess-thumb" src="${bestTatanka.image_local}" alt="" title="Tatanka reference photo">`
      : currentPhoto
        ? `<img class="guess-thumb" src="data:image/jpeg;base64,${currentPhoto}" alt="" style="opacity:0.6">`
        : `<div class="guess-thumb-placeholder">ğŸ”§</div>`;

    const conf = g.confidence || 0;
    const { label, color } = confLabel(conf);
    const isOCR = g.fromOCR;

    return `<div class="guess-card" onclick="selectGuess(${i},this)" id="guess${i}">
      ${thumb}
      <div class="guess-info">
        <div style="display:flex;align-items:center;gap:6px;margin-bottom:2px">
          <div class="guess-rank">MATCH #${i+1}</div>
          ${isOCR ? '<span style="font-family:IBM Plex Mono,monospace;font-size:9px;background:var(--green);color:#000;padding:1px 5px;border-radius:3px">SCANNED</span>' : ''}
        </div>
        <div class="guess-name">${g.name || 'Unknown Part'}</div>
        <div class="guess-no">${g.no || 'â€”'}</div>
        ${g.reason ? `<div class="guess-desc">${g.reason}</div>` : ''}
        <div class="conf-bar-wrap">
          <div class="conf-bar"><div class="conf-fill" style="width:${conf}%;background:${color}"></div></div>
          <span style="font-family:'IBM Plex Mono',monospace;font-size:10px;color:${color};font-weight:600">${conf}%</span>
          <span style="font-family:'IBM Plex Mono',monospace;font-size:9px;color:${color};margin-left:3px">${label}</span>
        </div>
        <div class="guess-meta">
          ${tatankaItems.length > 0 ? getStockBadge(bestTatanka.stock) : '<span class="badge badge-muted">Not on Tatanka</span>'}
          ${priceEur ? `<span class="badge badge-green">~${formatEur(priceEur)}</span>` : ''}
          ${bestTatanka?.image_local ? '<span class="badge badge-muted" style="font-size:9px">ğŸ“¸ ref photo</span>' : ''}
        </div>
      </div>
    </div>`;
  }).join('');

  container.innerHTML = descPanel + sonnetBanner + tatankaVisuals + cards;
}

function selectTatankaCandidate(baseNo) {
  // Find this product in PARTS_DB and pre-populate as a guess
  if (typeof PARTS_DB === 'undefined') return;
  const dbMatch = PARTS_DB.find(p => p.no.replace(/-\d$/,'').replace(/[A-Z]$/,'') === baseNo ||
                                      p.no.startsWith(baseNo));
  if (!dbMatch) { showToast('Part not in catalogue â€” add manually', 'error'); return; }
  const tatanka = getTatankaData(dbMatch.no);
  selectedGuess = { name: dbMatch.name, sv: dbMatch.sv, no: dbMatch.no,
                    group: dbMatch.g, confidence: 80, tatanka,
                    reason: 'Selected from Tatanka visual match' };
  showConfirmStep();
}



function selectGuess(index, el) {
  document.querySelectorAll('.guess-card').forEach(c => c.classList.remove('selected'));
  el.classList.add('selected');
  selectedGuess = currentGuesses[index];
  setTimeout(() => showConfirmStep(), 300);
}

function showConfirmStep() {
  if (!selectedGuess) return;
  showStep(3);

  const g = selectedGuess;
  const tatankaItems = g.tatanka || [];

  // Part summary
  document.getElementById('confirmedPartSummary').innerHTML = `
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
      ${tatankaItems[0]?.image_local ? `<img src="${tatankaItems[0].image_local}" style="width:64px;height:64px;border-radius:6px;object-fit:cover;border:1px solid var(--accent)">` : `<div style="width:64px;height:64px;border-radius:6px;background:var(--surface3);border:1px solid var(--accent);display:flex;align-items:center;justify-content:center;font-size:28px">ğŸ”§</div>`}
      <div>
        <div style="font-size:16px;font-weight:600;margin-bottom:3px">${g.name}</div>
        <div style="font-family:'IBM Plex Mono',monospace;font-size:12px;color:var(--accent)">${g.no || 'â€”'}</div>
        ${g.sv ? `<div style="font-size:12px;color:var(--text2)">${g.sv}</div>` : ''}
      </div>
    </div>`;

  // Tatanka panel
  document.getElementById('tatankaPanelConfirm').innerHTML = buildTatankaPanel(tatankaItems, g.no);

  // Suggested price
  const suggested = getSuggestedPrice(tatankaItems);
  if (suggested) {
    document.getElementById('confirmPrice').value = suggested.toFixed(2);
  }
}

function buildTatankaPanel(items, partNo) {
  if (!items || items.length === 0) return '';
  const rows = items.slice(0,3).map(t => {
    const eur = sekToEur(t.price_sek);
    return `<div class="tatanka-row">
      ${t.image_local ? `<img class="tatanka-img" src="${t.image_local}" alt="">` : `<div class="tatanka-img-ph">ğŸ”§</div>`}
      <div class="tatanka-info">
        <div class="tatanka-name">${t.name}</div>
        <div class="tatanka-price">${eur ? formatEur(eur) : 'Price on request'} <span class="tatanka-sek">${formatSek(t.price_sek)}</span></div>
        <div style="margin-top:3px">${getStockBadge(t.stock)} ${t.is_used ? '<span class="badge badge-muted">USED</span>' : t.is_upgrade ? '<span class="badge badge-blue">UPGRADE</span>' : '<span class="badge badge-yellow">ORIGINAL</span>'}</div>
        ${t.image_reference_only ? '<div style="font-size:9px;color:var(--muted);margin-top:2px">* image for reference only</div>' : ''}
      </div>
      <a class="tatanka-link" href="${t.product_url}" target="_blank">VIEW â†’</a>
    </div>`;
  }).join('');

  return `<div class="tatanka-panel">
    <div class="tatanka-header">ğŸª TATANKA.NU</div>
    ${rows}
  </div>`;
}

async function retryAnalysis() {
  identifyAttempt++;
  showStep(1);
  await analyzePhoto(false);
}

function backToGuesses() { showStep(2); }

function setCondition(val, el) {
  currentCondition = val;
  document.querySelectorAll('.cond-btn').forEach(b => b.className = 'cond-btn');
  el.classList.add('active-' + val);
}

function showStep(n) {
  for (let i = 1; i <= 4; i++) {
    const el = document.getElementById('identStep' + i);
    if (el) el.style.display = i === n ? 'block' : 'none';
    const step = document.getElementById('step' + i);
    if (step) {
      step.className = 'step' + (i < n ? ' done' : i === n ? ' active' : '');
    }
  }
  document.querySelector('.main').scrollTop = 0;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SAVE PART
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function savePart() {
  const box = document.getElementById('confirmBox').value.trim();
  const qty = parseInt(document.getElementById('confirmQty').value) || 1;
  const price = parseFloat(document.getElementById('confirmPrice').value) || 0;
  const notes = document.getElementById('confirmNotes').value.trim();

  if (!box) { showToast('Box number is required', 'error'); return; }
  if (!price) { showToast('Asking price is required', 'error'); return; }

  const g = selectedGuess;

  // Save photo
  let photoPath = null;
  if (currentPhotoBlob) {
    const photoId = 'inv_' + Date.now();
    const reader = new FileReader();
    photoPath = await new Promise(resolve => {
      reader.onload = e => resolve(e.target.result);
      reader.readAsDataURL(currentPhotoBlob);
    });
  }

  // Check for existing same part in same box
  const existing = INVENTORY.find(i =>
    i.partNo === g.no && i.box === box && i.status !== 'sold'
  );

  const newItem = {
    id: Date.now(),
    partNo: g.no || '',
    name: g.name || '',
    nameSv: g.sv || '',
    group: g.group || '',
    box: box,
    qty: qty,
    condition: currentCondition,
    askingPrice: price,
    notes: notes,
    photo: photoPath,
    status: 'available',
    addedDate: new Date().toISOString(),
    isCustom: false,
    isUnknown: false,
  };

  let duplicateMsg = '';
  if (existing) {
    existing.qty += qty;
    duplicateMsg = `Added ${qty} to existing entry in Box ${box}. Total: ${existing.qty} pcs.`;
    saveInventory();
  } else {
    INVENTORY.push(newItem);
    saveInventory();
  }

  showStep(4);
  document.getElementById('savedPartSummary').innerHTML =
    `<b>${g.name}</b><br>${g.no || ''} Â· Box ${box} Â· Ã—${qty}<br><span style="color:var(--green)">${formatEur(price)}</span>`;

  const dupWarn = document.getElementById('duplicateWarning');
  if (duplicateMsg) {
    dupWarn.style.display = 'block';
    dupWarn.innerHTML = 'âš ï¸ ' + duplicateMsg;
  } else {
    dupWarn.style.display = 'none';
  }

  showToast('Part saved!', 'success');
}

function addAsUnknown() {
  openModal('unknownForm');
}

async function saveUnknownPart(form) {
  const name = document.getElementById('unknownName').value.trim();
  const box = document.getElementById('unknownBox').value.trim();
  const qty = parseInt(document.getElementById('unknownQty').value) || 1;
  if (!box) { showToast('Box number required', 'error'); return; }

  let photoPath = null;
  if (currentPhotoBlob) {
    const reader = new FileReader();
    photoPath = await new Promise(resolve => {
      reader.onload = e => resolve(e.target.result);
      reader.readAsDataURL(currentPhotoBlob);
    });
  }

  const item = {
    id: Date.now(),
    partNo: 'UNKNOWN-' + String(INVENTORY.filter(i=>i.isUnknown).length + 1).padStart(4,'0'),
    name: name || 'Unknown Part',
    box: box, qty: qty,
    photo: photoPath,
    status: 'available',
    isUnknown: true,
    addedDate: new Date().toISOString(),
    askingPrice: 0,
  };

  INVENTORY.push(item);
  saveInventory();
  closeModal();
  showToast('Saved to Unknown pile', 'success');
  showScreen('inventory');
}

function resetIdentify() {
  currentPhoto = null; currentPhotoBlob = null;
  currentGuesses = []; selectedGuess = null; currentCondition = null;
  const area = document.getElementById('photoArea');
  area.classList.remove('has-photo');
  area.innerHTML = `<div class="photo-placeholder"><div class="photo-icon">ğŸ“·</div><div class="photo-label">TAP TO TAKE PHOTO</div><div class="photo-sublabel">or choose from gallery</div></div>`;
  area.onclick = () => document.getElementById('cameraInput').click();
  document.getElementById('analyzeBtn').disabled = true;
  document.getElementById('groupFilter').value = '';
  document.getElementById('confirmBox').value = '';
  document.getElementById('confirmQty').value = '1';
  document.getElementById('confirmPrice').value = '';
  document.getElementById('confirmNotes').value = '';
  document.querySelectorAll('.cond-btn').forEach(b => b.className = 'cond-btn');
  extraAngles = [];
  renderAngleStrip();
  document.getElementById('addAngleBtn').style.display = 'none';
  showStep(1);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INVENTORY RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let invFilter = 'all';
let invSearch = '';

function setInvFilter(f, el) {
  invFilter = f;
  document.querySelectorAll('#invFilterChips .chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  filterInventory();
}

function filterInventory() {
  invSearch = document.getElementById('invSearch').value.toLowerCase();
  renderInventory();
}

function renderInventory() {
  const list = document.getElementById('invList');
  if (!list) return;

  let items = [...INVENTORY];

  // Apply filter
  if (invFilter === 'available') items = items.filter(i => i.status === 'available' && !i.isUnknown);
  else if (invFilter === 'listed') items = items.filter(i => i.status === 'listed');
  else if (invFilter === 'unknown') items = items.filter(i => i.isUnknown);
  else if (invFilter === 'sold') items = items.filter(i => i.status === 'sold');
  else items = items.filter(i => i.status !== 'sold');

  // Apply search
  if (invSearch) {
    items = items.filter(i =>
      (i.name||'').toLowerCase().includes(invSearch) ||
      (i.partNo||'').toLowerCase().includes(invSearch) ||
      (i.box||'').toLowerCase().includes(invSearch) ||
      (i.notes||'').toLowerCase().includes(invSearch)
    );
  }

  if (items.length === 0) {
    list.innerHTML = `<div class="empty">
      <div class="empty-icon">${invFilter === 'unknown' ? 'â“' : 'ğŸ“¦'}</div>
      <div class="empty-title">${invFilter === 'unknown' ? 'NO UNKNOWN PARTS' : 'NO PARTS'}</div>
      <div class="empty-text">${invFilter === 'all' ? 'Start by identifying and adding parts.' : 'Nothing matches your filter.'}</div>
    </div>`;
    return;
  }

  list.innerHTML = items.map(item => renderInvItem(item)).join('');
}

function renderInvItem(item) {
  const tatankaItems = item.partNo ? getTatankaData(item.partNo) : [];
  const bestT = tatankaItems.find(t=>!t.is_used) || tatankaItems[0];
  const tatankaEur = bestT ? sekToEur(bestT.price_sek) : null;

  const thumb = item.photo ?
    `<img class="inv-thumb" src="${item.photo}" alt="">` :
    (bestT?.image_local ? `<img class="inv-thumb" src="${bestT.image_local}" alt="">` :
    `<div class="inv-thumb-ph">${item.isUnknown ? 'â“' : 'ğŸ”§'}</div>`);

  const cls = item.isUnknown ? 'unknown-item' : 'inv-item';

  return `<div class="${cls}" id="invitem${item.id}">
    <div class="inv-item-header">
      ${thumb}
      <div class="inv-info">
        <div class="inv-name">${item.name || 'Unknown Part'}</div>
        <div class="inv-no">${item.partNo || ''}</div>
        <div class="inv-meta">
          <span class="badge badge-muted">ğŸ“¦ Box ${item.box || 'â€”'}</span>
          <span class="badge badge-muted">Ã—${item.qty || 1}</span>
          ${getConditionBadge(item.condition)}
          ${getStatusBadge(item.status)}
        </div>
        <div class="inv-price-row">
          <span class="inv-asking">${formatEur(item.askingPrice)}</span>
          ${tatankaEur ? `<span class="inv-ref">Tatanka: ${formatEur(tatankaEur)}</span>` : ''}
        </div>
      </div>
    </div>
    <div class="inv-actions">
      ${item.status !== 'sold' ? `
        ${item.status === 'available' ? `<button class="btn btn-secondary btn-xs" onclick="setItemStatus(${item.id},'listed')">ğŸ“¢ MARK LISTED</button>` : ''}
        ${item.status === 'listed' ? `<button class="btn btn-success btn-xs" onclick="confirmSold(${item.id})">ğŸ’° SOLD</button>` : ''}
        ${item.status === 'listed' ? `<button class="btn btn-secondary btn-xs" onclick="setItemStatus(${item.id},'available')">â†© UNLIST</button>` : ''}
        <button class="btn btn-secondary btn-xs" onclick="editItem(${item.id})">âœï¸ EDIT</button>
        <button class="btn btn-secondary btn-xs" onclick="refreshItemPrice(${item.id})">â†» Price</button>
        <button class="btn btn-secondary btn-xs" onclick="showQRForItem(${item.id})">ğŸ·ï¸ LABEL</button>
      ` : `<span style="font-size:12px;color:var(--muted)">Sold on ${item.soldDate ? new Date(item.soldDate).toLocaleDateString() : 'â€”'}</span>`}
      ${item.isUnknown ? `<button class="btn btn-secondary btn-xs" onclick="retryIdentify(${item.id})">ğŸ” IDENTIFY</button>` : ''}
      ${item.status !== 'sold' && !item.isUnknown ? `<button class="btn btn-secondary btn-xs" onclick="shareWhatsApp(${item.id})" style="background:rgba(37,211,102,0.15);border-color:#25D366;color:#25D366">ğŸ’¬ WhatsApp</button>` : ''}
      <button class="btn btn-danger btn-xs" onclick="deleteItem(${item.id})">ğŸ—‘ï¸</button>
    </div>
  </div>`;
}

function setItemStatus(id, status) {
  const item = INVENTORY.find(i => i.id === id);
  if (!item) return;
  item.status = status;
  saveInventory();
  renderInventory();
  showToast('Status updated', 'success');
}

function confirmSold(id) {
  const item = INVENTORY.find(i => i.id === id);
  if (!item) return;
  openModal('soldConfirm', item);
}

function markSold(id) {
  const item = INVENTORY.find(i => i.id === id);
  if (!item) return;
  item.status = 'sold';
  item.soldDate = new Date().toISOString();
  saveInventory();
  closeModal();
  renderInventory();
  renderSummary();
  showToast('Part marked as sold âœ“', 'success');
}

function deleteItem(id) {
  if (!confirm('Delete this part from inventory?')) return;
  INVENTORY = INVENTORY.filter(i => i.id !== id);
  saveInventory();
  renderInventory();
  renderSummary();
  showToast('Deleted');
}

function editItem(id) {
  const item = INVENTORY.find(i => i.id === id);
  if (!item) return;
  openModal('editItem', item);
}

function saveEditItem(id) {
  const item = INVENTORY.find(i => i.id === id);
  if (!item) return;
  item.box = document.getElementById('editBox').value.trim() || item.box;
  item.qty = parseInt(document.getElementById('editQty').value) || item.qty;
  item.askingPrice = parseFloat(document.getElementById('editPrice').value) || item.askingPrice;
  item.notes = document.getElementById('editNotes').value;
  const cond = document.querySelector('.cond-btn.active-good, .cond-btn.active-fair, .cond-btn.active-poor');
  if (cond) item.condition = cond.dataset.cond;
  saveInventory();
  closeModal();
  renderInventory();
  showToast('Updated', 'success');
}

function retryIdentify(id) {
  const item = INVENTORY.find(i => i.id === id);
  if (!item) return;
  if (item.photo) {
    currentPhoto = item.photo.split(',')[1];
    currentPhotoBlob = null;
    showScreen('identify');
    const area = document.getElementById('photoArea');
    area.classList.add('has-photo');
    area.innerHTML = `<img src="${item.photo}" alt="">`;
    document.getElementById('analyzeBtn').disabled = false;
    showToast('Photo loaded â€” tap Analyze');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CATALOGUE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let catFilter = '';
let catSearch = '';

function setCatFilter(f, el) {
  catFilter = f;
  document.querySelectorAll('#catFilterChips .chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  filterCatalogue();
}

function filterCatalogue() {
  catSearch = document.getElementById('catSearch').value.toLowerCase();
  renderCatalogue();
}

// â”€â”€ Search synonym map â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SEARCH_SYNONYMS = {
  'screw':['screw','skruv','bolt','bult'],'bolt':['bolt','bult','screw','skruv'],
  'nut':['nut','mutter'],'washer':['washer','bricka','ring'],
  'gasket':['gasket','packning','seal','tÃ¤tning'],'seal':['seal','tÃ¤tning','gasket','packning','o-ring'],
  'bearing':['bearing','lager','kullager'],'filter':['filter','insats','filterinsats'],
  'hose':['hose','slang','pipe','rÃ¶r'],'pipe':['pipe','rÃ¶r','hose','slang'],
  'pump':['pump'],'valve':['valve','ventil'],'spring':['spring','fjÃ¤der'],
  'bracket':['bracket','fÃ¤ste','konsol','hÃ¥llare'],'cover':['cover','lock','kÃ¥pa'],
  'plug':['plug','plugg','lock'],'shaft':['shaft','axel'],'gear':['gear','kugghjul','vÃ¤xel'],
  'cable':['cable','kabel','vajer','vajern'],'switch':['switch','brytare','kontakt'],
  'relay':['relay','relÃ¤'],'sensor':['sensor','givare'],
  'lamp':['lamp','lampa','bulb','glÃ¶dlampa'],'bulb':['bulb','glÃ¶dlampa','lamp'],
  'brake':['brake','broms'],'clutch':['clutch','koppling'],
  'pad':['pad','belÃ¤gg'],'disc':['disc','skiva','disk'],
  'shock':['shock','dÃ¤mpare','stÃ¶tdÃ¤mpare'],'bushing':['bushing','bussning'],
  'pin':['pin','tapp','pinne','stift'],'clip':['clip','klÃ¤mma'],
  'rubber':['rubber','gummi'],'belt':['belt','rem','drivrem'],
  'tank':['tank','behÃ¥llare'],'engine':['engine','motor'],
  'radiator':['radiator','kylare'],'fan':['fan','flÃ¤kt'],
  'steering':['steering','styrning'],'door':['door','dÃ¶rr'],
  'window':['window','ruta','glas'],'seat':['seat','sÃ¤te'],
  'exhaust':['exhaust','avgasrÃ¶r','avgassystem'],'intake':['intake','inlopp','luftfilter'],
  'oil':['oil','olja','smÃ¶rj'],'fuel':['fuel','brÃ¤nsle'],
  'coolant':['coolant','kylvÃ¤tska'],'battery':['battery','batteri'],
  'alternator':['alternator','generator'],'starter':['starter','startmotor'],
  'ignition':['ignition','tÃ¤ndning','tÃ¤ndspole'],'axle':['axle','axel','nav'],
  'wheel':['wheel','hjul','fÃ¤lg'],'tire':['tire','tyre','dÃ¤ck'],
  'suspension':['suspension','fjÃ¤dring','upphÃ¤ngning'],'frame':['frame','ram'],
  'bumper':['bumper','stÃ¶tfÃ¥ngare'],'body':['body','karosseri'],
  'heating':['heating','vÃ¤rme'],'wiring':['wiring','ledning','kablar'],
  'fuse':['fuse','sÃ¤kring'],'kit':['kit','sats','set'],
  'plate':['plate','plÃ¥t','platta'],'bracket':['bracket','konsol','fÃ¤ste'],
  'clamp':['clamp','klÃ¤mma','clips'],'stud':['stud','pinnbult','pinnskruv'],
  'ring':['ring','bricka','tÃ¤tningsring'],'bush':['bush','bussning'],
  'cap':['cap','lock','huv'],'arm':['arm','lÃ¤nk','stag'],
  'rod':['rod','stag','stÃ¥ng'],'link':['link','lÃ¤nk','stag'],
  'joint':['joint','led','knut'],'shaft':['shaft','axel','axeln'],
};

function expandSearchTerms(query) {
  const words = query.toLowerCase().trim().split(/\s+/);
  const allTerms = new Set(words);
  for (const word of words) {
    if (SEARCH_SYNONYMS[word]) SEARCH_SYNONYMS[word].forEach(s => allTerms.add(s));
    if (word.endsWith('s') && word.length > 3) allTerms.add(word.slice(0,-1));
    if (word.endsWith('es') && word.length > 4) allTerms.add(word.slice(0,-2));
    if (word.endsWith('ing') && word.length > 5) allTerms.add(word.slice(0,-3));
  }
  return [...allTerms];
}

function searchScore(part, terms) {
  let score = 0;
  const name = (part.name||'').toLowerCase();
  const sv   = (part.sv||'').toLowerCase();
  const no   = (part.no||'').toLowerCase();
  for (const term of terms) {
    if (no === term) { score += 100; continue; }
    if (no.startsWith(term)) { score += 60; continue; }
    if (no.includes(term)) { score += 40; continue; }
    const nameWords = name.split(/\s+/);
    if (nameWords.includes(term)) { score += 35; continue; }
    if (name.includes(term)) { score += 20; continue; }
    if (sv.includes(term)) { score += 10; continue; }
  }
  return score;
}

function renderCatalogue() {
  const list = document.getElementById('catList');
  if (!list) return;

  if (!PARTS_DB || PARTS_DB.length === 0) {
    list.innerHTML = `<div class="empty"><div class="empty-icon">âš ï¸</div><div class="empty-title">CATALOGUE NOT LOADED</div>
      <div class="empty-text">PARTS_DB.js did not load.<br><br>Check that you:<br>
      1. Changed <b>const PARTS_DB =</b> to <b>window.PARTS_DB_DATA =</b> in PARTS_DB.js<br>
      2. Uncommented the script tag at the bottom of index.html</div></div>`;
    return;
  }

  if (!catSearch && !catFilter) {
    list.innerHTML = `<div class="empty"><div class="empty-icon">ğŸ“‹</div>
      <div class="empty-title">SEARCH THE CATALOGUE</div>
      <div class="empty-text">${PARTS_DB.length.toLocaleString()} parts loaded.<br>
      Type a part name, number, or keyword.<br><br>
      <span style="color:var(--accent)">Try: screw Â· gasket Â· bearing Â· filter Â· hose Â· valve</span></div></div>`;
    return;
  }

  let items = [...PARTS_DB];
  if (catFilter) items = items.filter(p => p.g === catFilter);

  if (catSearch) {
    const terms = expandSearchTerms(catSearch);
    const scored = items
      .map(p => ({ p, score: searchScore(p, terms) }))
      .filter(x => x.score > 0)
      .sort((a, b) => b.score - a.score);
    items = scored.map(x => x.p);
  }

  const shown = items.slice(0, 100);
  if (shown.length === 0) {
    list.innerHTML = `<div class="empty"><div class="empty-icon">ğŸ”</div><div class="empty-title">NO RESULTS</div>
      <div class="empty-text">No match for "<b>${catSearch}</b>"<br><br>
      <span style="color:var(--accent)">Try: screw Â· bolt Â· gasket Â· bearing Â· filter Â· hose Â· seal Â· valve Â· spring</span></div></div>`;
    return;
  }

  list.innerHTML =
    `<div class="section-header">${items.length > 100 ? 'Top 100 of '+items.length+' results' : items.length+' result'+(items.length>1?'s':'')}</div>` +
    shown.map(p => {
      const tatankaItems = getTatankaData(p.no);
      const bestT = tatankaItems.find(t=>!t.is_used) || tatankaItems[0];
      const eur = bestT ? sekToEur(bestT.price_sek) : null;
      const thumb = bestT?.image_local ?
        `<img style="width:40px;height:40px;border-radius:5px;object-fit:cover;border:1px solid var(--border);flex-shrink:0" src="${bestT.image_local}" alt="">` :
        `<div style="width:40px;height:40px;border-radius:5px;background:var(--surface2);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;color:var(--muted)">ğŸ”§</div>`;
      return `<div class="cat-item" onclick="openCatDetail('${p.no.replace(/'/g,"\\'")}')">
        ${thumb}
        <div class="cat-item-info">
          <div class="cat-item-name">${p.name}</div>
          <div class="cat-item-no">${p.no} Â· ${p.sv}</div>
        </div>
        <div class="cat-item-price">${eur ? formatEur(eur) : ''}</div>
      </div>`;
    }).join('');
}

function openCatDetail(partNo) {
  const part = (typeof PARTS_DB !== 'undefined') ? PARTS_DB.find(p => p.no === partNo) : null;
  if (!part) return;
  openModal('catDetail', part);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUMMARY & STATS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderSummary() {
  const statsEl = document.getElementById('summaryStats');
  const valsEl = document.getElementById('summaryValues');
  const boxEl = document.getElementById('boxSummary');
  if (!statsEl) return;

  const active = INVENTORY.filter(i => i.status !== 'sold' && !i.isUnknown);
  const listed = INVENTORY.filter(i => i.status === 'listed');
  const sold = INVENTORY.filter(i => i.status === 'sold');
  const unknown = INVENTORY.filter(i => i.isUnknown);
  const boxes = new Set(active.map(i => i.box).filter(Boolean));

  statsEl.innerHTML = `
    <div class="stat-box"><div class="stat-val">${active.length}</div><div class="stat-label">PARTS</div></div>
    <div class="stat-box"><div class="stat-val">${boxes.size}</div><div class="stat-label">BOXES</div></div>
    <div class="stat-box"><div class="stat-val">${listed.length}</div><div class="stat-label">LISTED</div></div>
    <div class="stat-box"><div class="stat-val">${sold.length}</div><div class="stat-label">SOLD</div></div>
    <div class="stat-box"><div class="stat-val">${unknown.length}</div><div class="stat-label">UNKNOWN</div></div>
    <div class="stat-box"><div class="stat-val">${active.reduce((s,i)=>s+i.qty,0)}</div><div class="stat-label">TOTAL QTY</div></div>`;

  // Value calculations
  const myTotal = active.reduce((s,i) => s + (i.askingPrice * i.qty), 0);
  const soldTotal = sold.reduce((s,i) => s + (i.askingPrice * i.qty), 0);
  const tatankaTotal = active.reduce((s,i) => {
    const t = getTatankaData(i.partNo);
    const best = t.find(x=>!x.is_used) || t[0];
    return s + (best ? (sekToEur(best.price_sek)||0) * i.qty : 0);
  }, 0);

  valsEl.innerHTML = `
    <div style="margin-top:4px">
      <div class="settings-row">
        <div><div class="settings-label">My Asking Prices Total</div></div>
        <div style="font-family:'IBM Plex Mono',monospace;font-size:13px;color:var(--green);font-weight:600">${formatEur(Math.round(myTotal*100)/100)}</div>
      </div>
      <div class="settings-row">
        <div><div class="settings-label">Tatanka Reference Total</div></div>
        <div style="font-family:'IBM Plex Mono',monospace;font-size:13px;color:var(--accent)">${formatEur(Math.round(tatankaTotal*100)/100)}</div>
      </div>
      <div class="settings-row">
        <div><div class="settings-label">Revenue from Sales</div></div>
        <div style="font-family:'IBM Plex Mono',monospace;font-size:13px;color:var(--blue)">${formatEur(Math.round(soldTotal*100)/100)}</div>
      </div>
    </div>`;

  // Box summary
  const byBox = {};
  active.forEach(i => {
    const b = i.box || 'No Box';
    if (!byBox[b]) byBox[b] = [];
    byBox[b].push(i);
  });
  const sortedBoxes = Object.keys(byBox).sort((a,b) => {
    const na = parseInt(a), nb = parseInt(b);
    if (!isNaN(na) && !isNaN(nb)) return na - nb;
    return a.localeCompare(b);
  });

  if (sortedBoxes.length === 0) {
    boxEl.innerHTML = '<div style="color:var(--muted);font-size:13px">No parts with box numbers yet.</div>';
  } else {
    boxEl.innerHTML = sortedBoxes.map(box => {
      const parts = byBox[box];
      const total = parts.reduce((s,p) => s + (p.askingPrice * p.qty), 0);
      return `<div class="box-card" onclick="filterByBox('${box}')">
        <div class="box-title">ğŸ“¦ BOX ${box}</div>
        <div class="box-parts">${parts.map(p => `${p.name} Ã—${p.qty}`).slice(0,5).join(' Â· ')}${parts.length > 5 ? ` Â· +${parts.length-5} more` : ''}</div>
        <div style="margin-top:6px;font-family:'IBM Plex Mono',monospace;font-size:11px;color:var(--green)">${formatEur(Math.round(total*100)/100)} Â· ${parts.length} part types</div>
      </div>`;
    }).join('');
  }
}

function filterByBox(box) {
  showScreen('inventory');
  document.getElementById('invSearch').value = box;
  invSearch = box.toLowerCase();
  invFilter = 'all';
  document.querySelectorAll('#invFilterChips .chip').forEach(c => c.classList.remove('active'));
  document.querySelector('#invFilterChips .chip').classList.add('active');
  renderInventory();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function exportCatalogue(mode) {
  const active = INVENTORY.filter(i => i.status !== 'sold' && !i.isUnknown && i.askingPrice > 0);
  if (active.length === 0) { showToast('No parts to export', 'error'); return; }

  const date = new Date().toLocaleDateString('en-GB');
  const totalEur = active.reduce((s,i) => s + i.askingPrice * i.qty, 0);

  let html = `<!DOCTYPE html><html><head><meta charset="UTF-8">
  <title>Volvo C3 Parts - Sales Catalogue</title>
  <style>
    body{font-family:Arial,sans-serif;max-width:900px;margin:0 auto;padding:20px;color:#333}
    h1{color:#c97b2e;border-bottom:3px solid #c97b2e;padding-bottom:10px}
    .meta{color:#666;font-size:14px;margin-bottom:20px}
    table{width:100%;border-collapse:collapse;margin-bottom:20px}
    th{background:#1a1a1a;color:#e8b84b;padding:10px;text-align:left;font-size:12px}
    td{padding:9px 10px;border-bottom:1px solid #eee;font-size:13px}
    tr:nth-child(even)td{background:#f9f9f9}
    .part-card{border:1px solid #ddd;border-radius:8px;padding:14px;margin-bottom:12px;page-break-inside:avoid}
    .part-no{font-family:monospace;color:#c97b2e;font-size:12px}
    .part-name{font-size:16px;font-weight:bold;margin:4px 0}
    .part-price{color:#27ae60;font-size:18px;font-weight:bold}
    .part-meta{font-size:12px;color:#666;margin-top:4px}
    .total{background:#1a1a1a;color:#e8b84b;padding:12px 16px;border-radius:6px;font-size:16px;font-weight:bold;text-align:right}
    @media print{.no-print{display:none}}
  </style></head><body>
  <h1>ğŸš™ Volvo C3 Series â€” Parts For Sale</h1>
  <div class="meta">Generated: ${date} Â· ${active.length} parts Â· Contact for purchase</div>`;

  if (mode === 'bulk') {
    html += `<table><tr><th>Part No.</th><th>Description</th><th>Box</th><th>Qty</th><th>Condition</th><th>Price (EUR)</th></tr>`;
    active.forEach(i => {
      html += `<tr><td style="font-family:monospace">${i.partNo}</td><td>${i.name}${i.notes?`<br><small style="color:#999">${i.notes}</small>`:''}</td><td>${i.box}</td><td>${i.qty}</td><td>${i.condition||'â€”'}</td><td style="color:#27ae60;font-weight:600">${formatEur(i.askingPrice)}</td></tr>`;
    });
    html += `</table><div class="total">TOTAL: ${formatEur(Math.round(totalEur*100)/100)}</div>`;
  } else {
    active.forEach(i => {
      const t = getTatankaData(i.partNo);
      const best = t.find(x=>!x.is_used)||t[0];
      html += `<div class="part-card">
        <div class="part-no">${i.partNo}</div>
        <div class="part-name">${i.name}</div>
        <div class="part-price">${formatEur(i.askingPrice)}</div>
        <div class="part-meta">
          Box: ${i.box} Â· Qty: ${i.qty} Â· Condition: ${i.condition||'Not specified'}
          ${best ? ` Â· Tatanka ref: ${best.price_sek ? best.price_sek.toLocaleString()+' SEK' : 'N/A'}` : ''}
          ${i.notes ? `<br>Notes: ${i.notes}` : ''}
        </div>
      </div>`;
    });
    html += `<div class="total">TOTAL VALUE: ${formatEur(Math.round(totalEur*100)/100)}</div>`;
  }

  html += '</body></html>';
  const blob = new Blob([html], {type:'text/html'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `volvo_c3_parts_${mode}_${Date.now()}.html`;
  a.click();
  showToast('Catalogue exported!', 'success');
}

function exportInventoryJSON() {
  const blob = new Blob([JSON.stringify(INVENTORY,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `volvo_inventory_backup_${Date.now()}.json`;
  a.click();
  showToast('Backup saved!', 'success');
}

function importInventoryJSON(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const data = JSON.parse(e.target.result);
      if (Array.isArray(data)) {
        INVENTORY = data;
        saveInventory();
        renderInventory();
        renderSummary();
        showToast('Backup restored!', 'success');
      }
    } catch(err) { showToast('Invalid backup file', 'error'); }
  };
  reader.readAsText(file);
  input.value = '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CUSTOM PARTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function saveCustomPart() {
  const name = document.getElementById('customName').value.trim();
  const category = document.getElementById('customCategory').value;
  const sourceUrl = document.getElementById('customUrl').value.trim();
  const box = document.getElementById('customBox').value.trim();
  const qty = parseInt(document.getElementById('customQty').value) || 1;
  const notes = document.getElementById('customNotes').value.trim();

  if (!name) { showToast('Part name required', 'error'); return; }
  if (!box) { showToast('Box number required', 'error'); return; }

  let price = parseFloat(document.getElementById('customPrice').value) || 0;
  let sourcePrice = parseFloat(document.getElementById('customSourcePrice').value) || 0;
  if (!price && sourcePrice) {
    price = Math.round(sourcePrice * (SETTINGS.discountIn / 100) * 100) / 100;
  }

  let photoPath = null;
  const photoInput = document.getElementById('customPhotoInput');
  if (photoInput.files[0]) {
    const comp = await compressImage(photoInput.files[0], 800, 0.8);
    photoPath = comp.dataUrl;
  }

  const customId = 'CUSTOM-' + String(INVENTORY.filter(i=>i.isCustom).length + 1).padStart(4,'0');

  const item = {
    id: Date.now(),
    partNo: customId,
    name: name,
    group: category,
    box: box, qty: qty,
    askingPrice: price,
    sourcePrice: sourcePrice,
    sourceUrl: sourceUrl,
    notes: notes,
    photo: photoPath,
    status: 'available',
    isCustom: true,
    isUnknown: false,
    addedDate: new Date().toISOString(),
  };

  INVENTORY.push(item);
  saveInventory();
  closeModal();
  renderInventory();
  renderSummary();
  showToast('Custom part added!', 'success');
}

async function fetchSourcePrice() {
  const url = document.getElementById('customUrl').value.trim();
  if (!url) { showToast('Enter URL first', 'error'); return; }

  const btn = document.getElementById('fetchPriceBtn');
  btn.textContent = 'â³ Fetching...';
  btn.disabled = true;

  try {
    const apiKey = getApiKey();
    if (!apiKey) { btn.textContent = 'ğŸ” Fetch Price'; btn.disabled = false; return; }

    const response = await fetch(ANTHROPIC_API, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-haiku-4-5-20251001',
        max_tokens: 200,
        tools: [{ type: 'web_search_20250305', name: 'web_search' }],
        messages: [{
          role: 'user',
          content: `Visit this URL and extract the product name and price in EUR: ${url}\n\nReturn ONLY JSON: {"name":"product name","price":99.99,"currency":"EUR"}`
        }]
      })
    });

    if (!response.ok) throw new Error('API error ' + response.status + ': ' + await response.text());
    const data = await response.json();
    const text = (data.content||[]).map(b=>b.text||'').join('').replace(/```json|```/g,'').trim();
    const m = text.match(/\{.*\}/s);
    if (m) {
      const parsed = JSON.parse(m[0]);
      if (parsed.price) {
        document.getElementById('customSourcePrice').value = parsed.price;
        if (parsed.name && !document.getElementById('customName').value) {
          document.getElementById('customName').value = parsed.name;
        }
        // Auto-fill asking price
        const suggested = Math.round(parsed.price * (SETTINGS.discountIn/100) * 100) / 100;
        document.getElementById('customPrice').value = suggested;
        showToast('Price fetched: ' + parsed.price + ' EUR', 'success');
      }
    }
  } catch(e) {
    showToast('Could not fetch price â€” enter manually', 'error');
  }

  btn.textContent = 'ğŸ” Fetch Price';
  btn.disabled = false;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QR LABELS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function showQRModal(mode) { openModal('qrLabel', mode); }
function showQRForItem(id) {
  const item = INVENTORY.find(i => i.id === id);
  if (item) openModal('qrLabelItem', item);
}

function generateQRSVG(text, size) {
  // Simple QR code placeholder â€” in production would use a QR library
  // For now generate a data URL that encodes the text
  const encoded = encodeURIComponent(text);
  return `<img src="https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&data=${encoded}" width="${size}" height="${size}" alt="QR">`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function openModal(type, data) {
  const body = document.getElementById('modalBody');
  let html = '';

  if (type === 'catDetail') {
    const p = data;
    const tatankaItems = getTatankaData(p.no);
    html = `<button class="modal-close" onclick="closeModal()">âœ•</button>
      <div class="modal-title">${p.name}</div>
      <div style="font-family:'IBM Plex Mono',monospace;font-size:12px;color:var(--accent);margin-bottom:4px">${p.no}</div>
      <div style="font-size:13px;color:var(--text2);margin-bottom:12px">${p.sv} Â· Group ${p.g}</div>
      ${buildTatankaPanel(tatankaItems, p.no)}
      <div style="margin-top:14px">
        <button class="btn btn-primary btn-full" onclick="addFromCatalogue('${p.no.replace(/'/g,"\\'")}');closeModal()">+ ADD TO INVENTORY</button>
      </div>`;
  }

  else if (type === 'unknownForm') {
    html = `<button class="modal-close" onclick="closeModal()">âœ•</button>
      <div class="modal-title">â“ ADD UNKNOWN PART</div>
      <div class="fg"><label>Description (optional)</label><input type="text" id="unknownName" placeholder="What do you think it might be?"></div>
      <div class="row2">
        <div class="fg"><label>Box <span class="req">*</span></label><input type="text" id="unknownBox" placeholder="Box number"></div>
        <div class="fg"><label>Qty</label><input type="number" id="unknownQty" value="1" min="1"></div>
      </div>
      <button class="btn btn-primary btn-full" onclick="saveUnknownPart()">SAVE TO UNKNOWN PILE</button>`;
  }

  else if (type === 'soldConfirm') {
    const item = data;
    html = `<button class="modal-close" onclick="closeModal()">âœ•</button>
      <div class="modal-title">ğŸ’° CONFIRM SOLD</div>
      <div style="font-size:14px;margin-bottom:16px">Mark <b>${item.name}</b> as sold?<br>This will remove it from your active inventory.</div>
      <div style="background:rgba(82,199,122,0.1);border:1px solid var(--green);border-radius:var(--radius);padding:12px;margin-bottom:16px;text-align:center">
        <div style="font-family:'IBM Plex Mono',monospace;font-size:20px;color:var(--green)">${formatEur(item.askingPrice * item.qty)}</div>
        <div style="font-size:12px;color:var(--text2)">Ã—${item.qty} @ ${formatEur(item.askingPrice)} each</div>
      </div>
      <div class="btn-group">
        <button class="btn btn-secondary" style="flex:1" onclick="closeModal()">Cancel</button>
        <button class="btn btn-success" style="flex:1" onclick="markSold(${item.id})">âœ“ CONFIRM SOLD</button>
      </div>`;
  }

  else if (type === 'editItem') {
    const item = data;
    html = `<button class="modal-close" onclick="closeModal()">âœ•</button>
      <div class="modal-title">âœï¸ EDIT PART</div>
      <div style="font-size:14px;font-weight:600;margin-bottom:12px">${item.name}</div>
      <div class="row2">
        <div class="fg"><label>Box</label><input type="text" id="editBox" value="${item.box||''}"></div>
        <div class="fg"><label>Qty</label><input type="number" id="editQty" value="${item.qty||1}" min="1"></div>
      </div>
      <div class="fg"><label>Asking Price (EUR)</label><input type="number" id="editPrice" value="${item.askingPrice||0}" step="0.01"></div>
      <div class="fg">
        <label>Condition</label>
        <div class="condition-btns">
          <button class="cond-btn${item.condition==='good'?' active-good':''}" data-cond="good" onclick="setCondition('good',this)">âœ… Good</button>
          <button class="cond-btn${item.condition==='fair'?' active-fair':''}" data-cond="fair" onclick="setCondition('fair',this)">âš ï¸ Fair</button>
          <button class="cond-btn${item.condition==='poor'?' active-poor':''}" data-cond="poor" onclick="setCondition('poor',this)">âŒ Poor</button>
        </div>
      </div>
      <div class="fg"><label>Notes</label><textarea id="editNotes">${item.notes||''}</textarea></div>
      <button class="btn btn-primary btn-full" onclick="saveEditItem(${item.id})">SAVE CHANGES</button>`;
  }

  else if (type === 'customPart') {
    html = `<button class="modal-close" onclick="closeModal()">âœ•</button>
      <div class="modal-title">â• ADD CUSTOM PART</div>
      <div class="fg"><label>Part Name <span class="req">*</span></label><input type="text" id="customName" placeholder="e.g. Electronic ignition kit"></div>
      <div class="fg">
        <label>Category</label>
        <select id="customCategory">
          <option value="upgrade">Upgrades & Aftermarket</option>
          <option value="tool">Tools & Equipment</option>
          <option value="consumable">Consumables</option>
          <option value="other">General / Other</option>
        </select>
      </div>
      <div class="fg">
        <label>Source URL (optional)</label>
        <div style="display:flex;gap:8px">
          <input type="url" id="customUrl" placeholder="https://..." style="flex:1">
          <button class="btn btn-secondary btn-sm" id="fetchPriceBtn" onclick="fetchSourcePrice()">ğŸ” Fetch Price</button>
        </div>
      </div>
      <div class="row2">
        <div class="fg"><label>Source Price (EUR)</label><input type="number" id="customSourcePrice" placeholder="0.00" step="0.01"></div>
        <div class="fg"><label>My Asking Price (EUR)</label><input type="number" id="customPrice" placeholder="0.00" step="0.01"></div>
      </div>
      <div class="row2">
        <div class="fg"><label>Box <span class="req">*</span></label><input type="text" id="customBox" placeholder="Box number"></div>
        <div class="fg"><label>Qty</label><input type="number" id="customQty" value="1" min="1"></div>
      </div>
      <div class="fg">
        <label>Photo (optional)</label>
        <div class="photo-area" style="padding:16px" onclick="document.getElementById('customPhotoInput').click()">
          <div class="photo-placeholder"><div class="photo-icon" style="font-size:28px">ğŸ“·</div><div class="photo-label">Add photo</div></div>
        </div>
        <input type="file" id="customPhotoInput" accept="image/*">
      </div>
      <div class="fg"><label>Notes</label><textarea id="customNotes" placeholder="Optional notes..."></textarea></div>
      <button class="btn btn-primary btn-full" onclick="saveCustomPart()">SAVE CUSTOM PART</button>`;
  }

  else if (type === 'qrLabelItem') {
    const item = data;
    const qrData = `VOLVO-C3|${item.partNo}|${item.name}|BOX:${item.box}|QTY:${item.qty}`;
    html = `<button class="modal-close" onclick="closeModal()">âœ•</button>
      <div class="modal-title">ğŸ·ï¸ QR LABEL</div>
      <div class="label-preview">
        <div class="lp-name">${item.name}</div>
        <div class="lp-no">${item.partNo}</div>
        <div class="lp-detail">Box ${item.box} Â· Ã—${item.qty} Â· ${item.condition||'â€”'} Â· ${formatEur(item.askingPrice)}</div>
        <div class="lp-qr">${generateQRSVG(qrData, 120)}</div>
      </div>
      <div style="margin-top:14px;text-align:center;color:var(--muted);font-size:12px">Use your Niimbot app to print this label.<br>Screenshot and import into Niimbot, or connect via Bluetooth.</div>
      <button class="btn btn-secondary btn-full" style="margin-top:12px" onclick="printLabel()">ğŸ–¨ï¸ PRINT / SAVE LABEL</button>`;
  }

  else if (type === 'qrLabel') {
    html = `<button class="modal-close" onclick="closeModal()">âœ•</button>
      <div class="modal-title">ğŸ·ï¸ PRINT QR LABELS</div>
      <div style="font-size:13px;color:var(--text2);margin-bottom:14px">Select what to print labels for:</div>
      <div class="btn-group" style="flex-direction:column">
        <button class="btn btn-secondary" onclick="printAllBoxLabels()">ğŸ“¦ All Box Labels</button>
        <button class="btn btn-secondary" onclick="printAllPartLabels()">ğŸ”§ All Part Labels</button>
        <button class="btn btn-secondary" onclick="printListedLabels()">ğŸ“¢ Listed Parts Only</button>
      </div>`;
  }



  else if (type === 'confirmPriceRefresh') {
    const { item, newPrice, source } = data;
    html = `<button class="modal-close" onclick="closeModal()">âœ•</button>
      <div class="modal-title">â†» REFRESH PRICE</div>
      <div style="font-size:14px;font-weight:600;margin-bottom:12px">${item.name}</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px">
        <div style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:12px;text-align:center">
          <div style="font-family:'IBM Plex Mono',monospace;font-size:10px;color:var(--muted);margin-bottom:4px">CURRENT</div>
          <div style="font-family:'IBM Plex Mono',monospace;font-size:16px;color:var(--text)">${formatEur(item.askingPrice)}</div>
        </div>
        <div style="background:rgba(82,199,122,0.1);border:1px solid var(--green);border-radius:var(--radius);padding:12px;text-align:center">
          <div style="font-family:'IBM Plex Mono',monospace;font-size:10px;color:var(--muted);margin-bottom:4px">NEW (from ${source})</div>
          <div style="font-family:'IBM Plex Mono',monospace;font-size:16px;color:var(--green)">${formatEur(Math.round(newPrice*100)/100)}</div>
        </div>
      </div>
      <div class="btn-group">
        <button class="btn btn-secondary" style="flex:1" onclick="closeModal()">Keep Old</button>
        <button class="btn btn-primary" style="flex:1" onclick="applyRefreshedPrice(${item.id}, ${newPrice})">âœ“ USE NEW PRICE</button>
      </div>`;
  }

  else if (type === 'whatsappShare') {
    const { msg, item } = data;
    const hasPhoto = !!item.photo;
    html = `<button class="modal-close" onclick="closeModal()">âœ•</button>
      <div class="modal-title" style="color:#25D366">ğŸ’¬ SHARE ON WHATSAPP</div>
      <div style="background:var(--surface2);border:1px solid var(--border2);border-radius:var(--radius);padding:12px;margin-bottom:16px;font-size:13px;line-height:1.8;white-space:pre-wrap">${msg.replace(/\*/g,'<b>').replace(/\*/g,'</b>')}</div>
      ${hasPhoto ? `
      <div style="background:rgba(37,211,102,0.08);border:1px solid #25D366;border-radius:var(--radius);padding:10px;margin-bottom:14px;font-size:12px;color:#25D366">
        ğŸ“‹ Message copied to clipboard.<br>
        <span style="color:var(--text2)">In WhatsApp: choose contact â†’ tap the attachment button â†’ Photo â†’ paste message in text field.</span>
      </div>` : ''}
      <div class="btn-group">
        <button class="btn btn-secondary" style="flex:1" onclick="closeModal()">Cancel</button>
        <button class="btn btn-full" style="flex:2;background:#25D366;color:#000;font-family:'IBM Plex Mono',monospace;font-size:12px;font-weight:600" onclick="openWhatsApp(\`${encodeURIComponent(msg)}\`)">OPEN WHATSAPP â†’</button>
      </div>`;
  }

  body.innerHTML = html;
  document.getElementById('modalOverlay').classList.add('open');
}

function applyRefreshedPrice(id, price) {
  const item = INVENTORY.find(i => i.id === id);
  if (!item) return;
  item.askingPrice = Math.round(price * 100) / 100;
  item.priceRefreshedDate = new Date().toISOString();
  saveInventory();
  closeModal();
  renderInventory();
  showToast('Price updated to ' + formatEur(item.askingPrice), 'success');
}

function openWhatsApp(encodedMsg) {
  closeModal();
  window.location.href = 'whatsapp://send?text=' + encodedMsg;
}

function closeModal(e) {
  if (e && e.target !== document.getElementById('modalOverlay')) return;
  document.getElementById('modalOverlay').classList.remove('open');
}

function addFromCatalogue(partNo) {
  const part = (typeof PARTS_DB !== 'undefined') ? PARTS_DB.find(p => p.no === partNo) : null;
  if (!part) return;
  const tatankaItems = getTatankaData(partNo);
  selectedGuess = {
    name: part.name, sv: part.sv, no: part.no,
    group: part.g, confidence: 100, tatanka: tatankaItems
  };
  showScreen('identify');
  showStep(3);
  showConfirmStep();
}

function printLabel() {
  window.print();
}

function printAllBoxLabels() {
  const boxes = [...new Set(INVENTORY.filter(i=>i.status!=='sold'&&i.box).map(i=>i.box))];
  showToast('Feature: screenshot each box QR from the box summary', 'success');
  closeModal();
}

function printAllPartLabels() {
  showToast('Generating labels for all parts...', 'success');
  closeModal();
}

function printListedLabels() {
  showToast('Generating labels for listed parts...', 'success');
  closeModal();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API KEY MANAGEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function getApiKey() {
  return localStorage.getItem(API_KEY_STORAGE) || null;
}

function promptApiKey(callback) {
  const body = document.getElementById('modalBody');
  body.innerHTML = `
    <div class="modal-title">ğŸ”‘ API KEY REQUIRED</div>
    <div style="font-size:13px;color:var(--text2);margin-bottom:16px;line-height:1.6">
      Enter your Anthropic API key to enable photo identification.<br>
      It is stored only on this device and never shared.
    </div>
    <div class="fg">
      <label>Anthropic API Key</label>
      <input type="password" id="apiKeyInput" placeholder="sk-ant-..." autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false">
    </div>
    <div style="margin-top:4px;margin-bottom:16px">
      <a href="https://console.anthropic.com/keys" target="_blank" 
         style="font-family:'IBM Plex Mono',monospace;font-size:11px;color:var(--blue)">
        Get your key at console.anthropic.com â†’
      </a>
    </div>
    <div class="btn-group">
      <button class="btn btn-secondary" style="flex:1" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" style="flex:1" onclick="saveApiKey('${callback}')">SAVE & CONTINUE</button>
    </div>`;
  document.getElementById('modalOverlay').classList.add('open');
}

function saveApiKey(callback) {
  const val = document.getElementById('apiKeyInput').value.trim();
  if (!val || !val.startsWith('sk-')) {
    showToast('Invalid key â€” should start with sk-', 'error');
    return;
  }
  localStorage.setItem(API_KEY_STORAGE, val);
  closeModal();
  showToast('API key saved âœ“', 'success');
  updateApiKeyStatus();
  if (callback === 'analyze') analyzePhoto();
}

function clearApiKey() {
  localStorage.removeItem(API_KEY_STORAGE);
  showToast('API key cleared', 'success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function showToast(msg, type) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast show' + (type ? ' ' + type : '');
  setTimeout(() => t.className = 'toast', 3000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FLOATING ADD CUSTOM BUTTON
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Add custom part button in inventory screen header area
document.getElementById('screen-inventory').insertAdjacentHTML('afterbegin',
  `<div style="display:flex;gap:8px;margin-bottom:12px">
    <button class="btn btn-secondary btn-sm" onclick="openModal('customPart')">â• Custom Part</button>
    <button class="btn btn-secondary btn-sm" onclick="exportCatalogue('bulk')">ğŸ“„ Export</button>
  </div>`
);




// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REFRESH PRICE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function refreshItemPrice(id) {
  const item = INVENTORY.find(i => i.id === id);
  if (!item) return;

  const apiKey = getApiKey();
  if (!apiKey) { promptApiKey('none'); return; }

  showToast('Fetching current price...', '');

  try {
    let newPrice = null;
    let source = '';

    // Case 1: Custom part with source URL
    if (item.isCustom && item.sourceUrl) {
      const resp = await fetch(ANTHROPIC_API, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': apiKey,
          'anthropic-version': '2023-06-01',
          'anthropic-dangerous-direct-browser-access': 'true'
        },
        body: JSON.stringify({
          model: 'claude-haiku-4-5-20251001',
          max_tokens: 150,
          tools: [{ type: 'web_search_20250305', name: 'web_search' }],
          messages: [{
            role: 'user',
            content: 'Visit ' + item.sourceUrl + ' and find the current price in EUR. Return ONLY JSON: {"price":99.99,"currency":"EUR","name":"product name"}'
          }]
        })
      });
      if (!resp.ok) throw new Error('API ' + resp.status);
      const data = await resp.json();
      const text = (data.content||[]).map(b=>b.text||'').join('').replace(/```json|```/g,'').trim();
      const m = text.match(/\{[^}]+\}/);
      if (m) {
        const parsed = JSON.parse(m[0]);
        if (parsed.price) { newPrice = parseFloat(parsed.price); source = 'source URL'; }
      }
    }

    // Case 2: Tatanka part â€” re-fetch Tatanka page
    else if (item.partNo && !item.isCustom) {
      const tatankaItems = getTatankaData(item.partNo);
      const best = tatankaItems.find(t=>!t.is_used) || tatankaItems[0];
      if (best?.product_url) {
        const resp = await fetch(ANTHROPIC_API, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': apiKey,
            'anthropic-version': '2023-06-01',
            'anthropic-dangerous-direct-browser-access': 'true'
          },
          body: JSON.stringify({
            model: 'claude-haiku-4-5-20251001',
            max_tokens: 150,
            tools: [{ type: 'web_search_20250305', name: 'web_search' }],
            messages: [{
              role: 'user',
              content: 'Visit ' + best.product_url + ' and find the current price in SEK. Return ONLY JSON: {"price_sek":299,"stock":"in_stock"}'
            }]
          })
        });
        if (!resp.ok) throw new Error('API ' + resp.status);
        const data = await resp.json();
        const text = (data.content||[]).map(b=>b.text||'').join('').replace(/```json|```/g,'').trim();
        const m = text.match(/\{[^}]+\}/);
        if (m) {
          const parsed = JSON.parse(m[0]);
          if (parsed.price_sek) {
            const eur = sekToEur(parsed.price_sek);
            const isOut = parsed.stock === 'out_of_stock' || parsed.stock === 'temp_finished';
            const discount = isOut ? SETTINGS.discountOut : SETTINGS.discountIn;
            newPrice = Math.round(eur * (discount/100) * 100) / 100;
            source = 'Tatanka';
          }
        }
      }
    }

    // Case 3: Upgrade/aftermarket â€” web search for current price
    else {
      const resp = await fetch(ANTHROPIC_API, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': apiKey,
          'anthropic-version': '2023-06-01',
          'anthropic-dangerous-direct-browser-access': 'true'
        },
        body: JSON.stringify({
          model: 'claude-haiku-4-5-20251001',
          max_tokens: 150,
          tools: [{ type: 'web_search_20250305', name: 'web_search' }],
          messages: [{
            role: 'user',
            content: 'Search for current price of "' + item.name + '" Volvo C3 part. Return ONLY JSON: {"price_eur":29.99,"source":"shop name"} or {"price_eur":null} if not found.'
          }]
        })
      });
      if (!resp.ok) throw new Error('API ' + resp.status);
      const data = await resp.json();
      const text = (data.content||[]).map(b=>b.text||'').join('').replace(/```json|```/g,'').trim();
      const m = text.match(/\{[^}]+\}/);
      if (m) {
        const parsed = JSON.parse(m[0]);
        if (parsed.price_eur) { newPrice = parseFloat(parsed.price_eur) * 0.7; source = parsed.source || 'web'; }
      }
    }

    if (newPrice && newPrice > 0) {
      openModal('confirmPriceRefresh', { item, newPrice, source });
    } else {
      showToast('Could not find current price online', 'error');
    }

  } catch(e) {
    showToast('Price refresh failed: ' + e.message, 'error');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WHATSAPP SHARE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function shareWhatsApp(id) {
  const item = INVENTORY.find(i => i.id === id);
  if (!item) return;

  const condMap = { good: 'Good âœ…', fair: 'Fair âš ï¸', poor: 'Poor âŒ' };
  const cond = condMap[item.condition] || 'Not specified';
  const price = formatEur(item.askingPrice);
  const sek = item.askingPrice ? '(' + Math.round(item.askingPrice / SETTINGS.rate).toLocaleString() + ' SEK)' : '';

  const lines = [
    'ğŸ”§ *' + item.name + '*',
    item.partNo ? 'Part no: ' + item.partNo : '',
    'Condition: ' + cond,
    '',
    'ğŸ’¶ Asking price: *' + price + '* ' + sek,
    item.notes ? '\nNotes: ' + item.notes : '',
  ].filter(l => l !== null && l !== undefined);

  const msg = lines.join('\n').trim();

  if (item.photo) {
    // Copy message to clipboard and open WhatsApp
    // User needs to paste the message â€” WhatsApp URL scheme can't attach photos
    navigator.clipboard.writeText(msg).then(() => {
      openModal('whatsappShare', { msg, item });
    }).catch(() => {
      // Fallback if clipboard not available
      openModal('whatsappShare', { msg, item });
    });
  } else {
    // No photo â€” open WhatsApp directly with pre-filled message
    const url = 'whatsapp://send?text=' + encodeURIComponent(msg);
    window.open(url, '_blank');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BULK MODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let bulkQueue = []; // [{id, photo, status:'pending'|'analyzing'|'done'|'error', result}]

document.addEventListener('DOMContentLoaded', () => {
  const bc = document.getElementById('bulkCameraInput');
  const bg = document.getElementById('bulkGalleryInput');
  if (bc) bc.addEventListener('change', e => addToBulkQueue(e.target.files));
  if (bg) bg.addEventListener('change', e => addToBulkQueue(e.target.files));
});

async function addToBulkQueue(files) {
  if (!files || files.length === 0) return;
  for (const file of files) {
    const compressed = await compressImage(file, 1000, 0.8);
    bulkQueue.push({
      id: Date.now() + Math.random(),
      photo: compressed.b64,
      dataUrl: compressed.dataUrl,
      status: 'pending',
      result: null,
      box: '',
      qty: 1,
      price: '',
      condition: ''
    });
  }
  renderBulkQueue();
  document.getElementById('bulkAnalyzeBtn').disabled = false;
  document.getElementById('bulkCount').textContent = bulkQueue.length + ' queued';
  // Flash the photo area
  const area = document.getElementById('bulkPhotoArea');
  area.classList.add('has-photo');
  area.innerHTML = `<img src="${bulkQueue[bulkQueue.length-1].dataUrl}" alt="">`;
  setTimeout(() => {
    area.classList.remove('has-photo');
    area.innerHTML = `<div class="photo-placeholder"><div class="photo-icon">ğŸ“·</div><div class="photo-label">TAP TO ADD MORE</div><div class="photo-sublabel">${bulkQueue.length} photo${bulkQueue.length>1?'s':''} queued</div></div>`;
    area.onclick = () => document.getElementById('bulkCameraInput').click();
  }, 800);
}

function renderBulkQueue() {
  const el = document.getElementById('bulkQueue');
  if (bulkQueue.length === 0) { el.innerHTML = ''; return; }
  el.innerHTML = bulkQueue.map((item, i) => {
    const icon = item.status === 'pending' ? 'â³' : item.status === 'analyzing' ? 'ğŸ”' : item.status === 'done' ? 'âœ…' : 'âŒ';
    const name = item.result ? item.result[0]?.name || 'â€”' : item.status === 'analyzing' ? 'Analyzing...' : 'Pending';
    return `<div style="display:flex;align-items:center;gap:10px;padding:8px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:6px">
      <img src="${item.dataUrl}" style="width:44px;height:44px;border-radius:5px;object-fit:cover;flex-shrink:0">
      <div style="flex:1;min-width:0">
        <div style="font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${icon} ${name}</div>
        <div style="font-family:'IBM Plex Mono',monospace;font-size:10px;color:var(--muted)">Photo ${i+1}</div>
      </div>
      <button onclick="removeBulkItem(${i})" style="background:none;border:none;color:var(--muted);font-size:16px;cursor:pointer;padding:4px">âœ•</button>
    </div>`;
  }).join('');
}

function removeBulkItem(i) {
  bulkQueue.splice(i, 1);
  renderBulkQueue();
  document.getElementById('bulkCount').textContent = bulkQueue.length + ' queued';
  if (bulkQueue.length === 0) document.getElementById('bulkAnalyzeBtn').disabled = true;
}

async function analyzeBulkQueue() {
  const apiKey = getApiKey();
  if (!apiKey) { promptApiKey('none'); return; }

  const pending = bulkQueue.filter(i => i.status === 'pending');
  if (pending.length === 0) { showToast('Nothing to analyze', 'error'); return; }

  document.getElementById('bulkAnalyzeBtn').disabled = true;
  document.getElementById('bulkAnalyzeBtn').textContent = 'â³ Analyzing...';
  showToast('Analyzing ' + pending.length + ' parts in parallel...', 'success');

  // Fire all API calls simultaneously
  const promises = pending.map(item => analyzeSingleBulkItem(item, apiKey));
  await Promise.allSettled(promises);

  document.getElementById('bulkAnalyzeBtn').textContent = 'ğŸ” ANALYZE ALL';
  renderBulkQueue();
  renderBulkReview();
  document.getElementById('bulkReview').style.display = 'block';
  showToast('Analysis complete!', 'success');
}

async function analyzeSingleBulkItem(item, apiKey) {
  item.status = 'analyzing';
  renderBulkQueue();

  try {
    // Try OCR first
    const ocr = await detectPartNumber(item.photo, '');
    if (ocr) {
      item.result = [ocr];
      item.status = 'done';
      if (ocr.tatanka) {
        const suggested = getSuggestedPrice(ocr.tatanka);
        if (suggested) item.price = suggested.toFixed(2);
      }
      return;
    }

    // Full AI analysis
    const prompt = `You are an expert on Volvo C3 military vehicles (C303, C304, C306, TGB 11/13/20).
First read any text or part numbers visible in the image, then identify the part.
Return ONLY a JSON array of 1 best guess: [{"name":"English name","sv":"Swedish name","no":"part number","group":"group number","confidence":85,"reason":"one sentence, mention any part numbers read from image"}]`;

    const resp = await fetch(ANTHROPIC_API, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-haiku-4-5-20251001',
        max_tokens: 300,
        messages: [{
          role: 'user',
          content: [
            { type: 'image', source: { type: 'base64', media_type: 'image/jpeg', data: item.photo } },
            { type: 'text', text: prompt }
          ]
        }]
      })
    });

    if (!resp.ok) throw new Error('API ' + resp.status);
    const data = await resp.json();
    let text = (data.content||[]).map(b=>b.text||'').join('').replace(/```json|```/g,'').trim();
    const m = text.match(/\[\s*\{[\s\S]*?\}\s*\]/);
    if (!m) throw new Error('No JSON');
    let guesses = JSON.parse(m[0]);
    // Enrich with PARTS_DB and Tatanka
    guesses = guesses.map(g => {
      const dbMatch = typeof PARTS_DB !== 'undefined' ?
        PARTS_DB.find(p => p.no === g.no || p.no.split('-')[0] === g.no.split('-')[0]) : null;
      if (dbMatch) { g.name = g.name||dbMatch.name; g.sv = g.sv||dbMatch.sv; g.no = g.no||dbMatch.no; }
      g.tatanka = getTatankaData(g.no);
      return g;
    });
    item.result = guesses;
    item.status = 'done';
    // Auto-suggest price
    if (guesses[0]?.tatanka) {
      const suggested = getSuggestedPrice(guesses[0].tatanka);
      if (suggested) item.price = suggested.toFixed(2);
    }
  } catch(e) {
    item.status = 'error';
    item.errorMsg = e.message;
  }
}

function renderBulkReview() {
  const el = document.getElementById('bulkReviewList');
  const done = bulkQueue.filter(i => i.status === 'done' && i.result);
  if (done.length === 0) { el.innerHTML = '<div style="color:var(--muted);font-size:13px">No results yet.</div>'; return; }

  el.innerHTML = done.map((item, i) => {
    const g = item.result[0];
    const thumb = g?.tatanka?.[0]?.image_local ?
      `<img src="${g.tatanka[0].image_local}" style="width:48px;height:48px;border-radius:5px;object-fit:cover;border:1px solid var(--border)">` :
      `<img src="${item.dataUrl}" style="width:48px;height:48px;border-radius:5px;object-fit:cover;border:1px solid var(--border)">`;
    return `<div style="border:1px solid var(--border);border-radius:var(--radius);padding:10px;margin-bottom:10px;background:var(--surface2)">
      <div style="display:flex;gap:10px;align-items:flex-start;margin-bottom:8px">
        ${thumb}
        <div style="flex:1;min-width:0">
          <div style="font-size:13px;font-weight:600">${g?.name||'Unknown'}</div>
          <div style="font-family:'IBM Plex Mono',monospace;font-size:11px;color:var(--accent)">${g?.no||'â€”'}</div>
          <div style="font-size:11px;color:var(--muted)">${g?.reason||''}</div>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px">
        <div><label style="font-family:'IBM Plex Mono',monospace;font-size:9px;color:var(--muted);display:block;margin-bottom:3px">BOX *</label>
          <input type="text" placeholder="Box #" value="${item.box}" oninput="bulkQueue.filter(x=>x.status==='done')[${i}].box=this.value" style="padding:6px 8px;font-size:14px"></div>
        <div><label style="font-family:'IBM Plex Mono',monospace;font-size:9px;color:var(--muted);display:block;margin-bottom:3px">QTY</label>
          <input type="number" value="${item.qty||1}" min="1" oninput="bulkQueue.filter(x=>x.status==='done')[${i}].qty=parseInt(this.value)||1" style="padding:6px 8px;font-size:14px"></div>
        <div><label style="font-family:'IBM Plex Mono',monospace;font-size:9px;color:var(--muted);display:block;margin-bottom:3px">PRICE EUR</label>
          <input type="number" value="${item.price||''}" placeholder="0.00" step="0.01" oninput="bulkQueue.filter(x=>x.status==='done')[${i}].price=this.value" style="padding:6px 8px;font-size:14px"></div>
      </div>
    </div>`;
  }).join('');
}

async function saveAllBulk() {
  const done = bulkQueue.filter(i => i.status === 'done' && i.result);
  const missing = done.filter(i => !i.box);
  if (missing.length > 0) { showToast('Fill in box numbers for all parts', 'error'); return; }

  let saved = 0;
  for (const item of done) {
    const g = item.result[0];
    INVENTORY.push({
      id: Date.now() + Math.random(),
      partNo: g?.no || '',
      name: g?.name || 'Unknown',
      nameSv: g?.sv || '',
      group: g?.group || '',
      box: item.box,
      qty: item.qty || 1,
      condition: item.condition || null,
      askingPrice: parseFloat(item.price) || 0,
      photo: item.dataUrl,
      status: 'available',
      addedDate: new Date().toISOString(),
      isCustom: false,
      isUnknown: false,
    });
    saved++;
  }
  saveInventory();
  bulkQueue = [];
  renderBulkQueue();
  document.getElementById('bulkReview').style.display = 'none';
  document.getElementById('bulkAnalyzeBtn').disabled = true;
  document.getElementById('bulkCount').textContent = '0 queued';
  showToast(saved + ' parts saved to inventory!', 'success');
  showScreen('inventory');
}



// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REFRESH PRICE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Load PARTS_DB â€” try immediately, then on DOMContentLoaded, then on load
// This handles all timing scenarios across browsers and PWA modes
function tryLoadPartsDB() {
  if (typeof window.PARTS_DB_DATA !== 'undefined' && window.PARTS_DB_DATA.length > 0) {
    PARTS_DB = window.PARTS_DB_DATA;
    console.log('PARTS_DB loaded:', PARTS_DB.length, 'parts');
    return true;
  }
  return false;
}

function bootApp() {
  tryLoadPartsDB();
  init();
  // Re-check after a short delay in case PARTS_DB.js loaded late
  setTimeout(() => {
    if (PARTS_DB.length === 0 && tryLoadPartsDB()) {
      console.log('PARTS_DB late-loaded, refreshing UI');
      renderCatalogue();
      updateHeaderStats();
    }
  }, 500);
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', bootApp);
} else {
  bootApp();
}
</script>

<!-- PARTS_DB.js should be included here -->
<script src="PARTS_DB.js"></script>

</body>
</html>
