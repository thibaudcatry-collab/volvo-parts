<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Volvo Parts">
<meta name="theme-color" content="0d0d0d">
<title>Volvo C3 Parts</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=IBM+Plex+Mono:wght@400;500;600&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0d0d0d;
  --surface: #161616;
  --surface2: #1e1e1e;
  --surface3: #252525;
  --border: #2a2a2a;
  --border2: #333;
  --accent: #e8b84b;
  --accent2: #c97b2e;
  --text: #ebebeb;
  --text2: #aaa;
  --muted: #666;
  --red: #e05252;
  --green: #52c77a;
  --blue: #5299e0;
  --orange: #e87b3a;
  --radius: 8px;
  --header-h: 56px;
  --nav-h: 60px;
}
* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
html, body { height: 100%; overflow: hidden; }
body {
  font-family: 'IBM Plex Sans', sans-serif;
  background: var(--bg);
  color: var(--text);
  font-size: 14px;
  overscroll-behavior: none;
}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
.app-header {
  position: fixed; top: 0; left: 0; right: 0;
  height: var(--header-h);
  background: var(--surface);
  border-bottom: 2px solid var(--accent);
  display: flex; align-items: center;
  padding: 0 16px; gap: 12px;
  z-index: 200;
}
.logo { font-family: 'Bebas Neue', sans-serif; font-size: 24px; color: var(--accent); letter-spacing: 3px; }
.logo span { font-size: 13px; color: var(--muted); font-family: 'IBM Plex Mono', monospace; letter-spacing: 1px; display: block; margin-top: -4px; }
.header-stats { margin-left: auto; text-align: right; font-family: 'IBM Plex Mono', monospace; font-size: 10px; color: var(--muted); line-height: 1.6; }
.header-stats b { color: var(--accent); }

/* ‚îÄ‚îÄ BOTTOM NAV ‚îÄ‚îÄ */
.bottom-nav {
  position: fixed; bottom: 0; left: 0; right: 0;
  height: var(--nav-h);
  background: var(--surface);
  border-top: 1px solid var(--border);
  display: flex;
  z-index: 200;
  padding-bottom: env(safe-area-inset-bottom);
}
.nav-btn {
  flex: 1; display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  gap: 4px; cursor: pointer;
  font-family: 'IBM Plex Mono', monospace;
  font-size: 9px; color: var(--muted);
  letter-spacing: 0.5px; text-transform: uppercase;
  transition: color 0.2s; border: none; background: none;
  padding: 8px 4px;
}
.nav-btn .nav-icon { font-size: 20px; transition: transform 0.2s; }
.nav-btn.active { color: var(--accent); }
.nav-btn.active .nav-icon { transform: translateY(-2px); }
.nav-btn:hover { color: var(--text2); }

/* ‚îÄ‚îÄ MAIN SCROLL AREA ‚îÄ‚îÄ */
.main {
  position: fixed;
  top: var(--header-h);
  bottom: var(--nav-h);
  left: 0; right: 0;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}
.screen { display: none; min-height: 100%; padding: 14px 14px 20px; max-width: 680px; margin: 0 auto; }
.screen.active { display: block; }

/* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 14px;
  margin-bottom: 12px;
}
.card-title {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 15px; color: var(--accent);
  letter-spacing: 1.5px; margin-bottom: 12px;
  display: flex; align-items: center; gap: 8px;
}
.card-title .ct-icon { font-size: 16px; }

/* ‚îÄ‚îÄ FORMS ‚îÄ‚îÄ */
.fg { margin-bottom: 11px; }
.fg label {
  display: block;
  font-family: 'IBM Plex Mono', monospace;
  font-size: 10px; color: var(--muted);
  margin-bottom: 4px; letter-spacing: 0.5px;
  text-transform: uppercase;
}
.fg label .req { color: var(--accent); }
input, select, textarea {
  width: 100%;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text);
  padding: 10px 12px;
  font-family: 'IBM Plex Sans', sans-serif;
  font-size: 14px;
  transition: border-color 0.2s;
  outline: none;
  -webkit-appearance: none;
}
input:focus, select:focus, textarea:focus { border-color: var(--accent); }
select option { background: var(--surface2); }
textarea { resize: vertical; min-height: 70px; }
.row2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.row3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn {
  display: inline-flex; align-items: center; justify-content: center; gap: 6px;
  padding: 10px 18px; border-radius: var(--radius);
  font-family: 'IBM Plex Mono', monospace;
  font-size: 12px; font-weight: 600;
  cursor: pointer; border: none;
  transition: all 0.2s; letter-spacing: 0.5px;
  white-space: nowrap;
}
.btn-primary { background: var(--accent); color: #000; }
.btn-primary:hover { background: var(--accent2); }
.btn-primary:disabled { background: var(--border2); color: var(--muted); cursor: not-allowed; }
.btn-secondary { background: var(--surface2); color: var(--text); border: 1px solid var(--border2); }
.btn-secondary:hover { border-color: var(--accent); color: var(--accent); }
.btn-danger { background: transparent; color: var(--red); border: 1px solid var(--red); }
.btn-danger:hover { background: var(--red); color: #fff; }
.btn-success { background: var(--green); color: #000; }
.btn-full { width: 100%; }
.btn-sm { padding: 6px 12px; font-size: 11px; }
.btn-xs { padding: 4px 8px; font-size: 10px; }
.btn-group { display: flex; gap: 8px; flex-wrap: wrap; }

/* ‚îÄ‚îÄ BADGES ‚îÄ‚îÄ */
.badge {
  display: inline-flex; align-items: center; gap: 3px;
  padding: 2px 7px; border-radius: 20px;
  font-family: 'IBM Plex Mono', monospace;
  font-size: 10px; font-weight: 600; letter-spacing: 0.3px;
}
.badge-green { background: rgba(82,199,122,0.15); color: var(--green); border: 1px solid rgba(82,199,122,0.3); }
.badge-yellow { background: rgba(232,184,75,0.15); color: var(--accent); border: 1px solid rgba(232,184,75,0.3); }
.badge-red { background: rgba(224,82,82,0.15); color: var(--red); border: 1px solid rgba(224,82,82,0.3); }
.badge-blue { background: rgba(82,153,224,0.15); color: var(--blue); border: 1px solid rgba(82,153,224,0.3); }
.badge-orange { background: rgba(232,123,58,0.15); color: var(--orange); border: 1px solid rgba(232,123,58,0.3); }
.badge-muted { background: var(--surface2); color: var(--muted); border: 1px solid var(--border); }

/* ‚îÄ‚îÄ PHOTO AREA ‚îÄ‚îÄ */
.photo-area {
  border: 2px dashed var(--border2);
  border-radius: var(--radius);
  padding: 32px 16px;
  text-align: center; cursor: pointer;
  transition: all 0.2s; background: var(--surface2);
  position: relative; overflow: hidden;
}
.photo-area:hover { border-color: var(--accent); }
.photo-area.has-photo { padding: 0; border-style: solid; border-color: var(--accent); }
.photo-area img { width: 100%; max-height: 280px; object-fit: cover; border-radius: 6px; display: block; }
.photo-placeholder { display: flex; flex-direction: column; align-items: center; gap: 8px; color: var(--muted); }
.photo-icon { font-size: 48px; }
.photo-label { font-family: 'IBM Plex Mono', monospace; font-size: 11px; letter-spacing: 0.5px; }
.photo-sublabel { font-size: 11px; color: var(--muted); opacity: 0.7; }
#cameraInput, #galleryInput, #customPhotoInput { display: none; }

/* ‚îÄ‚îÄ STEP INDICATOR ‚îÄ‚îÄ */
.steps { display: flex; align-items: center; gap: 0; margin-bottom: 16px; }
.step {
  flex: 1; text-align: center;
  font-family: 'IBM Plex Mono', monospace;
  font-size: 10px; color: var(--muted);
  letter-spacing: 0.5px;
  padding: 8px 4px;
  border-bottom: 2px solid var(--border);
  transition: all 0.2s;
}
.step.active { color: var(--accent); border-bottom-color: var(--accent); }
.step.done { color: var(--green); border-bottom-color: var(--green); }
.step-num {
  display: block;
  font-size: 16px; font-weight: 600;
  margin-bottom: 2px;
}

/* ‚îÄ‚îÄ GUESS CARDS ‚îÄ‚îÄ */
.guess-card {
  background: var(--surface2);
  border: 1px solid var(--border2);
  border-radius: var(--radius);
  padding: 12px; margin-bottom: 8px;
  cursor: pointer; transition: all 0.2s;
  display: flex; gap: 12px; align-items: flex-start;
}
.guess-card:hover { border-color: var(--accent); background: var(--surface3); }
.guess-card.selected { border-color: var(--accent); background: rgba(232,184,75,0.08); }
.guess-thumb { width: 64px; height: 64px; border-radius: 6px; object-fit: cover; background: var(--surface3); flex-shrink: 0; border: 1px solid var(--border); }
.guess-thumb-placeholder { width: 64px; height: 64px; border-radius: 6px; background: var(--surface3); flex-shrink: 0; border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 24px; color: var(--muted); }
.guess-info { flex: 1; min-width: 0; }
.guess-rank { font-family: 'IBM Plex Mono', monospace; font-size: 9px; color: var(--accent); letter-spacing: 1px; margin-bottom: 3px; }
.guess-name { font-size: 14px; font-weight: 600; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.guess-no { font-family: 'IBM Plex Mono', monospace; font-size: 11px; color: var(--accent); margin-bottom: 4px; }
.guess-desc { font-size: 12px; color: var(--text2); line-height: 1.4; }
.guess-price { font-family: 'IBM Plex Mono', monospace; font-size: 11px; color: var(--green); margin-top: 4px; }
.guess-meta { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 5px; }
.conf-bar-wrap { display: flex; align-items: center; gap: 8px; margin-top: 5px; }
.conf-bar { flex: 1; height: 3px; background: var(--border); border-radius: 2px; overflow: hidden; }
.conf-fill { height: 100%; border-radius: 2px; transition: width 0.6s ease; }

/* ‚îÄ‚îÄ INVENTORY LIST ‚îÄ‚îÄ */
.inv-item {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 12px; margin-bottom: 8px;
  transition: border-color 0.2s;
}
.inv-item:hover { border-color: var(--border2); }
.inv-item-header { display: flex; align-items: flex-start; gap: 10px; }
.inv-thumb { width: 52px; height: 52px; border-radius: 6px; object-fit: cover; background: var(--surface2); flex-shrink: 0; border: 1px solid var(--border); cursor: pointer; }
.inv-thumb-ph { width: 52px; height: 52px; border-radius: 6px; background: var(--surface2); flex-shrink: 0; border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 20px; color: var(--muted); cursor: pointer; }
.inv-info { flex: 1; min-width: 0; }
.inv-name { font-size: 14px; font-weight: 600; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.inv-no { font-family: 'IBM Plex Mono', monospace; font-size: 11px; color: var(--accent); }
.inv-meta { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 5px; }
.inv-actions { display: flex; gap: 6px; margin-top: 10px; flex-wrap: wrap; }
.inv-price-row { display: flex; align-items: center; gap: 8px; margin-top: 6px; font-family: 'IBM Plex Mono', monospace; font-size: 11px; }
.inv-asking { color: var(--green); font-weight: 600; }
.inv-ref { color: var(--muted); }

/* ‚îÄ‚îÄ SEARCH BAR ‚îÄ‚îÄ */
.search-wrap { position: relative; margin-bottom: 12px; }
.search-wrap input { padding-left: 36px; }
.search-icon { position: absolute; left: 11px; top: 50%; transform: translateY(-50%); color: var(--muted); font-size: 16px; pointer-events: none; }

/* ‚îÄ‚îÄ FILTER CHIPS ‚îÄ‚îÄ */
.filter-chips { display: flex; gap: 6px; overflow-x: auto; padding-bottom: 4px; margin-bottom: 12px; scrollbar-width: none; }
.filter-chips::-webkit-scrollbar { display: none; }
.chip {
  flex-shrink: 0; padding: 5px 12px;
  border-radius: 20px; cursor: pointer;
  font-family: 'IBM Plex Mono', monospace;
  font-size: 10px; letter-spacing: 0.3px;
  border: 1px solid var(--border2);
  background: var(--surface2); color: var(--muted);
  transition: all 0.2s; white-space: nowrap;
}
.chip.active { background: rgba(232,184,75,0.15); color: var(--accent); border-color: rgba(232,184,75,0.4); }
.chip:hover { border-color: var(--accent); color: var(--text2); }

/* ‚îÄ‚îÄ TATANKA PANEL ‚îÄ‚îÄ */
.tatanka-panel {
  background: var(--surface2);
  border: 1px solid var(--border2);
  border-radius: var(--radius);
  padding: 12px; margin-top: 10px;
}
.tatanka-header { font-family: 'IBM Plex Mono', monospace; font-size: 10px; color: var(--muted); letter-spacing: 1px; margin-bottom: 8px; display: flex; align-items: center; gap: 6px; }
.tatanka-row {
  display: flex; align-items: center; gap: 10px;
  padding: 8px 0; border-bottom: 1px solid var(--border);
}
.tatanka-row:last-child { border-bottom: none; }
.tatanka-img { width: 48px; height: 48px; border-radius: 5px; object-fit: cover; background: var(--surface3); border: 1px solid var(--border); flex-shrink: 0; }
.tatanka-img-ph { width: 48px; height: 48px; border-radius: 5px; background: var(--surface3); border: 1px solid var(--border); flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 18px; color: var(--muted); }
.tatanka-info { flex: 1; min-width: 0; }
.tatanka-name { font-size: 12px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.tatanka-price { font-family: 'IBM Plex Mono', monospace; font-size: 12px; color: var(--green); }
.tatanka-sek { font-size: 10px; color: var(--muted); }
.tatanka-link { font-family: 'IBM Plex Mono', monospace; font-size: 10px; color: var(--blue); text-decoration: none; flex-shrink: 0; }
.tatanka-link:hover { text-decoration: underline; }

/* ‚îÄ‚îÄ DIAGRAM VIEWER MODAL ‚îÄ‚îÄ */
.diagram-modal {
  display: none; position: fixed; inset: 0; z-index: 9000;
  background: #0a0a0a;
  flex-direction: column;
}
.diagram-modal.open { display: flex; }
.diagram-modal-header {
  display: flex; align-items: center; gap: 10px;
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
  background: var(--surface);
  flex-shrink: 0;
}
.diagram-modal-title { flex: 1; font-size: 13px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.diagram-modal-sub { font-family: 'IBM Plex Mono', monospace; font-size: 10px; color: var(--muted); }
.diagram-modal-close { background: none; border: none; color: var(--text); font-size: 22px; cursor: pointer; padding: 0 4px; }

/* Tab bar */
.dv-tabs {
  display: flex; gap: 0;
  background: var(--surface2);
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}
.dv-tab {
  flex: 1; padding: 10px 8px; text-align: center;
  font-family: 'IBM Plex Mono', monospace; font-size: 10px; letter-spacing: 0.5px;
  color: var(--muted); cursor: pointer; border: none; background: none;
  border-bottom: 2px solid transparent;
  transition: all 0.15s;
}
.dv-tab.active { color: var(--accent); border-bottom-color: var(--accent); background: var(--surface); }
.dv-tab:disabled { opacity: 0.3; cursor: not-allowed; }

/* Main view area */
.dv-content { flex: 1; overflow: hidden; position: relative; }
.dv-pane { display: none; height: 100%; flex-direction: column; }
.dv-pane.active { display: flex; }

/* My Photos pane */
.dv-myphotos-main {
  flex: 1; overflow: hidden; position: relative;
  display: flex; align-items: center; justify-content: center;
  background: #000;
}
.dv-myphotos-main img {
  max-width: 100%; max-height: 100%; object-fit: contain;
  touch-action: pinch-zoom;
}
.dv-photo-strip {
  display: flex; gap: 6px; padding: 8px 12px;
  overflow-x: auto; background: var(--surface);
  border-top: 1px solid var(--border);
  flex-shrink: 0; scroll-snap-type: x mandatory;
}
.dv-photo-thumb {
  width: 56px; height: 56px; border-radius: 6px;
  object-fit: cover; flex-shrink: 0; cursor: pointer;
  border: 2px solid transparent; scroll-snap-align: start;
  transition: border-color 0.15s;
}
.dv-photo-thumb.active-thumb { border-color: var(--accent); }
.dv-photo-thumb.default-thumb::after { content: '‚òÖ'; }
.dv-star-badge {
  position: absolute; top: 8px; right: 8px;
  background: var(--accent); color: #000;
  font-size: 10px; font-weight: 700; padding: 3px 7px; border-radius: 10px;
}
.dv-set-default-btn {
  position: absolute; bottom: 72px; right: 12px;
  background: var(--surface); border: 1px solid var(--border2);
  color: var(--text2); font-size: 11px; padding: 6px 12px; border-radius: 6px;
  cursor: pointer;
}

/* Tatanka pane */
.dv-tatanka-list {
  flex: 1; overflow-y: auto; padding: 12px;
  display: flex; flex-direction: column; gap: 10px;
}
.dv-tatanka-card {
  background: var(--surface2); border-radius: 8px;
  border: 1px solid var(--border);
  overflow: hidden; display: flex; gap: 0;
}
.dv-tatanka-card img { width: 100px; height: 100px; object-fit: cover; flex-shrink: 0; }
.dv-tatanka-card-ph { width: 100px; height: 100px; flex-shrink: 0; background: var(--surface3); display:flex; align-items:center; justify-content:center; font-size:32px; }
.dv-tatanka-info { padding: 10px 12px; flex: 1; display: flex; flex-direction: column; gap: 4px; }
.dv-tatanka-name { font-size: 12px; font-weight: 600; }
.dv-tatanka-price { font-family: 'IBM Plex Mono', monospace; font-size: 14px; color: var(--green); font-weight: 600; }
.dv-tatanka-meta { font-size: 11px; color: var(--muted); }

/* Diagram pane */
.dv-diagram-wrap {
  flex: 1; overflow: hidden; position: relative;
  background: #fff;
  display: flex; align-items: center; justify-content: center;
}
.dv-diagram-canvas {
  max-width: 100%; max-height: 100%;
  touch-action: pinch-zoom;
}
.dv-occurrence-strip {
  display: flex; gap: 6px; padding: 8px 12px;
  overflow-x: auto; background: var(--surface);
  border-top: 1px solid var(--border);
  flex-shrink: 0; align-items: center;
}
.dv-occurrence-chip {
  display: flex; align-items: center; gap: 4px;
  background: var(--surface2); border: 1px solid var(--border2);
  border-radius: 16px; padding: 4px 10px;
  font-family: 'IBM Plex Mono', monospace; font-size: 10px;
  cursor: pointer; flex-shrink: 0; transition: all 0.15s;
  white-space: nowrap;
}
.dv-occurrence-chip.active { background: var(--accent); border-color: var(--accent); color: #000; }
.dv-occurrence-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent); }
.dv-occurrence-chip.active .dv-occurrence-dot { background: #000; }
.dv-many-label {
  font-size: 11px; color: var(--muted); font-family: 'IBM Plex Mono', monospace;
  padding: 4px 12px;
}

/* Zoom panel (appears over diagram) */
.dv-zoom-panel {
  position: absolute; bottom: 8px; left: 8px;
  width: 180px; background: #fff;
  border: 3px solid var(--accent); border-radius: 8px;
  overflow: hidden; display: none;
  box-shadow: 0 4px 20px rgba(0,0,0,0.5);
}
.dv-zoom-panel-label {
  background: var(--accent); color: #000;
  font-family: 'IBM Plex Mono', monospace; font-size: 9px; font-weight: 600;
  padding: 2px 8px; letter-spacing: 0.5px;
}
.dv-zoom-panel canvas { display: block; width: 100%; }

/* Photo default prompt modal */
.photo-default-modal {
  display: none; position: fixed; inset: 0; z-index: 9500;
  background: rgba(0,0,0,0.85);
  align-items: center; justify-content: center; padding: 20px;
}
.photo-default-card {
  background: var(--surface); border-radius: 12px;
  border: 1px solid var(--border2); padding: 20px;
  width: 100%; max-width: 360px;
  display: flex; flex-direction: column; gap: 14px;
}
.photo-default-preview { width: 100%; height: 200px; object-fit: cover; border-radius: 8px; border: 1px solid var(--border); }
.photo-default-title { font-size: 15px; font-weight: 600; }
.photo-default-sub { font-size: 12px; color: var(--muted); }
.photo-default-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.modal-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.85);
  z-index: 500; display: none;
  align-items: flex-end; justify-content: center;
  padding: 0;
}
.modal-overlay.open { display: flex; }
.modal {
  background: var(--surface);
  border: 1px solid var(--border2);
  border-radius: 16px 16px 0 0;
  width: 100%; max-width: 680px;
  max-height: 92vh;
  overflow-y: auto;
  padding: 20px 16px;
  padding-bottom: calc(20px + env(safe-area-inset-bottom));
  animation: slideUp 0.3s ease;
}
@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
.modal-handle { width: 36px; height: 4px; background: var(--border2); border-radius: 2px; margin: 0 auto 16px; }
.modal-title { font-family: 'Bebas Neue', sans-serif; font-size: 20px; color: var(--accent); letter-spacing: 2px; margin-bottom: 16px; }
.modal-close { float: right; background: none; border: none; color: var(--muted); font-size: 20px; cursor: pointer; padding: 0 4px; }
.modal-close:hover { color: var(--text); }

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
.toast {
  position: fixed; bottom: calc(var(--nav-h) + 12px); left: 50%;
  transform: translateX(-50%) translateY(20px);
  background: var(--surface3); color: var(--text);
  border: 1px solid var(--border2);
  padding: 10px 20px; border-radius: 24px;
  font-family: 'IBM Plex Mono', monospace;
  font-size: 12px; z-index: 999;
  opacity: 0; transition: all 0.3s;
  white-space: nowrap; pointer-events: none;
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
.toast.success { border-color: var(--green); color: var(--green); }
.toast.error { border-color: var(--red); color: var(--red); }

/* ‚îÄ‚îÄ DIVIDER ‚îÄ‚îÄ */
.divider { height: 1px; background: var(--border); margin: 14px 0; }

/* ‚îÄ‚îÄ STATS GRID ‚îÄ‚îÄ */
.stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 12px; }
.stat-box { background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius); padding: 12px; text-align: center; }
.stat-val { font-family: 'Bebas Neue', sans-serif; font-size: 28px; color: var(--accent); letter-spacing: 1px; line-height: 1; }
.stat-label { font-family: 'IBM Plex Mono', monospace; font-size: 9px; color: var(--muted); letter-spacing: 0.5px; margin-top: 3px; }

/* ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ */
.empty { text-align: center; padding: 48px 20px; color: var(--muted); }
.empty-icon { font-size: 52px; margin-bottom: 12px; }
.empty-title { font-family: 'Bebas Neue', sans-serif; font-size: 22px; color: var(--text2); letter-spacing: 2px; margin-bottom: 6px; }
.empty-text { font-size: 13px; line-height: 1.6; }

/* ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ */
.spinner { display: inline-block; width: 20px; height: 20px; border: 2px solid var(--border2); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.7s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
.loading-state { display: flex; flex-direction: column; align-items: center; gap: 12px; padding: 32px; color: var(--muted); font-family: 'IBM Plex Mono', monospace; font-size: 12px; }

/* ‚îÄ‚îÄ UNKNOWN PILE ‚îÄ‚îÄ */
.unknown-item { background: var(--surface); border: 1px solid var(--orange); border-radius: var(--radius); padding: 12px; margin-bottom: 8px; }
.unknown-header { display: flex; align-items: center; gap: 10px; }
.unknown-thumb { width: 52px; height: 52px; border-radius: 6px; object-fit: cover; background: var(--surface2); flex-shrink: 0; border: 1px solid var(--orange); }

/* ‚îÄ‚îÄ BOX SUMMARY ‚îÄ‚îÄ */
.box-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 12px; margin-bottom: 8px; cursor: pointer; transition: border-color 0.2s; }
.box-card:hover { border-color: var(--accent); }
.box-title { font-family: 'Bebas Neue', sans-serif; font-size: 18px; color: var(--accent); letter-spacing: 2px; margin-bottom: 6px; }
.box-parts { font-size: 12px; color: var(--text2); line-height: 1.7; }

/* ‚îÄ‚îÄ QR LABEL PREVIEW ‚îÄ‚îÄ */
.label-preview {
  background: #fff; color: #000;
  border-radius: 6px; padding: 10px;
  font-family: monospace; font-size: 11px;
  max-width: 240px; margin: 0 auto;
  border: 2px solid var(--border2);
}
.label-preview .lp-name { font-size: 13px; font-weight: bold; margin-bottom: 3px; }
.label-preview .lp-no { font-size: 12px; color: #333; margin-bottom: 3px; }
.label-preview .lp-detail { font-size: 10px; color: #555; margin-bottom: 6px; }
.label-preview .lp-qr { text-align: center; margin-top: 6px; }

/* ‚îÄ‚îÄ CONDITION SELECTOR ‚îÄ‚îÄ */
.condition-btns { display: flex; gap: 6px; }
.cond-btn {
  flex: 1; padding: 8px 4px; border-radius: var(--radius);
  border: 1px solid var(--border2); background: var(--surface2);
  color: var(--muted); cursor: pointer;
  font-family: 'IBM Plex Mono', monospace; font-size: 10px;
  text-align: center; transition: all 0.2s;
}
.cond-btn:hover { border-color: var(--text2); color: var(--text2); }
.cond-btn.active-good { border-color: var(--green); background: rgba(82,199,122,0.1); color: var(--green); }
.cond-btn.active-fair { border-color: var(--accent); background: rgba(232,184,75,0.1); color: var(--accent); }
.cond-btn.active-poor { border-color: var(--red); background: rgba(224,82,82,0.1); color: var(--red); }
.tatanka-match-option:hover { border-color: var(--accent) !important; background: var(--surface2); }
#smartSearchResults > div:last-child { border-bottom: none !important; }
#smartSearchResults > div:hover { background: var(--surface3); }
#smartSearchResults { box-shadow: 0 4px 16px rgba(0,0,0,0.4); }

/* ‚îÄ‚îÄ STATUS SELECTOR ‚îÄ‚îÄ */
.status-row { display: flex; gap: 6px; }
.status-btn {
  flex: 1; padding: 8px 4px; border-radius: var(--radius);
  border: 1px solid var(--border2); background: var(--surface2);
  color: var(--muted); cursor: pointer;
  font-family: 'IBM Plex Mono', monospace; font-size: 10px;
  text-align: center; transition: all 0.2s;
}
.status-btn.active { border-color: var(--accent); background: rgba(232,184,75,0.1); color: var(--accent); }

/* ‚îÄ‚îÄ SCROLLBAR ‚îÄ‚îÄ */
::-webkit-scrollbar { width: 4px; height: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 2px; }

/* ‚îÄ‚îÄ PRICE DISPLAY ‚îÄ‚îÄ */
.price-main { font-family: 'IBM Plex Mono', monospace; font-size: 16px; color: var(--green); font-weight: 600; }
.price-ref { font-family: 'IBM Plex Mono', monospace; font-size: 11px; color: var(--muted); }

/* ‚îÄ‚îÄ SECTION HEADER ‚îÄ‚îÄ */
.section-header { font-family: 'IBM Plex Mono', monospace; font-size: 10px; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 8px; margin-top: 4px; padding-bottom: 6px; border-bottom: 1px solid var(--border); }

/* ‚îÄ‚îÄ CATALOGUE ITEM ‚îÄ‚îÄ */
.cat-item { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 10px 12px; margin-bottom: 6px; display: flex; align-items: center; gap: 10px; cursor: pointer; transition: border-color 0.2s; }
.cat-item:hover { border-color: var(--accent); }
.cat-item-info { flex: 1; min-width: 0; }
.cat-item-name { font-size: 13px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.cat-item-no { font-family: 'IBM Plex Mono', monospace; font-size: 10px; color: var(--accent); }
.cat-item-price { font-family: 'IBM Plex Mono', monospace; font-size: 11px; color: var(--green); white-space: nowrap; }

/* ‚îÄ‚îÄ SETTINGS ‚îÄ‚îÄ */
.settings-row { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border); }
.settings-row:last-child { border-bottom: none; }
.settings-label { font-size: 13px; font-weight: 600; }
.settings-sublabel { font-size: 11px; color: var(--muted); margin-top: 2px; }
.settings-control { flex-shrink: 0; margin-left: 12px; }
.settings-control input { width: 100px; }

/* ‚îÄ‚îÄ GROUP FILTER ‚îÄ‚îÄ */
.group-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; margin-bottom: 14px; }
.group-btn { padding: 10px 8px; border-radius: var(--radius); border: 1px solid var(--border2); background: var(--surface2); color: var(--muted); cursor: pointer; font-family: 'IBM Plex Mono', monospace; font-size: 10px; text-align: left; transition: all 0.2s; line-height: 1.4; }
.group-btn:hover { border-color: var(--accent); color: var(--text2); }
.group-btn.active { border-color: var(--accent); background: rgba(232,184,75,0.1); color: var(--accent); }
.group-btn .grp-num { font-size: 14px; font-weight: 600; display: block; color: var(--accent); }

/* ‚îÄ‚îÄ PHOTO COMPARE ‚îÄ‚îÄ */
.photo-compare { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
.photo-compare-item { text-align: center; }
.photo-compare-item img { width: 100%; height: 120px; object-fit: cover; border-radius: var(--radius); border: 1px solid var(--border); }
.photo-compare-label { font-family: 'IBM Plex Mono', monospace; font-size: 9px; color: var(--muted); margin-top: 4px; letter-spacing: 0.5px; }

/* ‚îÄ‚îÄ SOLD ARCHIVE ‚îÄ‚îÄ */
.sold-item { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 10px 12px; margin-bottom: 6px; opacity: 0.7; }
.sold-badge { text-decoration: line-through; }

/* ‚îÄ‚îÄ RESPONSIVE: SMALL PHONES (iPhone SE, mini ‚Äî 375px and below) ‚îÄ‚îÄ */
@media (max-width: 375px) {
  :root {
    --header-h: 50px;
    --nav-h: 56px;
  }
  .logo { font-size: 20px; letter-spacing: 2px; }
  .logo span { font-size: 11px; }
  .header-stats { font-size: 9px; }
  .row2 { grid-template-columns: 1fr; }
  .row3 { grid-template-columns: 1fr 1fr; }
  .stats-grid { grid-template-columns: repeat(2, 1fr); }
  .nav-btn { font-size: 8px; }
  .nav-btn .nav-icon { font-size: 18px; }
  .screen { padding: 10px 10px 16px; }
  .card { padding: 12px; }
  .btn { padding: 9px 14px; font-size: 11px; }
  .guess-card { padding: 10px; }
  .guess-thumb, .guess-thumb-placeholder { width: 52px; height: 52px; }
  .modal { padding: 16px 12px; padding-bottom: calc(16px + env(safe-area-inset-bottom)); }
}

/* ‚îÄ‚îÄ RESPONSIVE: NORMAL PHONES (iPhone 12-16, 376-430px) ‚îÄ‚îÄ */
@media (min-width: 376px) and (max-width: 430px) {
  .row3 { grid-template-columns: 1fr 1fr; }
  .stats-grid { grid-template-columns: repeat(3, 1fr); }
}

/* ‚îÄ‚îÄ RESPONSIVE: LARGE PHONES / iPads (431px+) ‚îÄ‚îÄ */
@media (min-width: 431px) {
  .screen { padding: 16px 16px 24px; }
  .card { padding: 16px; }
  .photo-area { padding: 40px 20px; }
  .guess-thumb, .guess-thumb-placeholder { width: 72px; height: 72px; }
  .inv-thumb, .inv-thumb-ph { width: 60px; height: 60px; }
}

/* ‚îÄ‚îÄ IPHONE SAFE AREAS (notch + home bar) ‚îÄ‚îÄ */
@supports (padding-top: env(safe-area-inset-top)) {
  .app-header {
    padding-top: max(10px, env(safe-area-inset-top));
    height: calc(var(--header-h) + env(safe-area-inset-top));
  }
  .main {
    top: calc(var(--header-h) + env(safe-area-inset-top));
  }
  .bottom-nav {
    height: calc(var(--nav-h) + env(safe-area-inset-bottom));
    padding-bottom: env(safe-area-inset-bottom);
  }
  .main {
    bottom: calc(var(--nav-h) + env(safe-area-inset-bottom));
  }
  .toast {
    bottom: calc(var(--nav-h) + env(safe-area-inset-bottom) + 12px);
  }
}

/* ‚îÄ‚îÄ PREVENT DOUBLE-TAP ZOOM ON BUTTONS ‚îÄ‚îÄ */
button, .btn, .chip, .cond-btn, .status-btn, .nav-btn, .guess-card, .cat-item, .inv-item {
  touch-action: manipulation;
}

/* ‚îÄ‚îÄ PREVENT TEXT SELECTION ON UI ELEMENTS ‚îÄ‚îÄ */
.nav-btn, .chip, .btn, .card-title, .badge, .logo {
  -webkit-user-select: none;
  user-select: none;
}

/* ‚îÄ‚îÄ SMOOTH SCROLLING INSIDE MODAL ‚îÄ‚îÄ */
.modal {
  -webkit-overflow-scrolling: touch;
  overscroll-behavior: contain;
}

/* ‚îÄ‚îÄ FIX INPUT ZOOM ON IOS (font-size must be >= 16px to prevent zoom) ‚îÄ‚îÄ */
@media (max-width: 768px) {
  input, select, textarea {
    font-size: 16px !important;
  }
}
</style>
</head>
<body>

<!-- HEADER -->
<header class="app-header">
  <div>
    <div class="logo">VOLVO C3 <span>PARTS INVENTORY</span></div>
  </div>
  <div class="header-stats" id="headerStats">
    <b id="hPartCount">0</b> PARTS<br>
    <b id="hBoxCount">0</b> BOXES
  </div>
</header>

<!-- MAIN CONTENT -->
<main class="main">

  <!-- ‚ïê‚ïê‚ïê SCREEN: IDENTIFY ‚ïê‚ïê‚ïê -->
  <div class="screen active" id="screen-identify">
    <div class="steps">
      <div class="step active" id="step1"><span class="step-num">1</span>DETAILS</div>
      <div class="step" id="step2"><span class="step-num">2</span>PHOTO</div>
      <div class="step" id="step3"><span class="step-num">3</span>PRICE</div>
      <div class="step" id="step4"><span class="step-num">4</span>SAVED</div>
    </div>

    <!-- Step 1: Manual entry -->
    <div id="identStep1">

      <!-- Mode toggle: catalogue part vs custom part -->
      <div style="display:flex;gap:0;margin-bottom:12px;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden">
        <button id="modeTabCatalogue" onclick="setEntryMode('catalogue')"
          style="flex:1;padding:10px;font-family:'IBM Plex Mono',monospace;font-size:12px;font-weight:600;border:none;cursor:pointer;background:var(--accent);color:#000;letter-spacing:0.5px">
          üìã CATALOGUE PART
        </button>
        <button id="modeTabCustom" onclick="setEntryMode('custom')"
          style="flex:1;padding:10px;font-family:'IBM Plex Mono',monospace;font-size:12px;font-weight:600;border:none;cursor:pointer;background:var(--surface2);color:var(--muted);letter-spacing:0.5px">
          ‚úèÔ∏è CUSTOM PART
        </button>
      </div>

      <!-- ‚îÄ‚îÄ CATALOGUE MODE ‚îÄ‚îÄ -->
      <div id="entryModeCatalogue" class="card">
        <div class="card-title"><span class="ct-icon">üîç</span> FIND PART</div>

        <!-- Smart search: name OR part number -->
        <div class="fg">
          <label>Search by name or part number <span class="req">*</span></label>
          <input type="text" id="smartSearch"
            placeholder="e.g. clutch pedal, 461537, brake disc..."
            oninput="onSmartSearch(this.value)"
            autocomplete="off" autocorrect="off" spellcheck="false"
            style="font-size:15px">
          <div id="smartSearchResults" style="display:none;margin-top:4px;max-height:260px;overflow-y:auto;border:1px solid var(--border);border-radius:var(--radius);background:var(--surface2)"></div>
        </div>

        <!-- Selected part preview (shown after picking) -->
        <div id="selectedPartPreview" style="display:none;background:var(--surface2);border:1px solid var(--accent);border-left:3px solid var(--accent);border-radius:var(--radius);padding:10px;margin-bottom:2px">
          <div style="font-family:'IBM Plex Mono',monospace;font-size:9px;color:var(--muted);margin-bottom:6px;letter-spacing:1px">SELECTED PART</div>
          <div style="display:flex;gap:10px;align-items:flex-start">
            <img id="selectedPartImg" src="" alt="" style="display:none;width:72px;height:72px;border-radius:6px;object-fit:cover;border:1px solid var(--border);flex-shrink:0;cursor:pointer" onclick="openPartViewer(document.getElementById('manualPartNo').value, document.getElementById('selectedPartName').textContent)">
            <div id="selectedPartImgPh" style="display:none;width:72px;height:72px;border-radius:6px;background:var(--surface3);border:1px solid var(--border);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:28px;cursor:pointer" onclick="openPartViewer(document.getElementById('manualPartNo').value, document.getElementById('selectedPartName').textContent)">üîß</div>
            <div style="flex:1;min-width:0">
              <div id="selectedPartName" style="font-size:15px;font-weight:600;margin-bottom:2px"></div>
              <div id="selectedPartNo" style="font-family:'IBM Plex Mono',monospace;font-size:12px;color:var(--accent)"></div>
              <div id="selectedPartSv" style="font-size:11px;color:var(--text2);margin-top:1px"></div>
              <div id="selectedPartDiagBadge" style="display:none;font-size:10px;color:var(--blue);margin-top:4px">üìê Diagram available ‚Äî tap image to view</div>
              <button onclick="clearSelectedPart()" style="margin-top:6px;font-family:'IBM Plex Mono',monospace;font-size:10px;color:var(--red);background:none;border:none;cursor:pointer;padding:0">‚úï Change part</button>
            </div>
          </div>
        </div>

        <!-- Hidden fields populated by selection -->
        <input type="hidden" id="manualPartNo">
        <input type="hidden" id="manualName">
        <input type="hidden" id="manualNameSv">
        <input type="hidden" id="manualGroup">
      </div>

      <!-- ‚îÄ‚îÄ CUSTOM PART MODE ‚îÄ‚îÄ -->
      <div id="entryModeCustom" class="card" style="display:none">
        <div class="card-title"><span class="ct-icon">‚úèÔ∏è</span> CUSTOM PART</div>
        <div style="font-size:12px;color:var(--text2);margin-bottom:10px">For parts not in the official catalogue: aftermarket upgrades, accessories, fabricated parts, etc.</div>
        <div class="fg">
          <label>Part Name <span class="req">*</span></label>
          <input type="text" id="customName" placeholder="e.g. Electronic ignition kit, Wheel widener">
        </div>
        <div class="fg">
          <label>Brand / Reference</label>
          <input type="text" id="customBrand" placeholder="e.g. Pertronix, custom fabricated">
        </div>
        <div class="fg">
          <label>Source / URL</label>
          <input type="text" id="customSourceUrl" placeholder="e.g. https://shop.example.com/product">
        </div>
      </div>

      <!-- ‚îÄ‚îÄ COMMON FIELDS (both modes) ‚îÄ‚îÄ -->
      <div class="card">
        <div class="card-title"><span class="ct-icon">üì¶</span> STOCK DETAILS</div>

        <div class="row2">
          <div class="fg">
            <label>Box <span class="req">*</span></label>
            <input type="text" id="manualBox" placeholder="e.g. 4">
            <div id="boxSuggestion" style="display:none;margin-top:4px;font-size:11px;color:var(--accent);cursor:pointer;font-family:'IBM Plex Mono',monospace"></div>
          </div>
          <div class="fg">
            <label>Qty</label>
            <input type="number" id="manualQty" value="1" min="1">
          </div>
        </div>

        <div class="fg">
          <label>Condition</label>
          <div class="condition-btns">
            <button class="cond-btn" id="condBtnGood" onclick="setCondition('good',this)">‚úÖ Good</button>
            <button class="cond-btn" id="condBtnFair" onclick="setCondition('fair',this)">‚ö†Ô∏è Fair</button>
            <button class="cond-btn" id="condBtnPoor" onclick="setCondition('poor',this)">‚ùå Poor</button>
          </div>
        </div>

        <div class="fg">
          <label>Notes</label>
          <textarea id="manualNotes" placeholder="Optional notes..."></textarea>
        </div>

        <div style="display:flex;gap:8px;margin-top:4px">
          <button class="btn btn-secondary" style="flex:1" onclick="showScreen('bulk')">‚ö° BULK</button>
          <button class="btn btn-primary" style="flex:2" onclick="goToPhotoStep()">NEXT: ADD PHOTO ‚Üí</button>
        </div>
      </div>
    </div>

    <!-- Step 2: Photo + optional AI -->
    <div id="identStep2" style="display:none">
      <div class="card">
        <div class="card-title"><span class="ct-icon">üì∑</span> ADD PHOTO <span style="font-size:11px;color:var(--muted);font-family:'IBM Plex Mono',monospace;font-weight:400">(optional)</span></div>
        <div class="photo-area" id="photoArea" onclick="document.getElementById('cameraInput').click()">
          <div class="photo-placeholder">
            <div class="photo-icon">üì∑</div>
            <div class="photo-label">TAP TO TAKE PHOTO</div>
            <div class="photo-sublabel">or choose from gallery</div>
          </div>
        </div>
        <input type="file" id="cameraInput" accept="image/*" capture="environment">
        <div style="margin-top:8px;display:flex;gap:8px;">
          <button class="btn btn-secondary btn-sm" style="flex:1" onclick="document.getElementById('galleryInput').click()">üìÅ Gallery</button>
          <button class="btn btn-secondary btn-sm" id="addAngleBtn" style="display:none" onclick="document.getElementById('angleInput').click()">üì∑ +Angle</button>
        </div>
        <input type="file" id="galleryInput" accept="image/*" style="display:none">
        <input type="file" id="angleInput" accept="image/*" style="display:none">
        <div id="angleStrip" style="display:none;margin-top:8px;gap:6px;flex-wrap:wrap;"></div>
      </div>

      <!-- AI identification (optional) -->
      <div class="card" id="aiCard">
        <div class="card-title"><span class="ct-icon">ü§ñ</span> AI IDENTIFICATION <span style="font-size:11px;color:var(--muted);font-family:'IBM Plex Mono',monospace;font-weight:400">(optional)</span></div>
        <div style="font-size:12px;color:var(--text2);margin-bottom:10px">If you already entered the part details above, skip this. Use AI only if you need help identifying the part.</div>
        <div class="fg">
          <label>Filter by system (optional)</label>
          <select id="groupFilter">
            <option value="">All systems ‚Äî let AI decide</option>
            <option value="20,21,22,23,25,26,27">Engine & Fuel</option>
            <option value="31,32,33,34,35,36,37,38,39">Electrical</option>
            <option value="41,43,45">Clutch, Gearbox & Driveshaft</option>
            <option value="46,48">Axles & Power Takeoff</option>
            <option value="51,52,55,58">Brakes</option>
            <option value="61,64">Steering</option>
            <option value="71,72,73,77">Frame, Suspension & Wheels</option>
            <option value="81,83,84,85,86,87,88">Cab, Body & Interior</option>
          </select>
        </div>
        <button class="btn btn-secondary btn-full" id="analyzeBtn" disabled onclick="analyzePhoto()">
          <span class="spinner" style="display:none" id="analyzeSpinner"></span>
          <span id="analyzeBtnText">üîç RUN AI IDENTIFICATION</span>
        </button>
        <div id="aiResults" style="display:none;margin-top:10px">
          <div id="guessResults"></div>
          <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn btn-secondary btn-sm" onclick="retryAnalysis()">üîÑ Try Again</button>
            <button class="btn btn-danger btn-sm" onclick="clearAiResults()">‚úï Clear</button>
          </div>
        </div>
      </div>

      <div style="display:flex;gap:8px;margin-top:4px">
        <button class="btn btn-secondary" onclick="showStep(1)">‚Üê Back</button>
        <button class="btn btn-primary" style="flex:1" onclick="goToPriceStep()">NEXT: SET PRICE ‚Üí</button>
      </div>
    </div>

    <!-- Step 3: Tatanka matching + price -->
    <div id="identStep3" style="display:none">
      <div class="card">
        <div class="card-title"><span class="ct-icon">‚úÖ</span> CONFIRM PART</div>
        <div id="confirmedPartSummary"></div>
      </div>

      <!-- Tatanka matching ‚Äî pick exact listing -->
      <div class="card" id="tatankaMatchCard" style="display:none">
        <div class="card-title"><span class="ct-icon">üè™</span> MATCH TO TATANKA LISTING</div>
        <div style="font-size:12px;color:var(--text2);margin-bottom:10px">Select which Tatanka listing best matches YOUR part to set the reference price:</div>
        <div id="tatankaMatchOptions"></div>
        <div id="tatankaNoMatch" style="display:none;font-size:12px;color:var(--muted)">No Tatanka listings found for this part number.</div>
      </div>

      <div class="card">
        <div class="card-title"><span class="ct-icon">üí∂</span> ASKING PRICE</div>
        <div id="tatankaSelectedRef" style="display:none;margin-bottom:10px"></div>
        <div class="fg">
          <label>Asking Price (EUR) <span class="req">*</span></label>
          <input type="number" id="confirmPrice" placeholder="0.00" step="0.01">
        </div>
        <div style="display:flex;gap:6px;margin-top:6px;flex-wrap:wrap" id="priceShortcuts"></div>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button class="btn btn-secondary" onclick="showStep(2)">‚Üê Back</button>
          <button class="btn btn-primary" style="flex:1" onclick="savePart()">üíæ SAVE TO INVENTORY</button>
        </div>
      </div>
    </div>

    <!-- Step 4: Saved confirmation -->
    <div id="identStep4" style="display:none">
      <div class="card" style="text-align:center; padding:32px 16px;">
        <div style="font-size:56px; margin-bottom:12px;">‚úÖ</div>
        <div class="card-title" style="justify-content:center; font-size:22px;">PART SAVED!</div>
        <div id="savedPartSummary" style="color:var(--text2); font-size:13px; margin-bottom:20px;"></div>
        <div id="duplicateWarning" style="display:none; background:rgba(232,184,75,0.1); border:1px solid var(--accent); border-radius:var(--radius); padding:12px; margin-bottom:16px; font-size:13px;"></div>
        <div class="btn-group" style="justify-content:center;">
          <button class="btn btn-primary" onclick="resetIdentify()">üì∑ ADD ANOTHER</button>
          <button class="btn btn-secondary" onclick="showScreen('inventory')">üì¶ VIEW INVENTORY</button>
        </div>
      </div>
    </div>
  </div>


  <!-- ‚ïê‚ïê‚ïê SCREEN: BULK ‚ïê‚ïê‚ïê -->
  <div class="screen" id="screen-bulk">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;">
      <button class="btn btn-secondary btn-sm" onclick="showScreen('identify')">‚Üê Back</button>
      <div style="font-family:'Bebas Neue',sans-serif;font-size:18px;color:var(--accent);letter-spacing:2px">BULK MODE</div>
      <div id="bulkCount" style="font-family:'IBM Plex Mono',monospace;font-size:11px;color:var(--muted);margin-left:auto">0 queued</div>
    </div>

    <!-- Capture area -->
    <div class="card" id="bulkCaptureCard">
      <div class="card-title"><span class="ct-icon">üì∑</span> PHOTOGRAPH PARTS</div>
      <div class="photo-area" id="bulkPhotoArea" onclick="document.getElementById('bulkCameraInput').click()">
        <div class="photo-placeholder">
          <div class="photo-icon">üì∑</div>
          <div class="photo-label">TAP TO PHOTOGRAPH PART</div>
          <div class="photo-sublabel">Each photo is queued for analysis</div>
        </div>
      </div>
      <input type="file" id="bulkCameraInput" accept="image/*" capture="environment">
      <div style="margin-top:8px;display:flex;gap:8px;">
        <button class="btn btn-secondary btn-sm" style="flex:1" onclick="document.getElementById('bulkGalleryInput').click()">üìÅ Gallery</button>
        <input type="file" id="bulkGalleryInput" accept="image/*" multiple>
        <button class="btn btn-primary btn-sm" style="flex:1" id="bulkAnalyzeBtn" disabled onclick="analyzeBulkQueue()">üîç ANALYZE ALL</button>
      </div>
    </div>

    <!-- Queue -->
    <div id="bulkQueue"></div>

    <!-- Review panel (shown when results ready) -->
    <div id="bulkReview" style="display:none">
      <div class="card">
        <div class="card-title"><span class="ct-icon">‚úÖ</span> REVIEW & SAVE</div>
        <div id="bulkReviewList"></div>
        <button class="btn btn-primary btn-full" style="margin-top:10px" onclick="saveAllBulk()">üíæ SAVE ALL TO INVENTORY</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê SCREEN: INVENTORY ‚ïê‚ïê‚ïê -->
  <div class="screen" id="screen-inventory">
    <div class="search-wrap">
      <span class="search-icon">üîç</span>
      <input type="text" placeholder="Search parts, numbers, boxes..." id="invSearch" oninput="filterInventory()">
    </div>
    <div class="filter-chips" id="invFilterChips">
      <div class="chip active" onclick="setInvFilter('all',this)">All</div>
      <div class="chip" onclick="setInvFilter('available',this)">Available</div>
      <div class="chip" onclick="setInvFilter('listed',this)">Listed</div>
      <div class="chip" onclick="setInvFilter('unknown',this)">‚ùì Unknown</div>
      <div class="chip" onclick="setInvFilter('sold',this)">Sold Archive</div>
    </div>
    <div id="invList"></div>
  </div>

  <!-- ‚ïê‚ïê‚ïê SCREEN: CATALOGUE ‚ïê‚ïê‚ïê -->
  <div class="screen" id="screen-catalogue">
    <div class="search-wrap">
      <span class="search-icon">üîç</span>
      <input type="text" placeholder="Search C3 parts catalogue..." id="catSearch" oninput="filterCatalogue()">
    </div>
    <div class="filter-chips" id="catFilterChips">
      <div class="chip active" onclick="setCatFilter('',this)">All</div>
      <div class="chip" onclick="setCatFilter('21',this)">Engine</div>
      <div class="chip" onclick="setCatFilter('22',this)">Oil</div>
      <div class="chip" onclick="setCatFilter('23',this)">Fuel</div>
      <div class="chip" onclick="setCatFilter('34',this)">Ignition</div>
      <div class="chip" onclick="setCatFilter('41',this)">Clutch</div>
      <div class="chip" onclick="setCatFilter('43',this)">Gearbox</div>
      <div class="chip" onclick="setCatFilter('51',this)">Brakes</div>
      <div class="chip" onclick="setCatFilter('72',this)">Suspension</div>
      <div class="chip" onclick="setCatFilter('81',this)">Body</div>
      <div class="chip" onclick="setCatFilter('87',this)">Heating</div>
    </div>
    <div id="catList"></div>
  </div>

  <!-- ‚ïê‚ïê‚ïê SCREEN: SUMMARY ‚ïê‚ïê‚ïê -->
  <div class="screen" id="screen-summary">
    <div class="card">
      <div class="card-title"><span class="ct-icon">üìä</span> INVENTORY SUMMARY</div>
      <div class="stats-grid" id="summaryStats"></div>
      <div id="summaryValues"></div>
    </div>
    <div class="card">
      <div class="card-title"><span class="ct-icon">üì¶</span> BOX SUMMARY</div>
      <div id="boxSummary"></div>
    </div>
    <div class="card">
      <div class="card-title"><span class="ct-icon">üìÑ</span> EXPORT SALES CATALOGUE</div>
      <div style="margin-bottom:10px; font-size:13px; color:var(--text2);">Generate a catalogue to share with buyers.</div>
      <div class="row2">
        <button class="btn btn-secondary" onclick="exportCatalogue('bulk')">üìã BULK MODE<br><span style="font-size:9px;font-weight:400">One buyer, all parts</span></button>
        <button class="btn btn-secondary" onclick="exportCatalogue('individual')">üìë INDIVIDUAL<br><span style="font-size:9px;font-weight:400">Part by part listing</span></button>
      </div>
    </div>
    <div class="card">
      <div class="card-title"><span class="ct-icon">üè∑Ô∏è</span> QR LABELS</div>
      <div style="margin-bottom:10px; font-size:13px; color:var(--text2);">Print labels for boxes or individual parts.</div>
      <div class="row2">
        <button class="btn btn-secondary" onclick="showQRModal('box')">üì¶ BY BOX</button>
        <button class="btn btn-secondary" onclick="showQRModal('part')">üîß BY PART</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê SCREEN: SETTINGS ‚ïê‚ïê‚ïê -->
  <div class="screen" id="screen-settings">
    <div class="card">
      <div class="card-title"><span class="ct-icon">üí∂</span> PRICING SETTINGS</div>
      <div class="settings-row">
        <div>
          <div class="settings-label">Exchange Rate</div>
          <div class="settings-sublabel">1 SEK = X EUR</div>
        </div>
        <div class="settings-control">
          <input type="number" id="settingRate" value="0.087" step="0.001" min="0.001" onchange="saveSetting('rate',this.value)">
        </div>
      </div>
      <div class="settings-row">
        <div>
          <div class="settings-label">Default Discount ‚Äî In Stock</div>
          <div class="settings-sublabel">% of Tatanka price when in stock</div>
        </div>
        <div class="settings-control">
          <input type="number" id="settingDiscountIn" value="70" min="1" max="100" onchange="saveSetting('discountIn',this.value)">
        </div>
      </div>
      <div class="settings-row">
        <div>
          <div class="settings-label">Default Discount ‚Äî Out of Stock</div>
          <div class="settings-sublabel">% of Tatanka price when out of stock</div>
        </div>
        <div class="settings-control">
          <input type="number" id="settingDiscountOut" value="80" min="1" max="100" onchange="saveSetting('discountOut',this.value)">
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-title"><span class="ct-icon">üóÉÔ∏è</span> DATA</div>
      <div class="settings-row">
        <div>
          <div class="settings-label">Catalogue Parts</div>
          <div class="settings-sublabel">Loaded from PARTS_DB.js</div>
        </div>
        <div class="settings-control">
          <span id="settingPartCount" style="font-family:'IBM Plex Mono',monospace;font-size:12px;color:var(--accent)">‚Äî</span>
        </div>
      </div>
      <div class="settings-row">
        <div>
          <div class="settings-label">Tatanka Products</div>
          <div class="settings-sublabel">Loaded from tatanka_db.json</div>
        </div>
        <div class="settings-control">
          <span id="settingTatankaCount" style="font-family:'IBM Plex Mono',monospace;font-size:12px;color:var(--accent)">‚Äî</span>
        </div>
      </div>
      <div class="settings-row">
        <div>
          <div class="settings-label">My Inventory</div>
          <div class="settings-sublabel">Saved locally</div>
        </div>
        <div class="settings-control">
          <span id="settingInvCount" style="font-family:'IBM Plex Mono',monospace;font-size:12px;color:var(--accent)">‚Äî</span>
        </div>
      </div>
      <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
        <button class="btn btn-secondary btn-sm" onclick="exportInventoryJSON()">üíæ Backup Inventory</button>
        <button class="btn btn-secondary btn-sm" onclick="document.getElementById('importInput').click()">üìÇ Restore Backup</button>
        <input type="file" id="importInput" accept=".json" style="display:none" onchange="importInventoryJSON(this)">
      </div>
    </div>
    <div class="card">
      <div class="card-title"><span class="ct-icon">üîë</span> API KEY</div>
      <div class="settings-row">
        <div>
          <div class="settings-label">Anthropic API Key</div>
          <div class="settings-sublabel" id="apiKeyStatus">Not set</div>
        </div>
        <div class="settings-control" style="display:flex;gap:6px">
          <button class="btn btn-secondary btn-sm" onclick="promptApiKey('none')">Change</button>
          <button class="btn btn-danger btn-sm" onclick="clearApiKey()">Clear</button>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-title"><span class="ct-icon">‚ÑπÔ∏è</span> ABOUT</div>
      <div style="font-size:12px; color:var(--text2); line-height:1.8;">
        Volvo C3 Parts Inventory v1.0<br>
        Built for C303 / C304 / C306<br>
        TGB 11 / TGB 13 / TGB 20<br>
        <br>
        <span style="color:var(--muted)">Tatanka data scraped: <span id="tatankaScrapeDate">‚Äî</span></span>
      </div>
    </div>
  </div>

</main>

<!-- BOTTOM NAV -->
<nav class="bottom-nav">
  <button class="nav-btn active" id="nav-identify" onclick="showScreen('identify')">
    <span class="nav-icon">üì∑</span>IDENTIFY
  </button>
  <button class="nav-btn" id="nav-inventory" onclick="showScreen('inventory')">
    <span class="nav-icon">üì¶</span>INVENTORY
  </button>
  <button class="nav-btn" id="nav-catalogue" onclick="showScreen('catalogue')">
    <span class="nav-icon">üìã</span>CATALOGUE
  </button>
  <button class="nav-btn" id="nav-summary" onclick="showScreen('summary')">
    <span class="nav-icon">üìä</span>SUMMARY
  </button>
  <button class="nav-btn" id="nav-settings" onclick="showScreen('settings')">
    <span class="nav-icon">‚öôÔ∏è</span>SETTINGS
  </button>
</nav>

<!-- MODALS -->
<div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
  <div class="modal" id="modalContent">
    <div class="modal-handle"></div>
    <div id="modalBody"></div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIGURATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ANTHROPIC_API = 'https://api.anthropic.com/v1/messages';
const API_KEY_STORAGE = 'volvo_api_key';

let PARTS_DB = [];
let TATANKA_DB = {};
let INVENTORY = [];
let PART_PHOTOS = {}; // keyed by partNo: { photos: [dataURL,...], defaultIndex: 0 }
let DIAGRAM_MAP = {}; // keyed by partNo: { group, diagramPage, pos, occurrences:[{x,y}] }
let SETTINGS = {
  exchangeRate: 0.088,
  discountIn: 75,
  discountOut: 60,
  currency: 'EUR'
};

// Identify flow state
let currentPhoto = null;
let currentPhotoBlob = null;
let extraAngles = [];
let currentGuesses = [];
let selectedGuess = null;
let currentCondition = null;
let identifyAttempt = 0;

// Manual entry state
let entryMode = 'catalogue';
let partSelected = false;
let selectedTatankaRef = null;

// Filter state
let invFilter = 'all';
let catFilter = '';
let catSearch = '';


function showToast(msg, type) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast show' + (type ? ' ' + type : '');
  setTimeout(() => t.className = 'toast', 3000);
}

function formatEur(eur) {
  if (eur === null || eur === undefined) return '\u2014';
  return eur.toFixed(2) + ' EUR';
}

function formatSek(sek) {
  if (!sek) return '';
  return '(' + sek.toLocaleString() + ' SEK)';
}

function formatPrice(eur, sek) {
  if (!eur) return '<span style=\"color:var(--muted)\">Price on request</span>';
  return '<span class=\"price-main\">' + formatEur(eur) + '</span> <span class=\"price-ref\">' + formatSek(sek) + '</span>';
}

function sekToEur(sek) {
  if (!sek) return null;
  return Math.round(sek * SETTINGS.rate * 100) / 100;
}

function getConditionBadge(cond) {
  if (!cond) return '';
  const map = {
    good: '<span class=\"badge badge-green\">\u2705 Good</span>',
    fair: '<span class=\"badge badge-yellow\">\u26a0\ufe0f Fair</span>',
    poor: '<span class=\"badge badge-red\">\u274c Poor</span>',
  };
  return map[cond] || '';
}

function getStatusBadge(status) {
  const map = {
    available: '<span class=\"badge badge-green\">\u25cf Available</span>',
    listed: '<span class=\"badge badge-blue\">\u25cf Listed</span>',
    sold: '<span class=\"badge badge-muted\">\u2713 Sold</span>',
  };
  return map[status] || '<span class=\"badge badge-green\">\u25cf Available</span>';
}

function getStockBadge(stock) {
  const map = {
    'in_stock': '<span class=\"badge badge-green\">\u2705 In Stock</span>',
    'few_left': '<span class=\"badge badge-yellow\">\u26a0\ufe0f Few Left</span>',
    'temp_finished': '<span class=\"badge badge-orange\">\u23f3 Temp Out</span>',
    'out_of_stock': '<span class=\"badge badge-red\">\u274c Out of Stock</span>',
  };
  return map[stock] || '<span class=\"badge badge-muted\">? Unknown</span>';
}

function loadSettings() {
  const s = localStorage.getItem('volvo_settings');
  if (s) {
    try { SETTINGS = {...SETTINGS, ...JSON.parse(s)}; } catch(e) {}
  }
}

function saveSetting(key, val) {
  SETTINGS[key] = parseFloat(val) || val;
  localStorage.setItem('volvo_settings', JSON.stringify(SETTINGS));
  updateSettingsUI();
  renderInventory();
  renderSummary();
}

function getApiKey() {
  let key = localStorage.getItem(API_KEY_STORAGE);
  if (!key) {
    key = prompt('Enter your Anthropic API key (stored locally, never sent anywhere else):');
    if (key) localStorage.setItem(API_KEY_STORAGE, key.trim());
  }
  return key;
}

function saveApiKey(callback) {
  const val = document.getElementById('apiKeyInput').value.trim();
  if (!val || !val.startsWith('sk-')) {
    showToast('Invalid key ‚Äî should start with sk-', 'error');
    return;
  }
  localStorage.setItem(API_KEY_STORAGE, val);
  closeModal();
  showToast('API key saved ‚úì', 'success');
  updateApiKeyStatus();
  if (callback === 'analyze') analyzePhoto();
}

function clearApiKey() {
  localStorage.removeItem(API_KEY_STORAGE);
  showToast('API key cleared', 'success');
}

function promptApiKey(callback) {
  const body = document.getElementById('modalBody');
  body.innerHTML = `
    <div class="modal-title">üîë API KEY REQUIRED</div>
    <div style="font-size:13px;color:var(--text2);margin-bottom:16px;line-height:1.6">
      Enter your Anthropic API key to enable photo identification.<br>
      It is stored only on this device and never shared.
    </div>
    <div class="fg">
      <label>Anthropic API Key</label>
      <input type="password" id="apiKeyInput" placeholder="sk-ant-..." autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false">
    </div>
    <div style="margin-top:4px;margin-bottom:16px">
      <a href="https://console.anthropic.com/keys" target="_blank" 
         style="font-family:'IBM Plex Mono',monospace;font-size:11px;color:var(--blue)">
        Get your key at console.anthropic.com ‚Üí
      </a>
    </div>
    <div class="btn-group">
      <button class="btn btn-secondary" style="flex:1" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" style="flex:1" onclick="saveApiKey('${callback}')">SAVE & CONTINUE</button>
    </div>`;
  document.getElementById('modalOverlay').classList.add('open');
}

function updateSettingsUI() {
  document.getElementById('settingRate').value = SETTINGS.rate;
  document.getElementById('settingDiscountIn').value = SETTINGS.discountIn;
  document.getElementById('settingDiscountOut').value = SETTINGS.discountOut;
}

function updateApiKeyStatus() {
  const el = document.getElementById('apiKeyStatus');
  if (!el) return;
  const key = localStorage.getItem(API_KEY_STORAGE);
  if (key) {
    el.style.display = 'none';
  } else {
    el.innerHTML = '<span style="color:var(--red)">‚ö†Ô∏è No API key</span>';
  }
}

async function init() {
  loadSettings();
  loadInventory();
  await loadTatankaDB();
  await loadDiagramMap();
  updateHeaderStats();
  renderInventory();
  renderCatalogue();
  renderSummary();
  updateSettingsUI();
  updateApiKeyStatus();
}

function loadInventory() {
  const d = localStorage.getItem('volvo_inventory');
  if (d) { try { INVENTORY = JSON.parse(d); } catch(e) { INVENTORY = []; } }
  const p = localStorage.getItem('volvo_part_photos');
  if (p) { try { PART_PHOTOS = JSON.parse(p); } catch(e) { PART_PHOTOS = {}; } }
}

function saveInventory() {
  localStorage.setItem('volvo_inventory', JSON.stringify(INVENTORY));
  localStorage.setItem('volvo_part_photos', JSON.stringify(PART_PHOTOS));
  updateHeaderStats();
}

function getPartPhotos(partNo) {
  if (!partNo) return { photos: [], defaultIndex: 0 };
  return PART_PHOTOS[partNo] || { photos: [], defaultIndex: 0 };
}

function getDefaultPartPhoto(partNo) {
  const pp = getPartPhotos(partNo);
  return pp.photos.length > 0 ? pp.photos[pp.defaultIndex] || pp.photos[0] : null;
}

// Add a photo to a part's photo library, with optional "set as default" prompt
async function addPhotoToPartLibrary(partNo, dataURL, tatankaHasImage) {
  if (!partNo) return;
  if (!PART_PHOTOS[partNo]) PART_PHOTOS[partNo] = { photos: [], defaultIndex: 0 };
  const pp = PART_PHOTOS[partNo];
  const isFirst = pp.photos.length === 0;
  pp.photos.push(dataURL);
  const newIdx = pp.photos.length - 1;

  if (isFirst && !tatankaHasImage) {
    // No competition ‚Äî set as default silently
    pp.defaultIndex = newIdx;
    saveInventory();
    showToast('Photo saved as default image', 'success');
  } else {
    // Ask user
    const existingLabel = !isFirst ? `${pp.photos.length - 1} existing photo(s)` : 'a Tatanka catalogue image';
    const setDefault = await showPhotoDefaultPrompt(dataURL, existingLabel);
    if (setDefault) pp.defaultIndex = newIdx;
    saveInventory();
    showToast(setDefault ? 'Set as default display image ‚úì' : 'Photo saved to library', 'success');
  }
}

function showPhotoDefaultPrompt(newPhotoURL, existingLabel) {
  return new Promise(resolve => {
    const modal = document.getElementById('photoDefaultModal');
    document.getElementById('photoDefaultPreview').src = newPhotoURL;
    document.getElementById('photoDefaultExistingLabel').textContent = `Currently showing: ${existingLabel}`;
    modal.style.display = 'flex';
    window._photoDefaultResolve = resolve;
  });
}

function resolvePhotoDefault(val) {
  document.getElementById('photoDefaultModal').style.display = 'none';
  if (window._photoDefaultResolve) { window._photoDefaultResolve(val); window._photoDefaultResolve = null; }
}

async function loadTatankaDB() {
  try {
    const r = await fetch('tatanka_db.json');
    if (!r.ok) throw new Error('not found');
    const data = await r.json();
    TATANKA_DB = {};
    (data.products || []).forEach(p => {
      const key = p.base_no || p.sku;
      if (!TATANKA_DB[key]) TATANKA_DB[key] = [];
      TATANKA_DB[key].push(p);
    });
    document.getElementById('settingTatankaCount').textContent = (data.products||[]).length;
    document.getElementById('tatankaScrapeDate').textContent = data.scraped_date || '\u2014';
  } catch(e) {
    console.log('tatanka_db.json not loaded:', e.message);
  }
}

async function loadDiagramMap() {
  try {
    const r = await fetch('diagram_map.json');
    if (!r.ok) throw new Error('not found');
    DIAGRAM_MAP = await r.json();
    console.log('diagram_map.json loaded:', Object.keys(DIAGRAM_MAP).length, 'parts mapped');
  } catch(e) {
    console.log('diagram_map.json not loaded (run build_diagram_map.py to generate):', e.message);
  }
}

function getDiagramData(partNo) {
  if (!partNo || !DIAGRAM_MAP[partNo]) return null;
  return DIAGRAM_MAP[partNo];
}

// Build URL for a diagram page image from the group PDF
// On the real server, PDFs are actual PDFs ‚Äî the pipeline pre-extracts pages as JPEGs
// and stores them as: diagram_pages/GRP_PAGE.jpg
// e.g. diagram_pages/25_3.jpg = group 25, page 3
function getDiagramPageURL(group, pageNum) {
  return `diagram_pages/${group}_${pageNum}.jpg`;
}


function getTatankaData(partNo) {
  if (!partNo) return [];
  const base = partNo.replace(/-\\\\d$/, '').replace(/-/, '');
  const base2 = partNo.split('-')[0];
  return TATANKA_DB[base] || TATANKA_DB[base2] || TATANKA_DB[partNo] || [];
}

function getSuggestedPrice(tatankaItems) {
  if (!tatankaItems || tatankaItems.length === 0) return null;
  // Prefer in-stock items for price reference
  const inStock = tatankaItems.filter(t => t.stock === 'in_stock' || t.stock === 'few_left');
  const ref = inStock.length > 0 ? inStock[0] : tatankaItems[0];
  if (!ref.price_sek) return null;
  const isOutOfStock = ref.stock === 'temp_finished' || ref.stock === 'out_of_stock';
  const discount = isOutOfStock ? SETTINGS.discountOut : SETTINGS.discountIn;
  const eur = sekToEur(ref.price_sek);
  if (!eur) return null;
  return Math.round(eur * (discount / 100) * 100) / 100;
}

async function compressImage(file, maxWidth=1200, quality=0.85) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement("canvas");
        let w = img.naturalWidth, h = img.naturalHeight;
        if (w > maxWidth) { h = Math.round(h * maxWidth / w); w = maxWidth; }
        canvas.width = w; canvas.height = h;
        canvas.getContext("2d").drawImage(img, 0, 0, w, h);
        canvas.toBlob(blob => {
          const fr2 = new FileReader();
          fr2.onload = () => {
            const b64 = fr2.result.split(",")[1];
            resolve({ b64, blob, dataUrl: fr2.result });
          };
          fr2.readAsDataURL(blob);
        }, "image/jpeg", quality);
      };
      img.onerror = reject;
      img.src = e.target.result;
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

async function handleAnglePhoto(e) {
  const file = e.target.files[0];
  if (!file) return;
  if (extraAngles.length >= 2) {
    showToast('Max 3 photos total', 'error');
    return;
  }
  const compressed = await compressImage(file, 1000, 0.8);
  extraAngles.push(compressed.b64);
  renderAngleStrip();
  e.target.value = '';
  showToast('Angle ' + (extraAngles.length + 1) + ' added \u2713', 'success');
}

function renderAngleStrip() {
  const strip = document.getElementById('angleStrip');
  if (extraAngles.length === 0) {
    strip.style.display = 'none';
    return;
  }
  strip.style.display = 'flex';
  strip.innerHTML = extraAngles.map((b64, i) =>
    `<div style=\"position:relative\">
      <img src=\"data:image/jpeg;base64,${b64}\" style=\"width:64px;height:64px;border-radius:6px;object-fit:cover;border:1px solid var(--accent)\">
      <button onclick=\"removeAngle(${i})\" style=\"position:absolute;top:-6px;right:-6px;background:var(--red);color:#fff;border:none;border-radius:50%;width:18px;height:18px;font-size:11px;cursor:pointer;padding:0;line-height:18px\">\u2715</button>
    </div>`
  ).join('');
}

function removeAngle(i) {
  extraAngles.splice(i, 1);
  renderAngleStrip();
}

async function handlePhoto(e) {
  const file = e.target.files[0];
  if (!file) return;
  const compressed = await compressImage(file, 1200, 0.85);
  currentPhoto = compressed.b64;
  currentPhotoBlob = compressed.blob;
  const photoArea = document.getElementById('photoArea');
  photoArea.classList.add('has-photo');
  photoArea.innerHTML = '<img src=\"' + compressed.dataUrl + '\" alt=\"Part photo\">';
  document.getElementById('analyzeBtn').disabled = false;
  document.getElementById('addAngleBtn').style.display = 'inline-flex';
  e.target.value = '';
}

// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550
// PHOTO HANDLING
// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550

document.getElementById('cameraInput').addEventListener('change', handlePhoto);
document.getElementById('galleryInput').addEventListener('change', handlePhoto);
document.getElementById('angleInput').addEventListener('change', handleAnglePhoto);

function showScreen(name) {
  // Hide all screens
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));

  // Show target screen
  const screenEl = document.getElementById('screen-' + name);
  if (!screenEl) { console.error('No screen:', name); return; }
  screenEl.classList.add('active');

  const navMap = { bulk: 'identify' };
  const navName = navMap[name] || name;
  const navEl = document.getElementById('nav-' + navName);
  if (navEl) navEl.classList.add('active');

  document.querySelector('.main').scrollTop = 0;
  if (name === 'inventory') renderInventory();
  if (name === 'summary') renderSummary();
  if (name === 'catalogue') renderCatalogue();
}

function updateHeaderStats() {
  const active = INVENTORY.filter(i => i.status !== 'sold' && !i.isUnknown);
  const boxes = new Set(active.map(i => i.box)).size;
  document.getElementById('hPartCount').textContent = active.length;
  document.getElementById('hBoxCount').textContent = boxes;
  document.getElementById('settingInvCount').textContent = INVENTORY.length;
  if (typeof PARTS_DB !== 'undefined') {
    document.getElementById('settingPartCount').textContent = PARTS_DB.length;
  }
}

// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550
// HELPERS: PRICING
// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550

function tryLoadPartsDB() {
  // Try all common variable names that PARTS_DB.js might export
  const candidates = [
    window.PARTS_DB_DATA,
    window.PARTS_DB,
    window.partsDB,
    window.parts_db,
    window.C3_PARTS,
  ];
  for (const candidate of candidates) {
    if (Array.isArray(candidate) && candidate.length > 0) {
      PARTS_DB = candidate;
      console.log('PARTS_DB loaded:', PARTS_DB.length, 'parts from', JSON.stringify(Object.keys(window).filter(k => window[k] === candidate)));
      if (document.getElementById('settingPartCount'))
        document.getElementById('settingPartCount').textContent = PARTS_DB.length;
      return true;
    }
  }
  // Also check if the global PARTS_DB itself was set by the script directly
  if (typeof PARTS_DB !== 'undefined' && PARTS_DB.length > 0) {
    console.log('PARTS_DB already set:', PARTS_DB.length, 'parts');
    return true;
  }
  console.warn('PARTS_DB not found ‚Äî tried PARTS_DB_DATA, PARTS_DB, partsDB, C3_PARTS on window');
  return false;
}

function bootApp() {
  tryLoadPartsDB();
  init();
  // Retry at 300ms and 1s in case PARTS_DB.js loaded slightly late
  [300, 1000].forEach(delay => {
    setTimeout(() => {
      if (PARTS_DB.length === 0) {
        if (tryLoadPartsDB()) {
          console.log('PARTS_DB late-loaded at', delay, 'ms:', PARTS_DB.length, 'parts');
          renderCatalogue();
          updateHeaderStats();
        }
      }
    }, delay);
  });
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', bootApp);
} else {
  bootApp();
}


function confLabel() { console.warn("confLabel not implemented"); }

function disambigWidget(desc) {
  if (!desc || !desc.part_type) return '';
  const type = desc.part_type.toLowerCase();
  if (type.includes('pedal')) {
    return `<div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border)">
      <div style="font-family:'IBM Plex Mono',monospace;font-size:9px;color:var(--muted);margin-bottom:6px">WHICH PEDAL?</div>
      <div style="display:flex;gap:6px;flex-wrap:wrap">
        <button onclick="forcePartGuess('644768','Clutch pedal arm','Kopplingspedalarm','41')" style="padding:5px 10px;font-size:11px;font-family:'IBM Plex Mono',monospace;background:var(--surface3);border:1px solid var(--border2);border-radius:5px;color:var(--text);cursor:pointer">ü¶∂ Clutch</button>
        <button onclick="forcePartGuess('419768','Brake pedal arm','Bromspedalarm','51')" style="padding:5px 10px;font-size:11px;font-family:'IBM Plex Mono',monospace;background:var(--surface3);border:1px solid var(--border2);border-radius:5px;color:var(--text);cursor:pointer">üõë Brake</button>
        <button onclick="forcePartGuess('1272606','Accelerator pedal','Gaspedalarm','27')" style="padding:5px 10px;font-size:11px;font-family:'IBM Plex Mono',monospace;background:var(--surface3);border:1px solid var(--border2);border-radius:5px;color:var(--text);cursor:pointer">‚ö° Accelerator</button>
      </div>
    </div>`;
  }
  if (type.includes('hose') || type.includes('pipe')) {
    return `<div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border)">
      <div style="font-family:'IBM Plex Mono',monospace;font-size:9px;color:var(--muted);margin-bottom:6px">WHICH SYSTEM?</div>
      <div style="display:flex;gap:6px;flex-wrap:wrap">
        <button onclick="setGroupHint('26')" style="padding:5px 10px;font-size:11px;font-family:'IBM Plex Mono',monospace;background:var(--surface3);border:1px solid var(--border2);border-radius:5px;color:var(--text);cursor:pointer">üå°Ô∏è Cooling</button>
        <button onclick="setGroupHint('23')" style="padding:5px 10px;font-size:11px;font-family:'IBM Plex Mono',monospace;background:var(--surface3);border:1px solid var(--border2);border-radius:5px;color:var(--text);cursor:pointer">‚õΩ Fuel</button>
        <button onclick="setGroupHint('52')" style="padding:5px 10px;font-size:11px;font-family:'IBM Plex Mono',monospace;background:var(--surface3);border:1px solid var(--border2);border-radius:5px;color:var(--text);cursor:pointer">üõë Brake</button>
        <button onclick="setGroupHint('87')" style="padding:5px 10px;font-size:11px;font-family:'IBM Plex Mono',monospace;background:var(--surface3);border:1px solid var(--border2);border-radius:5px;color:var(--text);cursor:pointer">üå°Ô∏è Heating</button>
      </div>
    </div>`;
  }
  if (type.includes('spring')) {
    return `<div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border)">
      <div style="font-family:'IBM Plex Mono',monospace;font-size:9px;color:var(--muted);margin-bottom:6px">WHICH SYSTEM?</div>
      <div style="display:flex;gap:6px;flex-wrap:wrap">
        <button onclick="setGroupHint('72')" style="padding:5px 10px;font-size:11px;font-family:'IBM Plex Mono',monospace;background:var(--surface3);border:1px solid var(--border2);border-radius:5px;color:var(--text);cursor:pointer">üî© Front suspension</button>
        <button onclick="setGroupHint('73')" style="padding:5px 10px;font-size:11px;font-family:'IBM Plex Mono',monospace;background:var(--surface3);border:1px solid var(--border2);border-radius:5px;color:var(--text);cursor:pointer">üî© Rear suspension</button>
        <button onclick="setGroupHint('55')" style="padding:5px 10px;font-size:11px;font-family:'IBM Plex Mono',monospace;background:var(--surface3);border:1px solid var(--border2);border-radius:5px;color:var(--text);cursor:pointer">üõë Handbrake</button>
      </div>
    </div>`;
  }
  return '';
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SYNONYM SEARCH ENGINE (used by catalogue + smart search)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const SEARCH_SYNONYMS = {
  'screw':['screw','skruv','bolt','bult'],'bolt':['bolt','bult','screw','skruv'],
  'nut':['nut','mutter'],'washer':['washer','bricka','ring'],
  'gasket':['gasket','packning','seal','t√§tning'],'seal':['seal','t√§tning','gasket','packning','o-ring'],
  'bearing':['bearing','lager','kullager'],'filter':['filter','insats','filterinsats'],
  'hose':['hose','slang','pipe','r√∂r'],'pipe':['pipe','r√∂r','hose','slang'],
  'pump':['pump'],'valve':['valve','ventil'],'spring':['spring','fj√§der'],
  'bracket':['bracket','f√§ste','konsol','h√•llare'],'cover':['cover','lock','k√•pa'],
  'plug':['plug','plugg','lock'],'shaft':['shaft','axel'],'gear':['gear','kugghjul','v√§xel'],
  'cable':['cable','kabel','vajer'],'switch':['switch','brytare','kontakt'],
  'relay':['relay','rel√§'],'sensor':['sensor','givare'],
  'lamp':['lamp','lampa','bulb','gl√∂dlampa'],'bulb':['bulb','gl√∂dlampa','lamp'],
  'brake':['brake','broms'],'clutch':['clutch','koppling'],
  'pad':['pad','bel√§gg'],'disc':['disc','skiva','disk'],
  'shock':['shock','d√§mpare','st√∂td√§mpare'],'bushing':['bushing','bussning'],
  'pin':['pin','tapp','pinne','stift'],'clip':['clip','kl√§mma'],
  'rubber':['rubber','gummi'],'belt':['belt','rem','drivrem'],
  'tank':['tank','beh√•llare'],'engine':['engine','motor'],
  'radiator':['radiator','kylare'],'fan':['fan','fl√§kt'],
  'steering':['steering','styrning'],'door':['door','d√∂rr'],
  'window':['window','ruta','glas'],'seat':['seat','s√§te'],
  'exhaust':['exhaust','avgasr√∂r','avgassystem'],'intake':['intake','inlopp','luftfilter'],
  'oil':['oil','olja','sm√∂rj'],'fuel':['fuel','br√§nsle'],
  'coolant':['coolant','kylv√§tska'],'battery':['battery','batteri'],
  'alternator':['alternator','generator'],'starter':['starter','startmotor'],
  'ignition':['ignition','t√§ndning','t√§ndspole'],'axle':['axle','axel','nav'],
  'wheel':['wheel','hjul','f√§lg'],'tire':['tire','tyre','d√§ck'],
  'suspension':['suspension','fj√§dring','upph√§ngning'],'frame':['frame','ram'],
  'bumper':['bumper','st√∂tf√•ngare'],'body':['body','karosseri'],
  'heating':['heating','v√§rme'],'wiring':['wiring','ledning','kablar'],
  'fuse':['fuse','s√§kring'],'kit':['kit','sats','set'],
  'plate':['plate','pl√•t','platta'],'clamp':['clamp','kl√§mma','clips'],
  'stud':['stud','pinnbult','pinnskruv'],'ring':['ring','bricka','t√§tningsring'],
  'bush':['bush','bussning'],'cap':['cap','lock','huv'],
  'arm':['arm','l√§nk','stag'],'rod':['rod','stag','st√•ng'],
  'link':['link','l√§nk','stag'],'joint':['joint','led','knut'],
  'pedal':['pedal','pedalen'],'rim':['rim','f√§lg','hjul'],
  'coil':['coil','spole','t√§ndspole'],'carb':['carb','carburetor','f√∂rgasare'],
  'carburetor':['carburetor','carb','f√∂rgasare'],'piston':['piston','kolv'],
  'cylinder':['cylinder','cylindrar'],'head':['head','cylinder head','topplock'],
  'gasket':['gasket','packning'],'timing':['timing','distribution','kamkedja'],
};

function expandSearchTerms(query) {
  const words = query.toLowerCase().trim().split(/\s+/);
  const allTerms = new Set(words);
  for (const word of words) {
    if (SEARCH_SYNONYMS[word]) SEARCH_SYNONYMS[word].forEach(s => allTerms.add(s));
    // Plural/gerund stripping
    if (word.endsWith('s') && word.length > 3) allTerms.add(word.slice(0,-1));
    if (word.endsWith('es') && word.length > 4) allTerms.add(word.slice(0,-2));
    if (word.endsWith('ing') && word.length > 5) allTerms.add(word.slice(0,-3));
  }
  return [...allTerms];
}

function searchScore(part, terms) {
  let score = 0;
  const name = (part.name||'').toLowerCase();
  const sv   = (part.sv||'').toLowerCase();
  const no   = (part.no||'').toLowerCase();
  const g    = (part.g||'').toLowerCase();
  for (const term of terms) {
    if (no === term)          { score += 100; continue; }
    if (no.startsWith(term))  { score += 60;  continue; }
    if (no.includes(term))    { score += 40;  continue; }
    const nameWords = name.split(/\s+/);
    if (nameWords[0] === term)           { score += 50; continue; } // first word match
    if (nameWords.includes(term))        { score += 35; continue; }
    if (name.startsWith(term))           { score += 30; continue; }
    if (name.includes(term))             { score += 20; continue; }
    if (sv.includes(term))               { score += 10; continue; }
    if (g.includes(term))                { score += 5;  continue; }
  }
  return score;
}

function forcePartGuess(partNoBase, name, sv, group) {
  const dbMatch = typeof PARTS_DB !== 'undefined'
    ? PARTS_DB.find(p => p.no.replace(/-\d$/,'').replace(/[A-Z]$/,'') === partNoBase || p.no.startsWith(partNoBase))
    : null;
  const no = dbMatch ? dbMatch.no : partNoBase;
  const tatanka = getTatankaData(no);
  selectedGuess = { name: dbMatch?.name || name, sv: dbMatch?.sv || sv, no, group: dbMatch?.g || group,
                    confidence: 90, reason: 'Manually identified as ' + name, tatanka, fromManual: true };
  showToast('Selected: ' + (dbMatch?.name || name), 'success');
  showConfirmStep();
}

function setGroupHint(group) {
  document.getElementById('groupFilter').value = group;
  showStep(1);
  showToast('Filter set ‚Äî tap Analyze again', 'success');
}

function renderGuesses(guesses) {
  const container = document.getElementById('guessResults');
  if (!guesses || guesses.length === 0) {
    container.innerHTML = '<div class="empty"><div class="empty-icon">\ud83e\udd37</div><div class="empty-title">NO MATCHES FOUND</div><div class="empty-text">Try a different angle or use the Unknown option.</div></div>';
    return;
  }

  container.innerHTML = guesses.map((g, i) => {
    const tatankaItems = g.tatanka || [];
    const bestTatanka = tatankaItems.find(t => !t.is_used) || tatankaItems[0];
    const priceEur = bestTatanka ? sekToEur(bestTatanka.price_sek) : null;
    const thumb = bestTatanka && bestTatanka.image_local ?
      `<img class="guess-thumb" src="${bestTatanka.image_local}" alt="">` :
      `<div class="guess-thumb-placeholder">\ud83d\udd27</div>`;
    const confColor = g.confidence >= 70 ? 'var(--green)' : g.confidence >= 40 ? 'var(--accent)' : 'var(--red)';

    return `<div class="guess-card" onclick="selectGuess(${i},this)" id="guess${i}">
      ${thumb}
      <div class="guess-info">
        <div class="guess-rank">MATCH #${i+1}</div>
        <div class="guess-name">${g.name || 'Unknown Part'}</div>
        <div class="guess-no">${g.no || '\u2014'}</div>
        ${g.reason ? `<div class="guess-desc">${g.reason}</div>` : ''}
        <div class="conf-bar-wrap">
          <div class="conf-bar"><div class="conf-fill" style="width:${g.confidence||0}%;background:${confColor}"></div></div>
          <span style="font-family:'IBM Plex Mono',monospace;font-size:10px;color:${confColor}">${g.confidence||0}%</span>
        </div>
        <div class="guess-meta">
          ${tatankaItems.length > 0 ? getStockBadge(bestTatanka.stock) : '<span class="badge badge-muted">Not on Tatanka</span>'}
          ${priceEur ? `<span class="badge badge-green">~${formatEur(priceEur)}</span>` : ''}
        </div>
      </div>
    </div>`;
  }).join('');
}

function selectGuess(index, el) {
  document.querySelectorAll('.guess-card').forEach(c => c.classList.remove('selected'));
  el.classList.add('selected');
  selectedGuess = currentGuesses[index];
  setTimeout(() => showConfirmStep(), 300);
}

function selectTatankaCandidate() { console.warn("selectTatankaCandidate not implemented"); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AI PHOTO ANALYSIS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function analyzePhoto(useSonnet = false) {
  if (!currentPhoto) { showToast('No photo to analyze', 'error'); return; }

  const apiKey = SETTINGS.apiKey;
  if (!apiKey) { showToast('Add Claude API key in Settings', 'error'); return; }

  const btn    = document.getElementById('analyzeBtn');
  const btnTxt = document.getElementById('analyzeBtnText');
  const spinner= document.getElementById('analyzeSpinner');
  btn.disabled = true;
  spinner.style.display = 'inline-block';

  // Build catalogue sample for context (first 60 parts)
  const catalogueSample = typeof PARTS_DB !== 'undefined'
    ? PARTS_DB.slice(0, 60).map(p => `${p.no} ‚Äî ${p.name} (${p.sv||''})`).join('\n')
    : '';

  // Build Tatanka URL hints from matched parts
  const tatankaHints = typeof TATANKA_DB !== 'undefined'
    ? Object.keys(TATANKA_DB).slice(0, 20).map(k => {
        const t = TATANKA_DB[k][0];
        return t ? `${k}: ${t.name} ‚Äî ${t.product_url}` : null;
      }).filter(Boolean).join('\n')
    : '';

  // Get user-set system filter if any
  const systemFilter = document.getElementById('groupFilter')?.value || '';

  const systemPrompt = `You are an expert mechanic specializing in Swedish vintage vehicles, specifically the Volvo C303 (also known as the TGB 11 or Laplander). This is a Swedish military 6√ó6 off-road vehicle produced from 1974 to 1981, powered by the B30 engine (3-litre inline-6). You must identify spare parts from photographs.

VEHICLE CONTEXT:
- Volvo C303 / TGB 11 / Laplander
- Engine: Volvo B30 (3.0L inline-6 petrol)
- Transmission: Volvo M41 4-speed + Volvo VPS transfer case
- Suspension: Portal axles (Husqvarna design), coil springs
- Era: 1974‚Äì1981 Swedish military production
- Uses many parts shared with Volvo Amazon, 140 series, P1800, and early 240 series
- Unique military parts: portal axle hubs, power take-off, capstan winch, convoy lighting

PARTS CATALOGUE SAMPLE (use these for part number matching):
${catalogueSample}

TATANKA REFERENCE PRICES (tatanka.nu sells new/used Volvo parts):
${tatankaHints}

IDENTIFICATION RULES:
1. Identify the part type first (e.g. "clutch pedal arm", "water pump", "fuel filter")
2. Cross-reference with the catalogue sample above ‚Äî if you see a close match, include the part number
3. If unsure between similar variants (e.g. clutch vs brake pedal), list ALL plausible variants
4. For pedals: clutch=leftmost/longest, brake=widest footpad, accelerator=narrowest/rightmost
5. Condition: examine wear, rust, cracks, missing pieces
6. Note if the part appears to be a Bosch, SU, Zenith, or Stromberg branded component (common on these vehicles)
${systemFilter ? `7. User has indicated this is a ${systemFilter} part ‚Äî prioritize matches in this category` : ''}

Respond ONLY with valid JSON:
{
  "guesses": [
    {
      "sv": "Swedish part name",
      "no": "part number if identifiable or empty string",
      "confidence": 0-100,
      "condition": "good|fair|poor",
      "notes": "brief identifying notes"
    }
  ],
  "ai_sees": "What you observe in the image: shape, material, markings, condition",
  "vehicle_notes": "Why this part fits the Volvo C303 specifically"
}`;

  try {
    btnTxt.textContent = 'ANALYZING...';

    const model = useSonnet ? 'claude-sonnet-4-5' : 'claude-haiku-4-5-20251001';
    const images = [{ type:'base64', media_type:'image/jpeg', data: currentPhoto }];
    if (extraAngles.length > 0) {
      extraAngles.forEach(a => images.push({ type:'base64', media_type:'image/jpeg', data: a }));
    }

    const contentBlocks = images.map(img => ({ type:'image', source: img }));
    contentBlocks.push({ type:'text', text: 'Identify this Volvo C303 spare part.' });

    const resp = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01',
        'content-type': 'application/json',
        'anthropic-dangerous-direct-browser-access': 'true',
      },
      body: JSON.stringify({
        model,
        max_tokens: 1000,
        system: systemPrompt,
        messages: [{ role:'user', content: contentBlocks }]
      })
    });

    if (!resp.ok) {
      const err = await resp.json().catch(() => ({}));
      throw new Error(err.error?.message || `API ${resp.status}`);
    }

    const data = await resp.json();
    const raw = data.content[0]?.text || '';
    const jsonMatch = raw.match(/\{[\s\S]*\}/);
    if (!jsonMatch) throw new Error('No JSON in response');
    const parsed = JSON.parse(jsonMatch[0]);

    const guesses = (parsed.guesses || []).map(g => {
      const dbMatch = typeof PARTS_DB !== 'undefined'
        ? PARTS_DB.find(p => p.no === g.no || p.name.toLowerCase() === (g.name||'').toLowerCase())
        : null;
      if (dbMatch) { g.no = dbMatch.no; g.sv = dbMatch.sv || g.sv; }
      g.tatanka = getTatankaData(g.no);
      return g;
    });

    currentGuesses = guesses;

    // Show AI Sees panel
    const aiSeesPanel = document.getElementById('aiSees');
    if (aiSeesPanel && parsed.ai_sees) {
      aiSeesPanel.style.display = 'block';
      aiSeesPanel.innerHTML = `<div style="font-family:'IBM Plex Mono',monospace;font-size:9px;color:var(--muted);letter-spacing:1px;margin-bottom:4px">AI SEES</div>
        <div style="font-size:12px;color:var(--text2)">${parsed.ai_sees}</div>
        ${parsed.vehicle_notes ? `<div style="font-size:11px;color:var(--accent);margin-top:4px">üöô ${parsed.vehicle_notes}</div>` : ''}`;
    }

    // Auto-apply best guess if high confidence
    if (guesses.length > 0 && guesses[0].confidence >= 70) {
      selectedGuess = guesses[0];
      showConfirmStep();
    } else if (guesses.length > 0) {
      // Show options ‚Äî populate AI results panel
      selectedGuess = guesses[0];
      showConfirmStep();
    } else {
      showToast('Could not identify part ‚Äî try a different angle', 'error');
    }

  } catch(err) {
    showToast('AI error: ' + err.message, 'error');
    console.error(err);
  } finally {
    btn.disabled = false;
    btnTxt.textContent = 'üîç RUN AI IDENTIFICATION';
    spinner.style.display = 'none';
  }
}

function showConfirmStep() {
  if (!selectedGuess) return;
  const g = selectedGuess;

  // Fill step 1 manual fields
  if (g.name) document.getElementById('manualName').value = g.name;
  if (g.no)   document.getElementById('manualPartNo').value = g.no || '';
  if (g.sv)   document.getElementById('manualNameSv').value = g.sv || '';
  if (g.group) document.getElementById('manualGroup').value = g.group || '';

  // Update smart search display
  if (g.name) {
    document.getElementById('smartSearch').value = g.name;
    document.getElementById('selectedPartName').textContent = g.name;
    document.getElementById('selectedPartNo').textContent = g.no || '‚Äî';
    document.getElementById('selectedPartSv').textContent = g.sv || '';
    document.getElementById('selectedPartPreview').style.display = 'block';
    partSelected = true;
  }

  // Suggest box from inventory
  if (g.no) suggestBoxForPart(g.no);

  // Populate step 3 summary
  const tatankaItems = g.tatanka || [];
  const thumb = tatankaItems[0]?.image_local
    ? `<img src="${tatankaItems[0].image_local}" style="width:64px;height:64px;border-radius:6px;object-fit:cover;border:1px solid var(--accent)">`
    : `<div style="width:64px;height:64px;border-radius:6px;background:var(--surface3);border:1px solid var(--accent);display:flex;align-items:center;justify-content:center;font-size:28px">üîß</div>`;
  const summaryEl = document.getElementById('confirmedPartSummary');
  if (summaryEl) {
    summaryEl.innerHTML = `<div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
      ${thumb}
      <div>
        <div style="font-size:16px;font-weight:600;margin-bottom:3px">${g.name}</div>
        <div style="font-family:'IBM Plex Mono',monospace;font-size:12px;color:var(--accent)">${g.no || '‚Äî'}</div>
        ${g.sv ? `<div style="font-size:12px;color:var(--text2)">${g.sv}</div>` : ''}
      </div>
    </div>`;
  }

  const tpEl = document.getElementById('tatankaPanelConfirm');
  if (tpEl) tpEl.innerHTML = buildTatankaPanel(tatankaItems, g.no);

  const suggested = getSuggestedPrice(tatankaItems);
  if (suggested) document.getElementById('confirmPrice').value = suggested.toFixed(2);

  // Render Tatanka picker
  renderTatankaMatchOptions();

  showToast('Part identified ‚úì', 'success');
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DIAGRAM VIEWER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let _dvState = {
  partNo: null, partName: null,
  currentTab: null,
  myPhotos: [], defaultIndex: 0, activePhotoIdx: 0,
  tatankaItems: [],
  diagramSrc: null,       // URL or base64 of diagram page image
  posNumber: null,        // position number in diagram
  occurrences: [],        // [{x, y}] as fractions of image dims (0-1)
  activeOccurrence: 0,
  diagramImg: null,       // loaded Image object
};

function openDiagramViewer(partNo, partName, opts = {}) {
  // opts: { startTab, tatankaItems, diagramSrc, posNumber, occurrences }
  const pp = getPartPhotos(partNo);
  _dvState = {
    partNo, partName,
    currentTab: null,
    myPhotos: pp.photos,
    defaultIndex: pp.defaultIndex || 0,
    activePhotoIdx: pp.defaultIndex || 0,
    tatankaItems: opts.tatankaItems || [],
    diagramSrc: opts.diagramSrc || null,
    posNumber: opts.posNumber || null,
    occurrences: opts.occurrences || [],
    activeOccurrence: 0,
    diagramImg: null,
  };

  document.getElementById('dvTitle').textContent = partName || 'Part';
  document.getElementById('dvSub').textContent = partNo || '';

  // Configure tabs availability
  const hasMyPhotos = _dvState.myPhotos.length > 0;
  const hasTatanka  = _dvState.tatankaItems.length > 0;
  const hasDiagram  = !!_dvState.diagramSrc;

  document.getElementById('dvTabMyPhotos').disabled = !hasMyPhotos;
  document.getElementById('dvTabTatanka').disabled  = !hasTatanka;
  document.getElementById('dvTabDiagram').disabled  = !hasDiagram;

  // Priority: myPhoto > tatanka > diagram
  const startTab = opts.startTab ||
    (hasMyPhotos ? 'myPhotos' : hasTatanka ? 'tatanka' : 'diagram');

  document.getElementById('diagramModal').classList.add('open');
  dvSetTab(startTab);
}

function closeDiagramViewer() {
  document.getElementById('diagramModal').classList.remove('open');
  _dvState.diagramImg = null;
}

function dvSetTab(tab) {
  _dvState.currentTab = tab;
  ['myPhotos','tatanka','diagram'].forEach(t => {
    document.getElementById('dvTab' + t.charAt(0).toUpperCase() + t.slice(1)).classList.toggle('active', t === tab);
    document.getElementById('dvPane' + t.charAt(0).toUpperCase() + t.slice(1)).classList.toggle('active', t === tab);
  });
  if (tab === 'myPhotos') dvRenderMyPhotos();
  if (tab === 'tatanka')  dvRenderTatanka();
  if (tab === 'diagram')  dvRenderDiagram();
}

// ‚îÄ‚îÄ MY PHOTOS PANE ‚îÄ‚îÄ
function dvRenderMyPhotos() {
  const photos = _dvState.myPhotos;
  const idx = _dvState.activePhotoIdx;
  const isDefault = idx === _dvState.defaultIndex;

  const imgEl = document.getElementById('dvMyPhotoImg');
  if (photos.length > 0) {
    imgEl.src = photos[idx];
    imgEl.style.display = '';
  } else {
    imgEl.style.display = 'none';
  }

  document.getElementById('dvStarBadge').style.display = isDefault ? '' : 'none';
  document.getElementById('dvSetDefaultBtn').style.display = (!isDefault && photos.length > 0) ? '' : 'none';

  // Strip thumbnails
  const strip = document.getElementById('dvPhotoStrip');
  strip.innerHTML = photos.map((src, i) => {
    const isActive = i === idx;
    const isDef = i === _dvState.defaultIndex;
    return `<div style="position:relative;flex-shrink:0">
      <img src="${src}" class="dv-photo-thumb${isActive ? ' active-thumb' : ''}" onclick="dvSelectPhoto(${i})">
      ${isDef ? '<div style="position:absolute;bottom:2px;right:2px;background:var(--accent);color:#000;font-size:8px;font-weight:700;padding:1px 4px;border-radius:3px">‚òÖ</div>' : ''}
    </div>`;
  }).join('');
}

function dvSelectPhoto(idx) {
  _dvState.activePhotoIdx = idx;
  dvRenderMyPhotos();
}

function dvSetCurrentAsDefault() {
  const partNo = _dvState.partNo;
  if (!partNo) return;
  if (!PART_PHOTOS[partNo]) PART_PHOTOS[partNo] = { photos: _dvState.myPhotos, defaultIndex: 0 };
  PART_PHOTOS[partNo].defaultIndex = _dvState.activePhotoIdx;
  _dvState.defaultIndex = _dvState.activePhotoIdx;
  saveInventory();
  showToast('Default image updated ‚úì', 'success');
  dvRenderMyPhotos();
}

function dvAddPhoto() {
  document.getElementById('dvPhotoInput').click();
}

async function dvHandleNewPhoto(evt) {
  const file = evt.target.files[0];
  if (!file) return;
  evt.target.value = '';
  const dataURL = await new Promise(r => {
    const fr = new FileReader();
    fr.onload = e => r(e.target.result);
    fr.readAsDataURL(file);
  });

  const partNo = _dvState.partNo;
  const tatankaHasImage = _dvState.tatankaItems.some(t => t.image_local);
  const pp = getPartPhotos(partNo);
  const isFirst = pp.photos.length === 0;

  if (!PART_PHOTOS[partNo]) PART_PHOTOS[partNo] = { photos: [], defaultIndex: 0 };
  PART_PHOTOS[partNo].photos.push(dataURL);
  const newIdx = PART_PHOTOS[partNo].photos.length - 1;

  if (isFirst && !tatankaHasImage) {
    PART_PHOTOS[partNo].defaultIndex = newIdx;
    saveInventory();
    showToast('Photo saved as default image', 'success');
  } else {
    const existingLabel = !isFirst
      ? `${pp.photos.length} existing photo(s)`
      : 'Tatanka catalogue image';
    const setDef = await showPhotoDefaultPrompt(dataURL, existingLabel);
    if (setDef) PART_PHOTOS[partNo].defaultIndex = newIdx;
    saveInventory();
    showToast(setDef ? 'Set as default ‚úì' : 'Photo added to library', 'success');
  }

  // Refresh state
  const updated = getPartPhotos(partNo);
  _dvState.myPhotos = updated.photos;
  _dvState.defaultIndex = updated.defaultIndex;
  _dvState.activePhotoIdx = newIdx;

  // Enable My Photos tab if it was disabled
  document.getElementById('dvTabMyPhotos').disabled = false;
  dvRenderMyPhotos();
}

// ‚îÄ‚îÄ TATANKA PANE ‚îÄ‚îÄ
function dvRenderTatanka() {
  const items = _dvState.tatankaItems;
  const list = document.getElementById('dvTatankaList');
  if (items.length === 0) {
    list.innerHTML = `<div class="empty"><div class="empty-icon">üè∑</div><div class="empty-title">NOT ON TATANKA</div><div class="empty-text">No listings found for this part number.</div></div>`;
    return;
  }
  list.innerHTML = items.map(t => {
    const eur = sekToEur(t.price_sek);
    return `<div class="dv-tatanka-card">
      ${t.image_local ? `<img src="${t.image_local}" alt="">` : `<div class="dv-tatanka-card-ph">üîß</div>`}
      <div class="dv-tatanka-info">
        <div class="dv-tatanka-name">${t.name || _dvState.partName}</div>
        <div class="dv-tatanka-price">${formatEur(eur)}</div>
        <div class="dv-tatanka-meta">${t.price_sek ? t.price_sek + ' SEK' : ''} ${t.stock ? '¬∑ ' + t.stock.replace('_',' ') : ''}</div>
        ${t.url ? `<a href="${t.url}" target="_blank" style="font-size:11px;color:var(--blue);text-decoration:none;margin-top:4px;display:inline-block">View on Tatanka ‚Üí</a>` : ''}
      </div>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ DIAGRAM PANE ‚îÄ‚îÄ
function dvRenderDiagram() {
  const src = _dvState.diagramSrc;
  if (!src) {
    document.getElementById('dvDiagramCanvas').getContext('2d').clearRect(0,0,1,1);
    document.getElementById('dvOccurrenceStrip').innerHTML = `<span class="dv-many-label">No diagram available</span>`;
    return;
  }

  dvRenderOccurrenceStrip();

  const img = new Image();
  img.onload = () => {
    _dvState.diagramImg = img;
    dvDrawDiagram();
  };
  img.src = src;
}

function dvRenderOccurrenceStrip() {
  const occ = _dvState.occurrences;
  const strip = document.getElementById('dvOccurrenceStrip');
  const posNo = _dvState.posNumber;

  // Threshold logic: 1-5 = individual chips, 6+ = collective label
  if (occ.length === 0) {
    strip.innerHTML = posNo
      ? `<span class="dv-many-label">Pos ${posNo} ‚Äî location unknown</span>`
      : `<span class="dv-many-label">Full diagram</span>`;
  } else if (occ.length >= 6) {
    strip.innerHTML = `<span class="dv-many-label">Pos ${posNo} ‚Äî √ó${occ.length} throughout assembly</span>`;
  } else {
    strip.innerHTML = occ.map((o, i) =>
      `<div class="dv-occurrence-chip${i === _dvState.activeOccurrence ? ' active' : ''}" onclick="dvSelectOccurrence(${i})">
        <div class="dv-occurrence-dot"></div>
        ${occ.length > 1 ? `Instance ${i+1}` : `Pos ${posNo}`}
      </div>`
    ).join('');
  }
}

function dvSelectOccurrence(idx) {
  _dvState.activeOccurrence = idx;
  dvRenderOccurrenceStrip();
  dvDrawDiagram();
}

function dvDrawDiagram() {
  const img = _dvState.diagramImg;
  if (!img) return;

  const wrap = document.querySelector('.dv-diagram-wrap');
  const canvas = document.getElementById('dvDiagramCanvas');
  const ctx = canvas.getContext('2d');

  const maxW = wrap.clientWidth;
  const maxH = wrap.clientHeight - 8;
  const scale = Math.min(maxW / img.width, maxH / img.height);
  canvas.width  = Math.round(img.width * scale);
  canvas.height = Math.round(img.height * scale);

  // Draw image cleanly ‚Äî no dimming, no circles
  ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

  // Hide zoom panel ‚Äî not used in this approach
  document.getElementById('dvZoomPanel').style.display = 'none';

  // Show position callout banner
  const posNo = _dvState.posNumber;
  const occ = _dvState.occurrences;
  const banner = document.getElementById('dvPosBanner');
  if (posNo && banner) {
    const occCount = occ.length;
    banner.style.display = '';
    if (occCount > 1) {
      banner.innerHTML = `Look for <strong>position ${posNo}</strong> on this diagram &nbsp;¬∑&nbsp; appears <strong>${occCount}√ó</strong>`;
    } else {
      banner.innerHTML = `Look for <strong>position ${posNo}</strong> on this diagram`;
    }
  } else if (banner) {
    banner.style.display = 'none';
  }
}

function dvDrawZoom() {} // no-op ‚Äî zoom replaced by full diagram view

// Open viewer from an inventory item or catalogue entry
function openPartViewer(partNo, partName) {
  const tatankaItems = getTatankaData(partNo);
  const diagData = getDiagramData(partNo);

  let diagramSrc = null, posNumber = null, occurrences = [];
  if (diagData) {
    diagramSrc = getDiagramPageURL(diagData.group, diagData.diagramPage);
    posNumber   = diagData.pos;
    occurrences = diagData.occurrences || [];
  }

  openDiagramViewer(partNo, partName, {
    tatankaItems,
    diagramSrc,
    posNumber,
    occurrences,
  });
}

function buildTatankaPanel(items, partNo) {
  if (!items || items.length === 0) return '';
  const rows = items.slice(0,3).map(t => {
    const eur = sekToEur(t.price_sek);
    return `<div class="tatanka-row">
      ${t.image_local ? `<img class="tatanka-img" src="${t.image_local}" alt="">` : `<div class="tatanka-img-ph">\ud83d\udd27</div>`}
      <div class="tatanka-info">
        <div class="tatanka-name">${t.name}</div>
        <div class="tatanka-price">${eur ? formatEur(eur) : 'Price on request'} <span class="tatanka-sek">${formatSek(t.price_sek)}</span></div>
        <div style="margin-top:3px">${getStockBadge(t.stock)} ${t.is_used ? '<span class="badge badge-muted">USED</span>' : t.is_upgrade ? '<span class="badge badge-blue">UPGRADE</span>' : '<span class="badge badge-yellow">ORIGINAL</span>'}</div>
        ${t.image_reference_only ? '<div style="font-size:9px;color:var(--muted);margin-top:2px">* image for reference only</div>' : ''}
      </div>
      <a class="tatanka-link" href="${t.product_url}" target="_blank">VIEW \u2192</a>
    </div>`;
  }).join('');

  return `<div class="tatanka-panel">
    <div class="tatanka-header">\ud83c\udfea TATANKA.NU</div>
    ${rows}
  </div>`;
}

async function retryAnalysis() {
  identifyAttempt++;
  showStep(1);
  await analyzePhoto();
}

function addAsUnknown() {
  openModal('unknownForm');
}

async function saveUnknownPart(form) {
  const name = document.getElementById('unknownName').value.trim();
  const box = document.getElementById('unknownBox').value.trim();
  const qty = parseInt(document.getElementById('unknownQty').value) || 1;
  if (!box) { showToast('Box number required', 'error'); return; }

  let photoPath = null;
  if (currentPhotoBlob) {
    const reader = new FileReader();
    photoPath = await new Promise(resolve => {
      reader.onload = e => resolve(e.target.result);
      reader.readAsDataURL(currentPhotoBlob);
    });
  }

  const item = {
    id: Date.now(),
    partNo: 'UNKNOWN-' + String(INVENTORY.filter(i=>i.isUnknown).length + 1).padStart(4,'0'),
    name: name || 'Unknown Part',
    box: box, qty: qty,
    photo: photoPath,
    status: 'available',
    isUnknown: true,
    addedDate: new Date().toISOString(),
    askingPrice: 0,
  };

  INVENTORY.push(item);
  saveInventory();
  closeModal();
  showToast('Saved to Unknown pile', 'success');
  showScreen('inventory');
}

function setEntryMode(mode) {
  entryMode = mode;
  document.getElementById('entryModeCatalogue').style.display = mode === 'catalogue' ? 'block' : 'none';
  document.getElementById('entryModeCustom').style.display    = mode === 'custom'    ? 'block' : 'none';
  document.getElementById('modeTabCatalogue').style.background = mode === 'catalogue' ? 'var(--accent)' : 'var(--surface2)';
  document.getElementById('modeTabCatalogue').style.color      = mode === 'catalogue' ? '#000' : 'var(--muted)';
  document.getElementById('modeTabCustom').style.background    = mode === 'custom'    ? 'var(--accent)' : 'var(--surface2)';
  document.getElementById('modeTabCustom').style.color         = mode === 'custom'    ? '#000' : 'var(--muted)';
}

function onSmartSearch(val) {
  const el = document.getElementById('smartSearchResults');
  if (!val || val.trim().length < 2) {
    el.style.display = 'none'; return;
  }
  if (typeof PARTS_DB === 'undefined' || PARTS_DB.length === 0) {
    el.style.display = 'block';
    el.innerHTML = '<div style="padding:10px 12px;font-size:12px;color:var(--muted)">‚ö†Ô∏è Parts catalogue not loaded ‚Äî check PARTS_DB.js is in the same folder</div>';
    return;
  }
  const q = val.trim();
  const isPartNo = /^\d/.test(q);
  let results;
  if (isPartNo) {
    results = PARTS_DB.filter(p => p.no.startsWith(q) || p.no.replace(/-\d$/,'').startsWith(q)).slice(0, 8);
    if (results.length === 0) results = PARTS_DB.filter(p => p.no.includes(q)).slice(0, 8);
  } else {
    const terms = expandSearchTerms(q);
    results = PARTS_DB.map(p => ({ p, score: searchScore(p, terms) })).filter(x => x.score > 0)
      .sort((a, b) => b.score - a.score).slice(0, 8).map(x => x.p);
  }
  if (results.length === 0) {
    el.style.display = 'block';
    el.innerHTML = '<div style="padding:10px 12px;font-size:12px;color:var(--muted)">No matches ‚Äî try different words, or switch to Custom Part</div>';
    return;
  }
  el.style.display = 'block';
  el.innerHTML = results.map(p => {
    const tatanka = getTatankaData(p.no);
    const best = tatanka.find(t => !t.is_used) || tatanka[0];
    const priceHint = best && sekToEur(best.price_sek) ? ` ¬∑ ~${formatEur(sekToEur(best.price_sek))}` : '';
    const diagData = getDiagramData(p.no);
    const thumbSrc = best?.image_local || (diagData ? getDiagramPageURL(diagData.group, diagData.diagramPage) : null);
    return `<div onclick="applyPartFromDB('${p.no.replace(/'/g,"\'")}','${p.name.replace(/'/g,"\'")}','${(p.sv||'').replace(/'/g,"\'")}','${p.g}')"
      style="padding:9px 12px;cursor:pointer;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px">
      ${thumbSrc ? `<img src="${thumbSrc}" style="width:36px;height:36px;border-radius:4px;object-fit:cover;flex-shrink:0">` : '<div style="width:36px;height:36px;border-radius:4px;background:var(--surface3);display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0">üîß</div>'}
      <div style="flex:1;min-width:0">
        <div style="font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${p.name}</div>
        <div style="font-family:'IBM Plex Mono',monospace;font-size:10px;color:var(--accent)">${p.no}</div>
        <div style="font-size:10px;color:var(--muted)">${p.sv || ''}${tatanka.length > 0 ? '<span style="color:var(--green)">  ‚úì Tatanka' + priceHint + '</span>' : (diagData ? '<span style="color:var(--blue)">  üìê Diagram</span>' : '')}</div>
      </div>
    </div>`;
  }).join('');
}

function clearSelectedPart() {
  partSelected = false;
  document.getElementById('selectedPartPreview').style.display = 'none';
  document.getElementById('smartSearch').value = '';
  document.getElementById('smartSearchResults').style.display = 'none';
  document.getElementById('manualPartNo').value = '';
  document.getElementById('manualName').value = '';
  document.getElementById('manualNameSv').value = '';
  document.getElementById('manualGroup').value = '';
  selectedGuess = null;
  suggestBoxForPart('');
}

function applyPartFromDB(no, name, sv, group) {
  document.getElementById('smartSearch').value = name;
  document.getElementById('smartSearchResults').style.display = 'none';
  document.getElementById('manualPartNo').value = no;
  document.getElementById('manualName').value = name;
  document.getElementById('manualNameSv').value = sv;
  document.getElementById('manualGroup').value = group || '';
  document.getElementById('selectedPartName').textContent = name;
  document.getElementById('selectedPartNo').textContent = no || '‚Äî no part number';
  document.getElementById('selectedPartSv').textContent = sv || '';

  // Show image: priority = myPhoto > tatanka > diagram
  const myPhoto = getDefaultPartPhoto(no);
  const tatanka = getTatankaData(no);
  const bestT = tatanka.find(t => !t.is_used) || tatanka[0];
  const diagData = getDiagramData(no);
  const imgSrc = myPhoto || bestT?.image_local || (diagData ? getDiagramPageURL(diagData.group, diagData.diagramPage) : null);
  const imgEl = document.getElementById('selectedPartImg');
  const phEl  = document.getElementById('selectedPartImgPh');
  const badgeEl = document.getElementById('selectedPartDiagBadge');
  if (imgSrc) {
    imgEl.src = imgSrc;
    imgEl.style.display = 'block';
    phEl.style.display = 'none';
  } else {
    imgEl.style.display = 'none';
    phEl.style.display = 'flex';
  }
  if (badgeEl) badgeEl.style.display = diagData && !myPhoto && !bestT?.image_local ? '' : 'none';

  document.getElementById('selectedPartPreview').style.display = 'block';
  partSelected = true;
  selectedGuess = { no, name, sv, group, confidence: 100, tatanka, fromManual: true };
  suggestBoxForPart(no);
}

function onPartNoInput() {}

function lookupPartNo() {}

function suggestBoxForPart(partNo) {
  const el = document.getElementById('boxSuggestion');
  if (!partNo || INVENTORY.length === 0) { el.style.display = 'none'; return; }
  const existing = INVENTORY.find(i => i.partNo === partNo && i.status !== 'sold');
  if (existing) {
    el.style.display = 'block';
    el.innerHTML = `Same part in Box <b>${existing.box}</b> ‚Äî <span onclick="document.getElementById('manualBox').value='${existing.box}';this.parentElement.style.display='none'" style="color:var(--accent);text-decoration:underline">use same box</span>`;
    document.getElementById('manualBox').value = existing.box;
    return;
  }
  const grp = document.getElementById('manualGroup') ? document.getElementById('manualGroup').value : '';
  if (grp && INVENTORY.length > 0) {
    const sameGroup = INVENTORY.filter(i => i.group === grp && i.status !== 'sold');
    if (sameGroup.length > 0) {
      const boxCounts = {};
      sameGroup.forEach(i => { boxCounts[i.box] = (boxCounts[i.box]||0) + 1; });
      const topBox = Object.entries(boxCounts).sort((a,b) => b[1]-a[1])[0][0];
      el.style.display = 'block';
      el.innerHTML = `Similar parts in Box <b>${topBox}</b> ‚Äî <span onclick="document.getElementById('manualBox').value='${topBox}';this.parentElement.style.display='none'" style="color:var(--accent);text-decoration:underline">use same box</span> <span style="color:var(--muted)">(or edit)</span>`;
    }
  } else { el.style.display = 'none'; }
}

function goToPhotoStep() {
  const box = document.getElementById('manualBox').value.trim();
  if (!box) { showToast('Box number is required', 'error'); return; }
  if (entryMode === 'custom') {
    const name = document.getElementById('customName').value.trim();
    if (!name) { showToast('Part name is required', 'error'); return; }
    const brand = document.getElementById('customBrand').value.trim();
    const sourceUrl = document.getElementById('customSourceUrl').value.trim();
    selectedGuess = { no: '', name, sv: '', group: '', confidence: 100, tatanka: [],
                      fromManual: true, isCustom: true, brand, sourceUrl };
    document.getElementById('manualName').value = name;
    document.getElementById('manualPartNo').value = '';
    document.getElementById('manualNameSv').value = '';
  } else {
    const name = document.getElementById('manualName').value.trim();
    if (!name) { showToast('Please select a part from the search results', 'error'); return; }
    if (!partSelected && !selectedGuess) { showToast('Please select a part from the dropdown', 'error'); return; }
  }
  showStep(2);
}

function clearAiResults() {
  document.getElementById('aiResults').style.display = 'none';
  document.getElementById('guessResults').innerHTML = '';
  document.getElementById('analyzeBtn').disabled = !currentPhoto;
}

function goToPriceStep() {
  const name = document.getElementById('manualName').value.trim();
  const no   = document.getElementById('manualPartNo').value.trim();
  const sv   = document.getElementById('manualNameSv').value.trim();
  if (!name) { showToast('Go back and enter part name', 'error'); return; }
  if (!selectedGuess || selectedGuess.fromManual) {
    const isCustom = entryMode === 'custom';
    const customBrand = isCustom ? document.getElementById('customBrand').value.trim() : '';
    const sourceUrl   = isCustom ? document.getElementById('customSourceUrl').value.trim() : '';
    selectedGuess = { no, name, sv, group: '', confidence: 100,
                      tatanka: no ? getTatankaData(no) : [],
                      fromManual: true, isCustom, brand: customBrand, sourceUrl };
  }
  const g = selectedGuess;
  const thumb = currentPhoto
    ? `<img src="data:image/jpeg;base64,${currentPhoto}" style="width:64px;height:64px;border-radius:6px;object-fit:cover;border:1px solid var(--accent);flex-shrink:0">`
    : `<div style="width:64px;height:64px;border-radius:6px;background:var(--surface3);border:1px solid var(--accent);display:flex;align-items:center;justify-content:center;font-size:28px;flex-shrink:0">üîß</div>`;
  document.getElementById('confirmedPartSummary').innerHTML = `
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
      ${thumb}
      <div>
        <div style="font-size:16px;font-weight:600;margin-bottom:3px">${g.name}</div>
        ${g.no ? `<div style="font-family:'IBM Plex Mono',monospace;font-size:12px;color:var(--accent)">${g.no}</div>` : ''}
        ${g.sv ? `<div style="font-size:12px;color:var(--text2)">${g.sv}</div>` : ''}
        <div style="margin-top:4px;display:flex;gap:6px;flex-wrap:wrap">
          <span class="badge badge-muted">üì¶ Box ${document.getElementById('manualBox').value}</span>
          <span class="badge badge-muted">√ó${document.getElementById('manualQty').value||1}</span>
          ${getConditionBadge(currentCondition)}
        </div>
      </div>
    </div>`;
  renderTatankaMatchOptions(g.tatanka || []);
  showStep(3);
}

function renderTatankaMatchOptions(items) {
  const card = document.getElementById('tatankaMatchCard');
  const optEl = document.getElementById('tatankaMatchOptions');
  const noMatch = document.getElementById('tatankaNoMatch');
  const shortcuts = document.getElementById('priceShortcuts');
  selectedTatankaRef = null;
  document.getElementById('tatankaSelectedRef').style.display = 'none';
  shortcuts.innerHTML = '';
  if (!items || items.length === 0) { card.style.display = 'block'; optEl.style.display = 'none'; noMatch.style.display = 'block'; return; }
  card.style.display = 'block'; noMatch.style.display = 'none'; optEl.style.display = 'block';
  optEl.innerHTML = items.map((t, i) => {
    const eur = sekToEur(t.price_sek);
    const typeLabel = t.is_used ? 'üîß Used' : t.is_upgrade ? '‚¨ÜÔ∏è Upgrade' : '‚ú® Original/New';
    const discountIn  = eur ? Math.round(eur * SETTINGS.discountIn  / 100 * 100) / 100 : 0;
    const discountOut = eur ? Math.round(eur * SETTINGS.discountOut / 100 * 100) / 100 : 0;
    const suggested = (t.stock === 'temp_finished' || t.stock === 'out_of_stock') ? discountOut : discountIn;
    return `<div class="tatanka-match-option" id="tatankaOpt${i}" onclick="selectTatankaRef(${i})"
        style="border:2px solid var(--border);border-radius:var(--radius);padding:10px;margin-bottom:8px;cursor:pointer;transition:border-color 0.15s">
      <div style="display:flex;gap:10px;align-items:flex-start">
        ${t.image_local ? `<img src="${t.image_local}" style="width:52px;height:52px;border-radius:5px;object-fit:cover;flex-shrink:0">` : '<div style="width:52px;height:52px;border-radius:5px;background:var(--surface3);display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0">üîß</div>'}
        <div style="flex:1;min-width:0">
          <div style="font-size:13px;font-weight:600;margin-bottom:2px">${t.name}</div>
          <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:4px"><span class="badge badge-muted">${typeLabel}</span>${getStockBadge(t.stock)}</div>
          <div style="font-family:'IBM Plex Mono',monospace;font-size:13px;color:var(--accent);font-weight:600">${eur ? formatEur(eur) : '‚Äî'} <span style="color:var(--muted);font-size:10px">${formatSek(t.price_sek)}</span></div>
          <div style="font-size:11px;color:var(--text2);margin-top:2px">Suggested: <b style="color:var(--green)">${formatEur(suggested)}</b> (${(t.stock === 'temp_finished'||t.stock==='out_of_stock') ? SETTINGS.discountOut : SETTINGS.discountIn}% of Tatanka)</div>
        </div>
      </div>
    </div>`;
  }).join('') + `<div onclick="selectTatankaRef(-1)" id="tatankaOptNone"
      style="border:2px solid var(--border);border-radius:var(--radius);padding:10px;cursor:pointer;text-align:center;font-size:13px;color:var(--muted)">
    ‚úï None of these ‚Äî I'll set price manually
  </div>`;
  if (items.length === 1) selectTatankaRef(0);
}

function selectTatankaRef(index) {
  document.querySelectorAll('[id^="tatankaOpt"]').forEach(el => { el.style.borderColor = 'var(--border)'; });
  if (index === -1) {
    selectedTatankaRef = null;
    document.getElementById('tatankaSelectedRef').style.display = 'none';
    document.getElementById('priceShortcuts').innerHTML = '';
    document.getElementById('confirmPrice').value = '';
    const el = document.getElementById('tatankaOptNone');
    if (el) el.style.borderColor = 'var(--accent)';
    return;
  }
  const items = selectedGuess?.tatanka || [];
  const t = items[index];
  if (!t) return;
  selectedTatankaRef = t;
  const el = document.getElementById('tatankaOpt' + index);
  if (el) el.style.borderColor = 'var(--accent)';
  const eur = sekToEur(t.price_sek);
  const discountIn  = eur ? Math.round(eur * SETTINGS.discountIn  / 100 * 100) / 100 : null;
  const discountOut = eur ? Math.round(eur * SETTINGS.discountOut / 100 * 100) / 100 : null;
  const suggested   = (t.stock === 'temp_finished' || t.stock === 'out_of_stock') ? discountOut : discountIn;
  if (suggested) document.getElementById('confirmPrice').value = suggested.toFixed(2);
  const refEl = document.getElementById('tatankaSelectedRef');
  refEl.style.display = 'block';
  refEl.innerHTML = `<div style="background:var(--surface2);border:1px solid var(--border2);border-left:3px solid var(--accent);border-radius:var(--radius);padding:10px;font-size:12px">
    <div style="font-family:'IBM Plex Mono',monospace;font-size:9px;color:var(--muted);margin-bottom:4px">TATANKA REFERENCE</div>
    <div style="font-weight:600;margin-bottom:4px">${t.name}</div>
    <div style="display:flex;gap:12px"><div>Tatanka: <b>${eur ? formatEur(eur) : '‚Äî'}</b></div><div>Your cut: <b style="color:var(--green)">${suggested ? formatEur(suggested) : '‚Äî'}</b></div></div>
  </div>`;
  const shortcuts = document.getElementById('priceShortcuts');
  const btns = [];
  if (discountIn)  btns.push(`<button onclick="document.getElementById('confirmPrice').value='${discountIn.toFixed(2)}'" style="padding:5px 10px;font-family:'IBM Plex Mono',monospace;font-size:11px;background:var(--surface2);border:1px solid var(--border2);border-radius:5px;color:var(--text);cursor:pointer">${SETTINGS.discountIn}% ‚Üí ${formatEur(discountIn)}</button>`);
  if (discountOut) btns.push(`<button onclick="document.getElementById('confirmPrice').value='${discountOut.toFixed(2)}'" style="padding:5px 10px;font-family:'IBM Plex Mono',monospace;font-size:11px;background:var(--surface2);border:1px solid var(--border2);border-radius:5px;color:var(--text);cursor:pointer">${SETTINGS.discountOut}% ‚Üí ${formatEur(discountOut)}</button>`);
  if (eur)         btns.push(`<button onclick="document.getElementById('confirmPrice').value='${eur.toFixed(2)}'" style="padding:5px 10px;font-family:'IBM Plex Mono',monospace;font-size:11px;background:var(--surface2);border:1px solid var(--border2);border-radius:5px;color:var(--text);cursor:pointer">Full ‚Üí ${formatEur(eur)}</button>`);
  shortcuts.innerHTML = btns.join('');
}

function setCondition(val, el) {
  currentCondition = val;
  document.querySelectorAll('.cond-btn').forEach(b => b.className = 'cond-btn');
  el.classList.add('active-' + val);
}

function showStep(n) {
  for (let i = 1; i <= 4; i++) {
    const el = document.getElementById('identStep' + i);
    if (el) el.style.display = i === n ? 'block' : 'none';
    const step = document.getElementById('step' + i);
    if (step) {
      step.className = 'step' + (i < n ? ' done' : i === n ? ' active' : '');
    }
  }
  document.querySelector('.main').scrollTop = 0;
}

function backToGuesses() { showStep(2); }

async function savePart() {
  const box   = document.getElementById('manualBox').value.trim();
  const qty   = parseInt(document.getElementById('manualQty').value) || 1;
  const price = parseFloat(document.getElementById('confirmPrice').value) || 0;
  const notes = document.getElementById('manualNotes').value.trim();

  if (!box)   { showToast('Box number is required', 'error'); return; }
  if (!price) { showToast('Asking price is required', 'error'); return; }

  // Merge manual fields into selectedGuess
  const g = selectedGuess || {};
  const manualName = document.getElementById('manualName').value.trim();
  const manualNo   = document.getElementById('manualPartNo').value.trim();
  const manualSv   = document.getElementById('manualNameSv').value.trim();
  g.name = manualName || g.name || 'Unknown';
  g.no   = manualNo   || g.no   || '';
  g.sv   = manualSv   || g.sv   || '';
  if (entryMode === 'custom') {
    g.isCustom = true;
    g.brand    = document.getElementById('customBrand').value.trim();
    g.sourceUrl= document.getElementById('customSourceUrl').value.trim();
  }

  // Save photo
  let photoPath = null;
  if (currentPhotoBlob) {
    const photoId = 'inv_' + Date.now();
    const reader = new FileReader();
    photoPath = await new Promise(resolve => {
      reader.onload = e => resolve(e.target.result);
      reader.readAsDataURL(currentPhotoBlob);
    });
  }

  // Check for existing same part in same box
  const existing = INVENTORY.find(i =>
    i.partNo === g.no && i.box === box && i.status !== 'sold'
  );

  const newItem = {
    id: Date.now(),
    partNo: g.no || '',
    name: g.name || '',
    nameSv: g.sv || '',
    group: g.group || '',
    box: box,
    qty: qty,
    condition: currentCondition,
    askingPrice: price,
    notes: notes,
    photo: photoPath,
    status: 'available',
    addedDate: new Date().toISOString(),
    isCustom: g.isCustom || false,
    isUnknown: false,
    brand: g.brand || null,
    sourceUrl: g.sourceUrl || null,
    tatankaRef: (typeof selectedTatankaRef !== 'undefined' && selectedTatankaRef)
      ? { name: selectedTatankaRef.name, price_sek: selectedTatankaRef.price_sek, product_url: selectedTatankaRef.product_url }
      : null,
  };

  let duplicateMsg = '';
  if (existing) {
    existing.qty += qty;
    duplicateMsg = `Added ${qty} to existing entry in Box ${box}. Total: ${existing.qty} pcs.`;
    saveInventory();
  } else {
    INVENTORY.push(newItem);
    saveInventory();
  }

  showStep(4);
  document.getElementById('savedPartSummary').innerHTML =
    `<b>${g.name}</b><br>${g.no || ''} \u00b7 Box ${box} \u00b7 \u00d7${qty}<br><span style="color:var(--green)">${formatEur(price)}</span>`;

  const dupWarn = document.getElementById('duplicateWarning');
  if (duplicateMsg) {
    dupWarn.style.display = 'block';
    dupWarn.innerHTML = '\u26a0\ufe0f ' + duplicateMsg;
  } else {
    dupWarn.style.display = 'none';
  }

  showToast('Part saved!', 'success');
}

function resetIdentify() {
  currentPhoto = null; currentPhotoBlob = null;
  currentGuesses = []; selectedGuess = null; currentCondition = null;
  const area = document.getElementById('photoArea');
  area.classList.remove('has-photo');
  area.innerHTML = `<div class="photo-placeholder"><div class="photo-icon">\ud83d\udcf7</div><div class="photo-label">TAP TO TAKE PHOTO</div><div class="photo-sublabel">or choose from gallery</div></div>`;
  area.onclick = () => document.getElementById('cameraInput').click();
  document.getElementById('analyzeBtn').disabled = true;
  document.getElementById('groupFilter').value = '';
  document.getElementById('manualBox').value = '';
  document.getElementById('manualQty').value = '1';
  document.getElementById('manualNotes').value = '';
  document.getElementById('manualName').value = '';
  document.getElementById('manualPartNo').value = '';
  document.getElementById('manualNameSv').value = '';
  if (document.getElementById('smartSearch')) document.getElementById('smartSearch').value = '';
  if (document.getElementById('selectedPartPreview')) document.getElementById('selectedPartPreview').style.display = 'none';
  if (document.getElementById('smartSearchResults')) document.getElementById('smartSearchResults').style.display = 'none';
  if (document.getElementById('boxSuggestion')) document.getElementById('boxSuggestion').style.display = 'none';
  if (document.getElementById('customName')) document.getElementById('customName').value = '';
  if (document.getElementById('customBrand')) document.getElementById('customBrand').value = '';
  if (document.getElementById('customSourceUrl')) document.getElementById('customSourceUrl').value = '';
  partSelected = false;
  setEntryMode('catalogue');
  const cp = document.getElementById('confirmPrice'); if (cp) cp.value = '';
  const cn = document.getElementById('confirmNotes'); if (cn) cn.value = '';
  document.querySelectorAll('.cond-btn').forEach(b => b.className = 'cond-btn');
  showScreen('identify');
  showStep(1);
}

function setInvFilter(f, el) {
  invFilter = f;
  document.querySelectorAll('#invFilterChips .chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  filterInventory();
}

function filterInventory() {
  invSearch = document.getElementById('invSearch').value.toLowerCase();
  renderInventory();
}

function renderInventory() {
  const list = document.getElementById('invList');
  if (!list) return;

  let items = [...INVENTORY];

  // Apply filter
  if (invFilter === 'available') items = items.filter(i => i.status === 'available' && !i.isUnknown);
  else if (invFilter === 'listed') items = items.filter(i => i.status === 'listed');
  else if (invFilter === 'unknown') items = items.filter(i => i.isUnknown);
  else if (invFilter === 'sold') items = items.filter(i => i.status === 'sold');
  else items = items.filter(i => i.status !== 'sold');

  // Apply search
  if (invSearch) {
    items = items.filter(i =>
      (i.name||'').toLowerCase().includes(invSearch) ||
      (i.partNo||'').toLowerCase().includes(invSearch) ||
      (i.box||'').toLowerCase().includes(invSearch) ||
      (i.notes||'').toLowerCase().includes(invSearch)
    );
  }

  if (items.length === 0) {
    list.innerHTML = `<div class="empty">
      <div class="empty-icon">${invFilter === 'unknown' ? '\u2753' : '\ud83d\udce6'}</div>
      <div class="empty-title">${invFilter === 'unknown' ? 'NO UNKNOWN PARTS' : 'NO PARTS'}</div>
      <div class="empty-text">${invFilter === 'all' ? 'Start by identifying and adding parts.' : 'Nothing matches your filter.'}</div>
    </div>`;
    return;
  }

  list.innerHTML = items.map(item => renderInvItem(item)).join('');
}

function renderInvItem(item) {
  const tatankaItems = item.partNo ? getTatankaData(item.partNo) : [];
  const bestT = tatankaItems.find(t=>!t.is_used) || tatankaItems[0];
  const tatankaEur = bestT ? sekToEur(bestT.price_sek) : null;

  const myDefaultPhoto = getDefaultPartPhoto(item.partNo);
  const diagData = item.partNo ? getDiagramData(item.partNo) : null;
  const safePN = (item.partNo||'').replace(/'/g,"\\'");
  const safeName = (item.name||'Part').replace(/'/g,"\\'");
  const thumbClick = `onclick="openPartViewer('${safePN}','${safeName}')" style="cursor:pointer"`;
  const thumb = myDefaultPhoto
    ? `<img class="inv-thumb" src="${myDefaultPhoto}" alt="" ${thumbClick}>` :
    (bestT?.image_local ? `<img class="inv-thumb" src="${bestT.image_local}" alt="" ${thumbClick}>` :
    (diagData ? `<img class="inv-thumb" src="${getDiagramPageURL(diagData.group, diagData.diagramPage)}" alt="" ${thumbClick}>` :
    `<div class="inv-thumb-ph" ${thumbClick}>${item.isUnknown ? '‚ùì' : 'üîß'}</div>`));

  const cls = item.isUnknown ? 'unknown-item' : 'inv-item';

  return `<div class="${cls}" id="invitem${item.id}">
    <div class="inv-item-header">
      ${thumb}
      <div class="inv-info">
        <div class="inv-name">${item.name || 'Unknown Part'}</div>
        <div class="inv-no">${item.partNo || ''}</div>
        <div class="inv-meta">
          <span class="badge badge-muted">\ud83d\udce6 Box ${item.box || '\u2014'}</span>
          <span class="badge badge-muted">\u00d7${item.qty || 1}</span>
          ${getConditionBadge(item.condition)}
          ${getStatusBadge(item.status)}
        </div>
        <div class="inv-price-row">
          <span class="inv-asking">${formatEur(item.askingPrice)}</span>
          ${tatankaEur ? `<span class="inv-ref">Tatanka: ${formatEur(tatankaEur)}</span>` : ''}
        </div>
      </div>
    </div>
    <div class="inv-actions">
      ${item.status !== 'sold' ? `
        ${item.status === 'available' ? `<button class="btn btn-secondary btn-xs" onclick="setItemStatus(${item.id},'listed')">\ud83d\udce2 MARK LISTED</button>` : ''}
        ${item.status === 'listed' ? `<button class="btn btn-success btn-xs" onclick="confirmSold(${item.id})">\ud83d\udcb0 SOLD</button>` : ''}
        ${item.status === 'listed' ? `<button class="btn btn-secondary btn-xs" onclick="setItemStatus(${item.id},'available')">\u21a9 UNLIST</button>` : ''}
        <button class="btn btn-secondary btn-xs" onclick="editItem(${item.id})">\u270f\ufe0f EDIT</button>
        <button class="btn btn-secondary btn-xs" onclick="showQRForItem(${item.id})">\ud83c\udff7\ufe0f LABEL</button>
      ` : `<span style="font-size:12px;color:var(--muted)">Sold on ${item.soldDate ? new Date(item.soldDate).toLocaleDateString() : '\u2014'}</span>`}
      ${item.isUnknown ? `<button class="btn btn-secondary btn-xs" onclick="retryIdentify(${item.id})">\ud83d\udd0d IDENTIFY</button>` : ''}
      <button class="btn btn-danger btn-xs" onclick="deleteItem(${item.id})">\ud83d\uddd1\ufe0f</button>
    </div>
  </div>`;
}

function setItemStatus(id, status) {
  const item = INVENTORY.find(i => i.id === id);
  if (!item) return;
  item.status = status;
  saveInventory();
  renderInventory();
  showToast('Status updated', 'success');
}

function markSold(id) {
  const item = INVENTORY.find(i => i.id === id);
  if (!item) return;
  item.status = 'sold';
  item.soldDate = new Date().toISOString();
  saveInventory();
  closeModal();
  renderInventory();
  renderSummary();
  showToast('Part marked as sold \u2713', 'success');
}

function confirmSold(id) {
  const item = INVENTORY.find(i => i.id === id);
  if (!item) return;
  openModal('soldConfirm', item);
}

function saveEditItem(id) {
  const item = INVENTORY.find(i => i.id === id);
  if (!item) return;
  item.box = document.getElementById('editBox').value.trim() || item.box;
  item.qty = parseInt(document.getElementById('editQty').value) || item.qty;
  item.askingPrice = parseFloat(document.getElementById('editPrice').value) || item.askingPrice;
  item.notes = document.getElementById('editNotes').value;
  const cond = document.querySelector('.cond-btn.active-good, .cond-btn.active-fair, .cond-btn.active-poor');
  if (cond) item.condition = cond.dataset.cond;
  saveInventory();
  closeModal();
  renderInventory();
  showToast('Updated', 'success');
}

function deleteItem(id) {
  if (!confirm('Delete this part from inventory?')) return;
  INVENTORY = INVENTORY.filter(i => i.id !== id);
  saveInventory();
  renderInventory();
  renderSummary();
  showToast('Deleted');
}

function editItem(id) {
  const item = INVENTORY.find(i => i.id === id);
  if (!item) return;
  openModal('editItem', item);
}

function retryIdentify(id) {
  // Take an unknown part and re-run AI identification on it
  const item = INVENTORY.find(i => i.id === id);
  if (!item) return;
  // Pre-fill the identify screen with existing info and go there
  showScreen('identify');
  showStep(1);
  showToast('Take a new photo to re-identify this part', 'info');
}

function saveSettings() {
  // Alias ‚Äî individual settings are saved via saveSetting(key, val)
  localStorage.setItem('volvo_settings', JSON.stringify(SETTINGS));
  updateSettingsUI();
}

function exportInventoryJSON() {
  const blob = new Blob([JSON.stringify(INVENTORY,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `volvo_inventory_backup_${Date.now()}.json`;
  a.click();
  showToast('Backup saved!', 'success');
}

function importInventoryJSON(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const data = JSON.parse(e.target.result);
      if (Array.isArray(data)) {
        INVENTORY = data;
        saveInventory();
        renderInventory();
        renderSummary();
        showToast('Backup restored!', 'success');
      }
    } catch(err) { showToast('Invalid backup file', 'error'); }
  };
  reader.readAsText(file);
  input.value = '';
}

function setCatFilter(f, el) {
  catFilter = f;
  document.querySelectorAll('#catFilterChips .chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  filterCatalogue();
}

function filterCatalogue() {
  catSearch = document.getElementById('catSearch').value.toLowerCase();
  renderCatalogue();
}

function renderCatalogue() {
  const list = document.getElementById('catList');
  if (!list || !PARTS_DB || PARTS_DB.length === 0) {
    list.innerHTML = `<div class="empty"><div class="empty-icon">üìã</div><div class="empty-title">CATALOGUE NOT LOADED</div><div class="empty-text">Make sure PARTS_DB.js is in the same folder as index.html</div></div>`;
    return;
  }

  if (!catSearch && !catFilter) {
    list.innerHTML = `<div class="empty"><div class="empty-icon">üîç</div><div class="empty-title">SEARCH THE CATALOGUE</div><div class="empty-text">Type a part name, number, or Swedish term above</div></div>`;
    return;
  }

  let items = PARTS_DB;
  if (catFilter) items = items.filter(p => p.g === catFilter);

  if (catSearch) {
    // Use synonym-aware scoring when search engine is available
    if (typeof expandSearchTerms === "function") {
      const terms = expandSearchTerms(catSearch);
      const scored = items
        .map(p => ({ p, score: searchScore(p, terms) }))
        .filter(x => x.score > 0)
        .sort((a, b) => b.score - a.score);
      items = scored.map(x => x.p);
    } else {
      // Fallback: simple includes
      items = items.filter(p =>
        (p.name||'').toLowerCase().includes(catSearch) ||
        (p.no||'').toLowerCase().includes(catSearch) ||
        (p.sv||'').toLowerCase().includes(catSearch)
      );
    }
  }

  const shown = items.slice(0, 100);
  if (shown.length === 0) {
    list.innerHTML = `<div class="empty"><div class="empty-icon">üîç</div><div class="empty-title">NO RESULTS</div><div class="empty-text">Try different words ‚Äî synonyms are supported (e.g. "bearing" finds lager)</div></div>`;
    return;
  }

  list.innerHTML = (items.length > 100 ? `<div class="section-header">Showing 100 of ${items.length} results ‚Äî refine your search</div>` : '') +
    shown.map(p => {
      const tatankaItems = getTatankaData(p.no);
      const bestT = tatankaItems.find(t=>!t.is_used) || tatankaItems[0];
      const eur = bestT ? sekToEur(bestT.price_sek) : null;
      const thumb = bestT?.image_local
        ? `<img style="width:40px;height:40px;border-radius:5px;object-fit:cover;border:1px solid var(--border);flex-shrink:0" src="${bestT.image_local}" alt="">`
        : `<div style="width:40px;height:40px;border-radius:5px;background:var(--surface3);border:1px solid var(--border);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:18px">üîß</div>`;
      return `<div class="cat-item" onclick="openCatDetail('${p.no.replace(/'/g,"\\'")}')">`+
        thumb +
        `<div class="cat-item-info"><div class="cat-item-name">${p.name}</div><div class="cat-item-no">${p.no} ¬∑ ${p.sv||''}</div></div>` +
        `<div class="cat-item-price">${eur ? formatEur(eur) : ''}</div></div>`;
    }).join('');
}

function openCatDetail(partNo) {
  const part = (typeof PARTS_DB !== 'undefined') ? PARTS_DB.find(p => p.no === partNo) : null;
  if (!part) return;
  openModal('catDetail', part);
}

function addFromCatalogue(partNo) {
  const part = (typeof PARTS_DB !== 'undefined') ? PARTS_DB.find(p => p.no === partNo) : null;
  if (!part) return;
  // Apply to step 1 fields and switch to identify screen
  applyPartFromDB(part.no, part.name, part.sv || '', part.g || '');
  showScreen('identify');
  closeModal();
  // Go straight to step 3 (PRICE) since part is already known from catalogue
  const tatankaItems = getTatankaData(partNo);
  selectedGuess = { name: part.name, sv: part.sv||'', no: part.no, group: part.g||'',
    confidence: 100, tatanka: tatankaItems, fromManual: true };
  showConfirmStep();
  showStep(3);
}

function filterByBox(box) {
  showScreen('inventory');
  document.getElementById('invSearch').value = box;
  invSearch = box.toLowerCase();
  invFilter = 'all';
  document.querySelectorAll('#invFilterChips .chip').forEach(c => c.classList.remove('active'));
  document.querySelector('#invFilterChips .chip').classList.add('active');
  renderInventory();
}

function renderSummary() {
  const statsEl = document.getElementById('summaryStats');
  const valsEl = document.getElementById('summaryValues');
  const boxEl = document.getElementById('boxSummary');
  if (!statsEl) return;

  const active = INVENTORY.filter(i => i.status !== 'sold' && !i.isUnknown);
  const listed = INVENTORY.filter(i => i.status === 'listed');
  const sold = INVENTORY.filter(i => i.status === 'sold');
  const unknown = INVENTORY.filter(i => i.isUnknown);
  const boxes = new Set(active.map(i => i.box).filter(Boolean));

  statsEl.innerHTML = `
    <div class="stat-box"><div class="stat-val">${active.length}</div><div class="stat-label">PARTS</div></div>
    <div class="stat-box"><div class="stat-val">${boxes.size}</div><div class="stat-label">BOXES</div></div>
    <div class="stat-box"><div class="stat-val">${listed.length}</div><div class="stat-label">LISTED</div></div>
    <div class="stat-box"><div class="stat-val">${sold.length}</div><div class="stat-label">SOLD</div></div>
    <div class="stat-box"><div class="stat-val">${unknown.length}</div><div class="stat-label">UNKNOWN</div></div>
    <div class="stat-box"><div class="stat-val">${active.reduce((s,i)=>s+i.qty,0)}</div><div class="stat-label">TOTAL QTY</div></div>`;

  // Value calculations
  const myTotal = active.reduce((s,i) => s + (i.askingPrice * i.qty), 0);
  const soldTotal = sold.reduce((s,i) => s + (i.askingPrice * i.qty), 0);
  const tatankaTotal = active.reduce((s,i) => {
    const t = getTatankaData(i.partNo);
    const best = t.find(x=>!x.is_used) || t[0];
    return s + (best ? (sekToEur(best.price_sek)||0) * i.qty : 0);
  }, 0);

  valsEl.innerHTML = `
    <div style="margin-top:4px">
      <div class="settings-row">
        <div><div class="settings-label">My Asking Prices Total</div></div>
        <div style="font-family:'IBM Plex Mono',monospace;font-size:13px;color:var(--green);font-weight:600">${formatEur(Math.round(myTotal*100)/100)}</div>
      </div>
      <div class="settings-row">
        <div><div class="settings-label">Tatanka Reference Total</div></div>
        <div style="font-family:'IBM Plex Mono',monospace;font-size:13px;color:var(--accent)">${formatEur(Math.round(tatankaTotal*100)/100)}</div>
      </div>
      <div class="settings-row">
        <div><div class="settings-label">Revenue from Sales</div></div>
        <div style="font-family:'IBM Plex Mono',monospace;font-size:13px;color:var(--blue)">${formatEur(Math.round(soldTotal*100)/100)}</div>
      </div>
    </div>`;

  // Box summary
  const byBox = {};
  active.forEach(i => {
    const b = i.box || 'No Box';
    if (!byBox[b]) byBox[b] = [];
    byBox[b].push(i);
  });
  const sortedBoxes = Object.keys(byBox).sort((a,b) => {
    const na = parseInt(a), nb = parseInt(b);
    if (!isNaN(na) && !isNaN(nb)) return na - nb;
    return a.localeCompare(b);
  });

  if (sortedBoxes.length === 0) {
    boxEl.innerHTML = '<div style="color:var(--muted);font-size:13px">No parts with box numbers yet.</div>';
  } else {
    boxEl.innerHTML = sortedBoxes.map(box => {
      const parts = byBox[box];
      const total = parts.reduce((s,p) => s + (p.askingPrice * p.qty), 0);
      return `<div class="box-card" onclick="filterByBox('${box}')">
        <div class="box-title">\ud83d\udce6 BOX ${box}</div>
        <div class="box-parts">${parts.map(p => `${p.name} \u00d7${p.qty}`).slice(0,5).join(' \u00b7 ')}${parts.length > 5 ? ` \u00b7 +${parts.length-5} more` : ''}</div>
        <div style="margin-top:6px;font-family:'IBM Plex Mono',monospace;font-size:11px;color:var(--green)">${formatEur(Math.round(total*100)/100)} \u00b7 ${parts.length} part types</div>
      </div>`;
    }).join('');
  }
}

function openModal(type, data) {
  const body = document.getElementById('modalBody');
  let html = '';

  if (type === 'catDetail') {
    const p = data;
    const tatankaItems = getTatankaData(p.no);
    html = `<button class="modal-close" onclick="closeModal()">\u2715</button>
      <div class="modal-title">${p.name}</div>
      <div style="font-family:'IBM Plex Mono',monospace;font-size:12px;color:var(--accent);margin-bottom:4px">${p.no}</div>
      <div style="font-size:13px;color:var(--text2);margin-bottom:12px">${p.sv} \u00b7 Group ${p.g}</div>
      ${buildTatankaPanel(tatankaItems, p.no)}
      <div style="margin-top:14px">
        <button class="btn btn-primary btn-full" onclick="addFromCatalogue('${p.no.replace(/'/g,"\\\'")}');closeModal()">+ ADD TO INVENTORY</button>
      </div>`;
  }

  else if (type === 'unknownForm') {
    html = `<button class="modal-close" onclick="closeModal()">\u2715</button>
      <div class="modal-title">\u2753 ADD UNKNOWN PART</div>
      <div class="fg"><label>Description (optional)</label><input type="text" id="unknownName" placeholder="What do you think it might be?"></div>
      <div class="row2">
        <div class="fg"><label>Box <span class="req">*</span></label><input type="text" id="unknownBox" placeholder="Box number"></div>
        <div class="fg"><label>Qty</label><input type="number" id="unknownQty" value="1" min="1"></div>
      </div>
      <button class="btn btn-primary btn-full" onclick="saveUnknownPart()">SAVE TO UNKNOWN PILE</button>`;
  }

  else if (type === 'soldConfirm') {
    const item = data;
    html = `<button class="modal-close" onclick="closeModal()">\u2715</button>
      <div class="modal-title">\ud83d\udcb0 CONFIRM SOLD</div>
      <div style="font-size:14px;margin-bottom:16px">Mark <b>${item.name}</b> as sold?<br>This will remove it from your active inventory.</div>
      <div style="background:rgba(82,199,122,0.1);border:1px solid var(--green);border-radius:var(--radius);padding:12px;margin-bottom:16px;text-align:center">
        <div style="font-family:'IBM Plex Mono',monospace;font-size:20px;color:var(--green)">${formatEur(item.askingPrice * item.qty)}</div>
        <div style="font-size:12px;color:var(--text2)">\u00d7${item.qty} @ ${formatEur(item.askingPrice)} each</div>
      </div>
      <div class="btn-group">
        <button class="btn btn-secondary" style="flex:1" onclick="closeModal()">Cancel</button>
        <button class="btn btn-success" style="flex:1" onclick="markSold(${item.id})">\u2713 CONFIRM SOLD</button>
      </div>`;
  }

  else if (type === 'editItem') {
    const item = data;
    html = `<button class="modal-close" onclick="closeModal()">\u2715</button>
      <div class="modal-title">\u270f\ufe0f EDIT PART</div>
      <div style="font-size:14px;font-weight:600;margin-bottom:12px">${item.name}</div>
      <div class="row2">
        <div class="fg"><label>Box</label><input type="text" id="editBox" value="${item.box||''}"></div>
        <div class="fg"><label>Qty</label><input type="number" id="editQty" value="${item.qty||1}" min="1"></div>
      </div>
      <div class="fg"><label>Asking Price (EUR)</label><input type="number" id="editPrice" value="${item.askingPrice||0}" step="0.01"></div>
      <div class="fg">
        <label>Condition</label>
        <div class="condition-btns">
          <button class="cond-btn${item.condition==='good'?' active-good':''}" data-cond="good" onclick="setCondition('good',this)">\u2705 Good</button>
          <button class="cond-btn${item.condition==='fair'?' active-fair':''}" data-cond="fair" onclick="setCondition('fair',this)">\u26a0\ufe0f Fair</button>
          <button class="cond-btn${item.condition==='poor'?' active-poor':''}" data-cond="poor" onclick="setCondition('poor',this)">\u274c Poor</button>
        </div>
      </div>
      <div class="fg"><label>Notes</label><textarea id="editNotes">${item.notes||''}</textarea></div>
      <button class="btn btn-primary btn-full" onclick="saveEditItem(${item.id})">SAVE CHANGES</button>`;
  }

  else if (type === 'customPart') {
    html = `<button class="modal-close" onclick="closeModal()">\u2715</button>
      <div class="modal-title">\u2795 ADD CUSTOM PART</div>
      <div class="fg"><label>Part Name <span class="req">*</span></label><input type="text" id="customName" placeholder="e.g. Electronic ignition kit"></div>
      <div class="fg">
        <label>Category</label>
        <select id="customCategory">
          <option value="upgrade">Upgrades & Aftermarket</option>
          <option value="tool">Tools & Equipment</option>
          <option value="consumable">Consumables</option>
          <option value="other">General / Other</option>
        </select>
      </div>
      <div class="fg">
        <label>Source URL (optional)</label>
        <div style="display:flex;gap:8px">
          <input type="url" id="customUrl" placeholder="https://..." style="flex:1">
          <button class="btn btn-secondary btn-sm" id="fetchPriceBtn" onclick="fetchSourcePrice()">\ud83d\udd0d Fetch Price</button>
        </div>
      </div>
      <div class="row2">
        <div class="fg"><label>Source Price (EUR)</label><input type="number" id="customSourcePrice" placeholder="0.00" step="0.01"></div>
        <div class="fg"><label>My Asking Price (EUR)</label><input type="number" id="customPrice" placeholder="0.00" step="0.01"></div>
      </div>
      <div class="row2">
        <div class="fg"><label>Box <span class="req">*</span></label><input type="text" id="customBox" placeholder="Box number"></div>
        <div class="fg"><label>Qty</label><input type="number" id="customQty" value="1" min="1"></div>
      </div>
      <div class="fg">
        <label>Photo (optional)</label>
        <div class="photo-area" style="padding:16px" onclick="document.getElementById('customPhotoInput').click()">
          <div class="photo-placeholder"><div class="photo-icon" style="font-size:28px">\ud83d\udcf7</div><div class="photo-label">Add photo</div></div>
        </div>
        <input type="file" id="customPhotoInput" accept="image/*">
      </div>
      <div class="fg"><label>Notes</label><textarea id="customNotes" placeholder="Optional notes..."></textarea></div>
      <button class="btn btn-primary btn-full" onclick="saveCustomPart()">SAVE CUSTOM PART</button>`;
  }

  else if (type === 'qrLabelItem') {
    const item = data;
    const qrData = `VOLVO-C3|${item.partNo}|${item.name}|BOX:${item.box}|QTY:${item.qty}`;
    html = `<button class="modal-close" onclick="closeModal()">\u2715</button>
      <div class="modal-title">\ud83c\udff7\ufe0f QR LABEL</div>
      <div class="label-preview">
        <div class="lp-name">${item.name}</div>
        <div class="lp-no">${item.partNo}</div>
        <div class="lp-detail">Box ${item.box} \u00b7 \u00d7${item.qty} \u00b7 ${item.condition||'\u2014'} \u00b7 ${formatEur(item.askingPrice)}</div>
        <div class="lp-qr">${generateQRSVG(qrData, 120)}</div>
      </div>
      <div style="margin-top:14px;text-align:center;color:var(--muted);font-size:12px">Use your Niimbot app to print this label.<br>Screenshot and import into Niimbot, or connect via Bluetooth.</div>
      <button class="btn btn-secondary btn-full" style="margin-top:12px" onclick="printLabel()">\ud83d\udda8\ufe0f PRINT / SAVE LABEL</button>`;
  }

  else if (type === 'qrLabel') {
    html = `<button class="modal-close" onclick="closeModal()">\u2715</button>
      <div class="modal-title">\ud83c\udff7\ufe0f PRINT QR LABELS</div>
      <div style="font-size:13px;color:var(--text2);margin-bottom:14px">Select what to print labels for:</div>
      <div class="btn-group" style="flex-direction:column">
        <button class="btn btn-secondary" onclick="printAllBoxLabels()">\ud83d\udce6 All Box Labels</button>
        <button class="btn btn-secondary" onclick="printAllPartLabels()">\ud83d\udd27 All Part Labels</button>
        <button class="btn btn-secondary" onclick="printListedLabels()">\ud83d\udce2 Listed Parts Only</button>
      </div>`;
  }

  body.innerHTML = html;
  document.getElementById('modalOverlay').classList.add('open');
}

function closeModal(e) {
  if (e && e.target !== document.getElementById('modalOverlay')) return;
  document.getElementById('modalOverlay').classList.remove('open');
}

function refreshItemPrice() { console.warn("refreshItemPrice not implemented"); }

function applyRefreshedPrice() { console.warn("applyRefreshedPrice not implemented"); }

async function fetchSourcePrice() {
  const url = document.getElementById('customUrl').value.trim();
  if (!url) { showToast('Enter URL first', 'error'); return; }

  const btn = document.getElementById('fetchPriceBtn');
  btn.textContent = '\u23f3 Fetching...';
  btn.disabled = true;

  try {
    const apiKey = getApiKey();
    if (!apiKey) { btn.textContent = '\ud83d\udd0d Fetch Price'; btn.disabled = false; return; }

    const response = await fetch(ANTHROPIC_API, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-opus-4-6',
        max_tokens: 200,
        tools: [{ type: 'web_search_20250305', name: 'web_search' }],
        messages: [{
          role: 'user',
          content: `Visit this URL and extract the product name and price in EUR: ${url}\
\
Return ONLY JSON: {"name":"product name","price":99.99,"currency":"EUR"}`
        }]
      })
    });

    const data = await response.json();
    const text = (data.content||[]).map(b=>b.text||'').join('').replace(/```json|```/g,'').trim();
    const m = text.match(/\\{.*\\}/s);
    if (m) {
      const parsed = JSON.parse(m[0]);
      if (parsed.price) {
        document.getElementById('customSourcePrice').value = parsed.price;
        if (parsed.name && !document.getElementById('customName').value) {
          document.getElementById('customName').value = parsed.name;
        }
        // Auto-fill asking price
        const suggested = Math.round(parsed.price * (SETTINGS.discountIn/100) * 100) / 100;
        document.getElementById('customPrice').value = suggested;
        showToast('Price fetched: ' + parsed.price + ' EUR', 'success');
      }
    }
  } catch(e) {
    showToast('Could not fetch price \u2014 enter manually', 'error');
  }

  btn.textContent = '\ud83d\udd0d Fetch Price';
  btn.disabled = false;
}

async function saveCustomPart() {
  const name = document.getElementById('customName').value.trim();
  const category = document.getElementById('customCategory').value;
  const sourceUrl = document.getElementById('customUrl').value.trim();
  const box = document.getElementById('customBox').value.trim();
  const qty = parseInt(document.getElementById('customQty').value) || 1;
  const notes = document.getElementById('customNotes').value.trim();

  if (!name) { showToast('Part name required', 'error'); return; }
  if (!box) { showToast('Box number required', 'error'); return; }

  let price = parseFloat(document.getElementById('customPrice').value) || 0;
  let sourcePrice = parseFloat(document.getElementById('customSourcePrice').value) || 0;
  if (!price && sourcePrice) {
    price = Math.round(sourcePrice * (SETTINGS.discountIn / 100) * 100) / 100;
  }

  let photoPath = null;
  const photoInput = document.getElementById('customPhotoInput');
  if (photoInput.files[0]) {
    const comp = await compressImage(photoInput.files[0], 800, 0.8);
    photoPath = comp.dataUrl;
  }

  const customId = 'CUSTOM-' + String(INVENTORY.filter(i=>i.isCustom).length + 1).padStart(4,'0');

  const item = {
    id: Date.now(),
    partNo: customId,
    name: name,
    group: category,
    box: box, qty: qty,
    askingPrice: price,
    sourcePrice: sourcePrice,
    sourceUrl: sourceUrl,
    notes: notes,
    photo: photoPath,
    status: 'available',
    isCustom: true,
    isUnknown: false,
    addedDate: new Date().toISOString(),
  };

  INVENTORY.push(item);
  saveInventory();
  closeModal();
  renderInventory();
  renderSummary();
  showToast('Custom part added!', 'success');
}

function exportCatalogue(mode) {
  const active = INVENTORY.filter(i => i.status !== 'sold' && !i.isUnknown && i.askingPrice > 0);
  if (active.length === 0) { showToast('No parts to export', 'error'); return; }

  const date = new Date().toLocaleDateString('en-GB');
  const totalEur = active.reduce((s,i) => s + i.askingPrice * i.qty, 0);

  let html = `<!DOCTYPE html><html><head><meta charset="UTF-8">
  <title>Volvo C3 Parts - Sales Catalogue</title>
  <style>
    body{font-family:Arial,sans-serif;max-width:900px;margin:0 auto;padding:20px;color:#333}
    h1{color:#c97b2e;border-bottom:3px solid #c97b2e;padding-bottom:10px}
    .meta{color:#666;font-size:14px;margin-bottom:20px}
    table{width:100%;border-collapse:collapse;margin-bottom:20px}
    th{background:#1a1a1a;color:#e8b84b;padding:10px;text-align:left;font-size:12px}
    td{padding:9px 10px;border-bottom:1px solid #eee;font-size:13px}
    tr:nth-child(even)td{background:#f9f9f9}
    .part-card{border:1px solid #ddd;border-radius:8px;padding:14px;margin-bottom:12px;page-break-inside:avoid}
    .part-no{font-family:monospace;color:#c97b2e;font-size:12px}
    .part-name{font-size:16px;font-weight:bold;margin:4px 0}
    .part-price{color:#27ae60;font-size:18px;font-weight:bold}
    .part-meta{font-size:12px;color:#666;margin-top:4px}
    .total{background:#1a1a1a;color:#e8b84b;padding:12px 16px;border-radius:6px;font-size:16px;font-weight:bold;text-align:right}
    @media print{.no-print{display:none}}
  </style></head><body>
  <h1>\ud83d\ude99 Volvo C3 Series \u2014 Parts For Sale</h1>
  <div class="meta">Generated: ${date} \u00b7 ${active.length} parts \u00b7 Contact for purchase</div>`;

  if (mode === 'bulk') {
    html += `<table><tr><th>Part No.</th><th>Description</th><th>Box</th><th>Qty</th><th>Condition</th><th>Price (EUR)</th></tr>`;
    active.forEach(i => {
      html += `<tr><td style="font-family:monospace">${i.partNo}</td><td>${i.name}${i.notes?`<br><small style="color:#999">${i.notes}</small>`:''}</td><td>${i.box}</td><td>${i.qty}</td><td>${i.condition||'\u2014'}</td><td style="color:#27ae60;font-weight:600">${formatEur(i.askingPrice)}</td></tr>`;
    });
    html += `</table><div class="total">TOTAL: ${formatEur(Math.round(totalEur*100)/100)}</div>`;
  } else {
    active.forEach(i => {
      const t = getTatankaData(i.partNo);
      const best = t.find(x=>!x.is_used)||t[0];
      html += `<div class="part-card">
        <div class="part-no">${i.partNo}</div>
        <div class="part-name">${i.name}</div>
        <div class="part-price">${formatEur(i.askingPrice)}</div>
        <div class="part-meta">
          Box: ${i.box} \u00b7 Qty: ${i.qty} \u00b7 Condition: ${i.condition||'Not specified'}
          ${best ? ` \u00b7 Tatanka ref: ${best.price_sek ? best.price_sek.toLocaleString()+' SEK' : 'N/A'}` : ''}
          ${i.notes ? `<br>Notes: ${i.notes}` : ''}
        </div>
      </div>`;
    });
    html += `<div class="total">TOTAL VALUE: ${formatEur(Math.round(totalEur*100)/100)}</div>`;
  }

  html += '</body></html>';
  const blob = new Blob([html], {type:'text/html'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `volvo_c3_parts_${mode}_${Date.now()}.html`;
  a.click();
  showToast('Catalogue exported!', 'success');
}

function openWhatsApp() { console.warn("openWhatsApp not implemented"); }

function shareWhatsApp() { console.warn("shareWhatsApp not implemented"); }

function generateQRSVG(text, size) {
  // Simple QR code placeholder \u2014 in production would use a QR library
  // For now generate a data URL that encodes the text
  const encoded = encodeURIComponent(text);
  return `<img src="https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&data=${encoded}" width="${size}" height="${size}" alt="QR">`;
}

function printLabel() {
  window.print();
}

function printAllBoxLabels() {
  const boxes = [...new Set(INVENTORY.filter(i=>i.status!=='sold'&&i.box).map(i=>i.box))];
  showToast('Feature: screenshot each box QR from the box summary', 'success');
  closeModal();
}

function printAllPartLabels() {
  showToast('Generating labels for all parts...', 'success');
  closeModal();
}

function printListedLabels() {
  showToast('Generating labels for listed parts...', 'success');
  closeModal();
}

function showQRForItem(id) {
  const item = INVENTORY.find(i => i.id === id);
  if (item) openModal('qrLabelItem', item);
}

function showQRModal(mode) { openModal('qrLabel', mode); }

function addToBulkQueue() { console.warn("addToBulkQueue not implemented"); }

function removeBulkItem() { console.warn("removeBulkItem not implemented"); }

function renderBulkQueue() { console.warn("renderBulkQueue not implemented"); }

function analyzeBulkQueue() { console.warn("analyzeBulkQueue not implemented"); }

function analyzeSingleBulkItem() { console.warn("analyzeSingleBulkItem not implemented"); }

function renderBulkReview() { console.warn("renderBulkReview not implemented"); }

function saveAllBulk() { console.warn("saveAllBulk not implemented"); }

</script>

<!-- ‚îÄ‚îÄ DIAGRAM VIEWER MODAL ‚îÄ‚îÄ -->
<div class="diagram-modal" id="diagramModal">
  <div class="diagram-modal-header">
    <div>
      <div class="diagram-modal-title" id="dvTitle">Part Name</div>
      <div class="diagram-modal-sub" id="dvSub">Part No</div>
    </div>
    <button class="diagram-modal-close" onclick="closeDiagramViewer()">‚úï</button>
  </div>

  <!-- Tabs -->
  <div class="dv-tabs">
    <button class="dv-tab" id="dvTabMyPhotos" onclick="dvSetTab('myPhotos')">üì∑ MY PHOTOS</button>
    <button class="dv-tab" id="dvTabTatanka" onclick="dvSetTab('tatanka')">üè∑ TATANKA</button>
    <button class="dv-tab" id="dvTabDiagram" onclick="dvSetTab('diagram')">üìê DIAGRAM</button>
  </div>

  <!-- My Photos pane -->
  <div class="dv-pane" id="dvPaneMyPhotos">
    <div class="dv-myphotos-main" id="dvMyPhotoMain">
      <img id="dvMyPhotoImg" src="" alt="Part photo">
      <div class="dv-star-badge" id="dvStarBadge" style="display:none">‚òÖ DEFAULT</div>
      <button class="dv-set-default-btn" id="dvSetDefaultBtn" onclick="dvSetCurrentAsDefault()" style="display:none">Set as default image</button>
    </div>
    <div class="dv-photo-strip" id="dvPhotoStrip"></div>
    <div style="padding:8px 12px;display:flex;gap:8px;background:var(--surface);border-top:1px solid var(--border);flex-shrink:0">
      <button class="btn btn-secondary" style="flex:1;font-size:11px" onclick="dvAddPhoto()">+ ADD PHOTO</button>
    </div>
    <input type="file" id="dvPhotoInput" accept="image/*" capture="environment" style="display:none" onchange="dvHandleNewPhoto(event)">
  </div>

  <!-- Tatanka pane -->
  <div class="dv-pane" id="dvPaneTatanka">
    <div class="dv-tatanka-list" id="dvTatankaList"></div>
  </div>

  <!-- Diagram pane -->
  <div class="dv-pane" id="dvPaneDiagram">
    <div id="dvPosBanner" style="display:none;background:var(--accent);color:#000;font-family:'IBM Plex Mono',monospace;font-size:12px;font-weight:600;padding:8px 14px;text-align:center;letter-spacing:0.5px"></div>
    <div class="dv-diagram-wrap">
      <canvas id="dvDiagramCanvas" class="dv-diagram-canvas"></canvas>
      <div class="dv-zoom-panel" id="dvZoomPanel" style="display:none">
        <div class="dv-zoom-panel-label" id="dvZoomLabel">ZOOM</div>
        <canvas id="dvZoomCanvas"></canvas>
      </div>
    </div>
    <div class="dv-occurrence-strip" id="dvOccurrenceStrip"></div>
  </div>
</div>

<!-- ‚îÄ‚îÄ PHOTO DEFAULT PROMPT ‚îÄ‚îÄ -->
<div class="photo-default-modal" id="photoDefaultModal">
  <div class="photo-default-card">
    <div class="photo-default-title">Set as default image?</div>
    <img class="photo-default-preview" id="photoDefaultPreview" src="" alt="">
    <div class="photo-default-sub" id="photoDefaultExistingLabel"></div>
    <div class="photo-default-btns">
      <button class="btn btn-secondary" onclick="resolvePhotoDefault(false)">Keep existing</button>
      <button class="btn btn-primary" onclick="resolvePhotoDefault(true)">Set as default</button>
    </div>
  </div>
</div>

<!-- External data files ‚Äî must be in same folder as index.html -->
<script src="PARTS_DB.js"></script>
<script src="tatanka_db.js"></script>
<script src="TATANKA_DB.js"></script>

</body>
</html>
